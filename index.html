<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluxionics - Simulador Profesional de Circuitos</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Estilos CSS para el diseño completo de la aplicación. */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #0a0e14; color: #e6edf3; overflow: hidden; line-height: 1.6; }

        /* Estilos de la Pantalla de Inicio */
        .screen-container {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            transition: opacity 0.5s ease-in-out; opacity: 0;
        }
        .screen-container.active { display: flex; opacity: 1; }

        .start-screen {
            flex-direction: column; align-items: center; justify-content: center;
            background: radial-gradient(ellipse at center, #1a1f2e 0%, #0a0e14 100%);
            padding: 40px; text-align: center; position: relative; overflow: hidden;
        }

        .start-screen::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="circuit" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M10,0 L10,5 M10,15 L10,20 M0,10 L5,10 M15,10 L20,10" stroke="%2300d4ff" stroke-width="0.5" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23circuit)"/></svg>') repeat;
            opacity: 0.05; z-index: 0;
        }

        .logo-container { position: relative; z-index: 1; margin-bottom: 50px; }
        .main-logo {
            width: 150px; height: 150px; margin: 0 auto 20px;
            background-image: url('https://imgur.com/pxjxVqC.png'); background-size: contain; background-repeat: no-repeat;
            background-position: center; animation: logoFloat 6s ease-in-out infinite;
            border-radius: 20px; box-shadow: 0 0 30px rgba(0, 212, 255, 0.3);
        }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(3deg); }
        }

        .app-title {
            font-family: 'Orbitron', sans-serif; font-size: 4.5em; font-weight: 900;
            color: #00d4ff; margin-bottom: 10px; text-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
            letter-spacing: 4px; background: linear-gradient(45deg, #00d4ff, #ffffff, #00d4ff);
            background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; animation: textShimmer 3s ease-in-out infinite;
        }

        @keyframes textShimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .app-subtitle { font-size: 1.4em; color: #8b949e; font-weight: 500; margin-bottom: 40px; }
        .start-options { display: flex; gap: 30px; z-index: 1; position: relative; flex-wrap: wrap; justify-content: center; }
        .start-button {
            padding: 18px 35px; border: none; border-radius: 12px; font-size: 1.2em; font-weight: 700;
            cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 12px;
            text-transform: uppercase; letter-spacing: 1px; min-width: 200px; justify-content: center;
        }
        .start-button.primary {
            background: linear-gradient(45deg, #00d4ff, #0088cc); color: #0a0e14;
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3);
        }
        .start-button.primary:hover {
            background: linear-gradient(45deg, #00e6ff, #00a3e6); transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0, 212, 255, 0.4);
        }
        .start-button.secondary {
            background: rgba(22, 27, 34, 0.8); border: 2px solid #30363d; color: #e6edf3;
            backdrop-filter: blur(10px);
        }
        .start-button.secondary:hover {
            background: rgba(33, 38, 45, 0.9); border-color: #00d4ff; color: #00d4ff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        /* Contenedor principal de la aplicación */
        .app-container {
            flex-direction: row;
            background: #0a0e14;
            overflow: hidden;
        }

        /* Contenedor de las Secciones */
        .content-section {
            display: none; height: 100vh; width: 100%;
        }
        .content-section.active { display: block; }
        .content-section h2 {
            font-size: 2.5em; color: #00d4ff; margin-bottom: 20px;
            border-bottom: 2px solid rgba(0, 212, 255, 0.3); padding-bottom: 10px;
        }
        
        .section-content {
            background: rgba(22, 27, 34, 0.9); backdrop-filter: blur(5px);
            padding: 30px; border-radius: 12px; border: 1px solid #30363d;
            max-width: 800px; margin: 50px auto; position: relative;
        }
        .section-content h3 { color: #00d4ff; margin-bottom: 15px; }

        /* Contenedor del simulador y el panel de propiedades */
        .simulator-layout {
            flex: 1; /* Permite que ocupe todo el espacio restante */
            display: flex;
            position: relative;
            height: 100vh;
        }

        /* Simulador */
        .simulator-grid {
            flex: 1; 
            position: relative; 
            overflow: hidden;
            background-color: #0a0e14;
            background-image:
                linear-gradient(to right, rgba(0, 212, 255, 0.05) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(0, 212, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            height: 100vh;
            transform-origin: 0 0;
            cursor: grab;
        }
        .simulator-grid.panning {
            cursor: grabbing;
        }
        .component-menu {
            width: 250px; background: rgba(13, 17, 23, 0.9); backdrop-filter: blur(10px);
            border-right: 1px solid #30363d; padding: 20px; overflow-y: auto;
            display: flex; flex-direction: column;
            z-index: 100;
        }
        .component-menu h3 {
            color: #00d4ff; margin: 20px 0 10px; border-bottom: 1px solid #30363d; padding-bottom: 5px;
        }
        .component-item {
            display: flex; align-items: center; gap: 15px;
            padding: 10px; border: 1px solid #30363d; border-radius: 8px;
            cursor: grab; transition: background 0.2s, box-shadow 0.2s;
            margin-bottom: 10px;
        }
        .component-item:hover {
            background: rgba(0, 212, 255, 0.1); box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }
        .component-icon { font-size: 1.5em; color: #00d4ff; }
        .component-item-name { font-weight: bold; }
        .component-box {
            position: absolute; width: 50px; height: 50px;
            background: #30363d; border: 2px solid #00d4ff; border-radius: 8px;
            display: flex; justify-content: center; align-items: center;
            cursor: move; transition: border-color 0.2s, box-shadow 0.2s;
            user-select: none;
            z-index: 10;
        }
        .component-box.dragging { cursor: grabbing; z-index: 100; }
        .component-box:hover { border-color: #00e6ff; box-shadow: 0 0 15px rgba(0, 212, 255, 0.5); }
        .component-box img { max-width: 100%; max-height: 100%; }
        .component-pin {
            position: absolute; width: 10px; height: 10px; background: #c9d1d9;
            border-radius: 50%; border: 1px solid #30363d; cursor: crosshair;
            z-index: 20;
        }
        .component-pin:hover { background: #00d4ff; }
        .component-pin.selected { background: #ff6b6b; }
        .component-pin.top { top: -5px; left: 50%; transform: translateX(-50%); }
        .component-pin.bottom { bottom: -5px; left: 50%; transform: translateX(-50%); }
        .component-pin.left { left: -5px; top: 50%; transform: translateY(-50%); }
        .component-pin.right { right: -5px; top: 50%; transform: translateY(-50%); }
        .wire {
            position: absolute; height: 2px; background: #e6edf3;
            transform-origin: left center; z-index: 5;
        }
        .simulator-toolbar {
            position: fixed; top: 20px; right: 20px; z-index: 200;
            display: flex; gap: 15px;
        }
        .toolbar-button {
            padding: 10px 20px; background: rgba(0, 212, 255, 0.2); border: 2px solid #00d4ff;
            border-radius: 8px; color: #00d4ff; font-weight: bold; cursor: pointer;
            transition: all 0.3s ease;
        }
        .toolbar-button:hover {
            background: rgba(0, 212, 255, 0.3); box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
        }
        .toolbar-button i { margin-right: 8px; }
        .sim-status-indicator {
            width: 12px; height: 12px; border-radius: 50%;
            background-color: #ff6b6b; margin-left: 8px;
            display: inline-block;
            animation: pulse-red 2s infinite;
        }
        .sim-status-indicator.running {
            background-color: #38c172;
            animation: pulse-green 2s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
        }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(56, 193, 114, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(56, 193, 114, 0); }
            100% { box-shadow: 0 0 0 0 rgba(56, 193, 114, 0); }
        }

        /* Cal Flux */
        #calfluxSection .section-content { max-width: 1000px; }
        .calflux-section { display: flex; flex-direction: column; gap: 30px; }
        .calflux-calculator {
            padding: 20px; border: 1px solid #30363d; border-radius: 12px;
            background: rgba(22, 27, 34, 0.8);
        }
        .form-group { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .form-group label { min-width: 120px; }
        .form-group input {
            flex: 1; background: #161b22; color: #e6edf3; border: 1px solid #30363d;
            padding: 10px; border-radius: 8px; font-size: 1em;
        }
        .form-group select {
            background: #161b22; color: #e6edf3; border: 1px solid #30363d;
            padding: 10px; border-radius: 8px;
        }
        .result-container {
            margin-top: 20px; padding: 15px; background: #161b22;
            border: 1px solid #30363d; border-radius: 8px;
            min-height: 50px;
        }
        .result-container p { color: #ffffff; }
        .calflux-button {
            padding: 12px 20px; border: none; border-radius: 8px; font-weight: bold;
            cursor: pointer; transition: background 0.3s ease;
            background: #00d4ff; color: #0a0e14; margin-top: 10px;
        }
        .calflux-button:hover { background: #00e6ff; }
        .resistor-bands { display: flex; justify-content: center; align-items: center; gap: 10px; }
        .resistor-band {
            width: 40px; height: 100px; border-radius: 5px;
            border: 1px solid #30363d;
        }
        .color-select-container { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin-top: 20px; }
        .color-select { display: flex; flex-direction: column; align-items: center; }
        .color-select select { margin-top: 5px; }
        .band-preview { width: 30px; height: 30px; border: 1px solid #30363d; border-radius: 50%; }

        /* Tutorial */
        #tutorialSection .section-content { max-width: 900px; }
        #tutorialSection p { color: #8b949e; margin-bottom: 15px; }

        /* Ejemplos */
        #examplesSection .section-content { max-width: 600px; }
        .examples-list { display: flex; flex-direction: column; gap: 15px; }
        .example-button {
            padding: 15px 25px; background: rgba(0, 212, 255, 0.1); border: 2px solid #00d4ff;
            border-radius: 10px; color: #00d4ff; font-weight: bold; font-size: 1.1em;
            cursor: pointer; transition: all 0.3s ease;
        }
        .example-button:hover { background: rgba(0, 212, 255, 0.2); transform: translateX(5px); }

        /* Clases Online */
        #classesSection .section-content { text-align: center; max-width: 500px; padding: 50px; }
        .classes-message h3 { font-size: 2em; color: #00d4ff; margin-bottom: 20px; }
        .classes-message p { font-size: 1.2em; color: #c9d1d9; }
        .tiktok-link {
            display: inline-block; margin-top: 20px;
            padding: 10px 20px; background: #00d4ff; color: #0a0e14;
            border-radius: 8px; text-decoration: none; font-weight: bold;
        }

        /* Botón de Volver al Inicio */
        .back-button {
            position: absolute; top: 20px; left: 20px; z-index: 100;
            padding: 10px 20px; background: rgba(22, 27, 34, 0.8);
            border: 2px solid #30363d; border-radius: 8px; color: #e6edf3;
            cursor: pointer; transition: all 0.3s ease;
            display: flex; align-items: center; gap: 8px;
            backdrop-filter: blur(5px);
        }
        .back-button:hover { background: rgba(33, 38, 45, 0.9); border-color: #00d4ff; color: #00d4ff; }
        
        /* Asistente Fluxy */
        #fluxy-assistant {
            position: fixed; bottom: 30px; right: 30px; z-index: 5000;
            display: none;
        }
        #fluxy-main-btn {
            width: 70px; height: 70px; background: linear-gradient(45deg, #00d4ff, #0088cc);
            border-radius: 50%; border: none; cursor: pointer;
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3);
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
        }
        #fluxy-main-btn:hover { transform: scale(1.1); }
        #fluxy-chat-icon { color: #0a0e14; font-size: 2em; }
        #fluxy-face {
            width: 30px; height: 30px; border-radius: 50%;
            background-size: cover; position: absolute; top: 0; left: 0;
            transition: all 0.3s ease-in-out;
            border: 2px solid #0a0e14;
        }

        /* Chat de Fluxy */
        #fluxy-chat {
            position: absolute; bottom: 90px; right: 0;
            width: 350px; height: 450px; background: rgba(13, 17, 23, 0.9);
            backdrop-filter: blur(10px); border: 2px solid #00d4ff;
            border-radius: 20px; box-shadow: 0 10px 40px rgba(0, 212, 255, 0.5);
            display: none; flex-direction: column; overflow: hidden;
            opacity: 0; transform: scale(0.8); transform-origin: bottom right;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        #fluxy-chat.open { display: flex; opacity: 1; transform: scale(1); }
        .chat-header {
            padding: 15px 20px; border-bottom: 1px solid #30363d;
            display: flex; align-items: center; justify-content: space-between;
        }
        .chat-header h4 { font-size: 1.2em; color: #00d4ff; }
        .close-chat-btn {
            background: none; border: none; font-size: 1.5em; cursor: pointer;
            color: #8b949e; transition: color 0.2s;
        }
        .close-chat-btn:hover { color: #ff6b6b; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .chat-messages::-webkit-scrollbar { width: 8px; }
        .chat-messages::-webkit-scrollbar-thumb { background: #00d4ff; border-radius: 4px; }
        .chat-messages::-webkit-scrollbar-track { background: transparent; }
        .message-bubble {
            padding: 10px 15px; border-radius: 15px; max-width: 80%;
            font-size: 0.95em; line-height: 1.4;
        }
        .fluxy-bubble {
            background: rgba(0, 212, 255, 0.15); border-bottom-left-radius: 0;
            align-self: flex-start;
        }
        .user-bubble {
            background: #444c56; color: #e6edf3; border-bottom-right-radius: 0;
            align-self: flex-end;
        }
        .chat-input {
            padding: 15px 20px; border-top: 1px solid #30363d; display: flex; gap: 10px;
        }
        .chat-input input {
            flex: 1; background: #161b22; border: 1px solid #30363d;
            border-radius: 15px; padding: 10px 15px; color: #e6edf3;
            font-size: 1em;
        }
        .chat-input button {
            background: #00d4ff; color: #0a0e14; border: none;
            border-radius: 50%; width: 40px; height: 40px;
            font-size: 1.2em; cursor: pointer; transition: background 0.2s;
        }
        .chat-input button:hover { background: #00e6ff; }
    
        /* Estilos del Panel de Propiedades */
        #propertiesPanel {
            width: 300px;
            min-width: 300px;
            background: rgba(13, 17, 23, 0.95);
            backdrop-filter: blur(10px);
            border-left: 1px solid #30363d;
            padding: 20px;
            display: none;
            flex-direction: column;
            overflow-y: auto;
            z-index: 100;
        }

        #propertiesPanel.visible {
            display: flex;
        }

        #propertiesPanel h3 {
            color: #00d4ff;
            margin-bottom: 20px;
            border-bottom: 1px solid #30363d;
            padding-bottom: 10px;
        }

        #propertiesPanel label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
            color: #e6edf3;
        }

        #propertiesPanel input,
        #propertiesPanel textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            color: #e6edf3;
            font-size: 1em;
        }

        #propertiesPanel .pin-list {
            list-style: none;
            padding: 0;
            margin-top: 10px;
        }

        #propertiesPanel .pin-list li {
            padding: 8px 0;
            border-bottom: 1px dashed #30363d;
            font-size: 0.9em;
            color: #8b949e;
        }
    </style>
</head>
<body>

<!-- ====================
 MEJORAS AÑADIDAS:
 - Feedback dinámico en medidores (V, I, P)
 - Herramientas de conexión visibles
 - Exportar / Importar circuito (JSON, PDF básico)
 - Biblioteca de circuitos predefinidos
 - Tutorial interactivo paso a paso
 - Canvas drag & drop fluido con zoom
 - Multímetro virtual funcional
 - Medidores grandes y prominentes
 - Controles de zoom y atajos de teclado
==================== -->

    <div class="screen-container start-screen active" id="startScreen">
        <div class="logo-container">
            <div class="main-logo"></div>
            <h1 class="app-title">FLUXIONICS</h1>
            <p class="app-subtitle">Simulador Profesional de Circuitos</p>
        </div>
        <div class="start-options">
            <button class="start-button primary" onclick="showSection('simulator')">
                <i class="fas fa-microchip"></i> Simulador
            </button>
            <button class="start-button secondary" onclick="showSection('calflux')">
                <i class="fas fa-bolt"></i> Cal Flux
            </button>
            <button class="start-button secondary" onclick="showSection('tutorial')">
                <i class="fas fa-book"></i> Tutorial Interactivo
            </button>
            <button class="start-button secondary" onclick="showSection('examples')">
                <i class="fas fa-flask"></i> Ejemplos
            </button>
            <button class="start-button secondary" onclick="showSection('classes')">
                <i class="fas fa-chalkboard-teacher"></i> Clases Online
            </button>
        </div>
    </div>

    <div class="screen-container app-container" id="appContainer">
        <div class="component-menu">
            <h3>Componentes</h3>
            <div id="componentList">
                <p style="text-align: center;">Cargando componentes...</p>
            </div>
            <hr style="border-color: #30363d; margin: 15px 0;">
            <h3>Herramientas</h3>
            <div class="component-item" draggable="true" data-component="multimeter">
                <i class="fas fa-tachometer-alt component-icon"></i>
                <span class="component-item-name">Multímetro</span>
            </div>
            <div class="component-item" draggable="true" data-component="oscilloscope">
                <i class="fas fa-wave-square component-icon"></i>
                <span class="component-item-name">Osciloscopio</span>
            </div>
        </div>

        <div class="simulator-layout">
            <div class="simulator-grid" id="simulatorSection">
                <svg id="wire-layer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></svg>
            </div>
            <div id="propertiesPanel">
                <h3>Propiedades</h3>
                <div id="componentProperties">
                    <p>Haz doble clic en un componente para editar sus propiedades.</p>
                </div>
                <button class="calflux-button" style="width: 100%; margin-top: auto;" onclick="saveComponentChanges()">Guardar Cambios</button>
            </div>
        </div>

        <div class="simulator-toolbar">
            <button class="toolbar-button" onclick="toggleSimulation()">
                <i class="fas fa-play" id="sim-icon"></i> <span id="sim-text">Simular</span>
                <span class="sim-status-indicator" id="sim-status"></span>
            </button>
            <button class="toolbar-button" onclick="saveCircuit()"><i class="fas fa-save"></i> Guardar</button>
            <button class="toolbar-button" onclick="loadCircuit()"><i class="fas fa-folder-open"></i> Cargar</button>
        </div>
    </div>

    <div class="screen-container" id="calfluxSection">
        <button class="back-button" onclick="showSection('start')"><i class="fas fa-arrow-left"></i> Volver al inicio</button>
        <div class="section-content">
            <h2>⚡ Cal Flux - Calculadora Electrónica</h2>
            <div class="calflux-section">
                <div class="calflux-calculator">
                    <h3>Calculadora de Ley de Ohm (V, I, R)</h3>
                    <div class="form-group">
                        <label for="ohm-v">Voltaje (V):</label>
                        <input type="number" id="ohm-v">
                        <select id="ohm-v-unit">
                            <option value="1">V</option>
                            <option value="0.001">mV</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ohm-i">Corriente (I):</label>
                        <input type="number" id="ohm-i">
                        <select id="ohm-i-unit">
                            <option value="1">A</option>
                            <option value="0.001">mA</option>
                            <option value="0.000001">µA</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ohm-r">Resistencia (R):</label>
                        <input type="number" id="ohm-r">
                        <select id="ohm-r-unit">
                            <option value="1">Ω</option>
                            <option value="1000">kΩ</option>
                            <option value="1000000">MΩ</option>
                        </select>
                    </div>
                    <button class="calflux-button" style="width: 100%;" onclick="calculateOhm()">Calcular</button>
                    <div class="result-container" id="ohm-result">
                        <p>Introduce dos valores para calcular el tercero.</p>
                    </div>
                </div>

                <div class="calflux-calculator">
                    <h3>Calculadora de Potencia (P)</h3>
                    <div class="form-group">
                        <label for="power-v">Voltaje (V):</label>
                        <input type="number" id="power-v">
                        <select id="power-v-unit">
                            <option value="1">V</option>
                            <option value="0.001">mV</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="power-i">Corriente (I):</label>
                        <input type="number" id="power-i">
                        <select id="power-i-unit">
                            <option value="1">A</option>
                            <option value="0.001">mA</option>
                            <option value="0.000001">µA</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="power-p">Potencia (P):</label>
                        <input type="number" id="power-p" disabled>
                        <select id="power-p-unit">
                            <option value="1">W</option>
                            <option value="1000">kW</option>
                            <option value="0.001">mW</option>
                        </select>
                    </div>
                    <button class="calflux-button" style="width: 100%;" onclick="calculatePower()">Calcular Potencia</button>
                    <div class="result-container" id="power-result">
                        <p>Introduce voltaje y corriente para calcular la potencia.</p>
                    </div>
                </div>

                <div class="calflux-calculator">
                    <h3>Divisor de Voltaje</h3>
                    <div class="form-group">
                        <label for="vd-vin">Voltaje de Entrada (Vin):</label>
                        <input type="number" id="vd-vin">
                        <select id="vd-vin-unit">
                            <option value="1">V</option>
                            <option value="0.001">mV</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="vd-r1">Resistencia 1 (R1):</label>
                        <input type="number" id="vd-r1">
                        <select id="vd-r1-unit">
                            <option value="1">Ω</option>
                            <option value="1000">kΩ</option>
                            <option value="1000000">MΩ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="vd-r2">Resistencia 2 (R2):</label>
                        <input type="number" id="vd-r2">
                        <select id="vd-r2-unit">
                            <option value="1">Ω</option>
                            <option value="1000">kΩ</option>
                            <option value="1000000">MΩ</option>
                        </select>
                    </div>
                    <button class="calflux-button" style="width: 100%;" onclick="calculateVoltageDivider()">Calcular Vout</button>
                    <div class="result-container" id="vd-result">
                        <p>Introduce los valores para calcular el voltaje de salida.</p>
                    </div>
                </div>

                <div class="calflux-calculator">
                    <h3>Código de Colores de Resistencia</h3>
                    <div class="resistor-bands-container" style="text-align: center;">
                        <img src="https://i.imgur.com/KxX975x.png" alt="Resistor" style="height: 60px; margin-bottom: 20px;">
                        <div class="color-select-container">
                            <div class="color-select">
                                <label>Banda 1</label>
                                <select id="band1" onchange="updateResistorColor()"></select>
                            </div>
                            <div class="color-select">
                                <label>Banda 2</label>
                                <select id="band2" onchange="updateResistorColor()"></select>
                            </div>
                            <div class="color-select">
                                <label>Multiplicador</label>
                                <select id="band3" onchange="updateResistorColor()"></select>
                            </div>
                            <div class="color-select">
                                <label>Tolerancia</label>
                                <select id="band4" onchange="updateResistorColor()"></select>
                            </div>
                        </div>
                    </div>
                    <div class="result-container" id="resistor-result" style="margin-top: 20px;">
                        <p>Valor de la resistencia: **--** Ω ± **--**%</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="screen-container" id="tutorialSection">
        <button class="back-button" onclick="showSection('start')"><i class="fas fa-arrow-left"></i> Volver al inicio</button>
        <div class="section-content">
            <h2>📚 Tutorial Interactivo</h2>
            <p>Bienvenido al tutorial. Aquí aprenderás a usar el simulador paso a paso. ¡Comencemos!</p>
            <h3>Paso 1: Añadir un Componente</h3>
            <p>Usa el menú lateral para arrastrar y soltar componentes como resistencias y baterías en el área de trabajo.</p>
            <h3>Paso 2: Conectar Componentes</h3>
            <p>Haz clic en los pines de un componente y luego en el pin de otro para crear conexiones. ¡Así de fácil!</p>
        </div>
    </div>

    <div class="screen-container" id="examplesSection">
        <button class="back-button" onclick="showSection('start')"><i class="fas fa-arrow-left"></i> Volver al inicio</button>
        <div class="section-content">
            <h2>🧪 Ejemplos de Circuitos</h2>
            <p>Selecciona un ejemplo para cargarlo en el simulador y ver cómo funciona.</p>
            <div class="examples-list">
                <button class="example-button" onclick="loadExample('Ley de Ohm')">Ley de Ohm</button>
                <button class="example-button" onclick="loadExample('Divisor de Tensión')">Divisor de Tensión</button>
                <button class="example-button" onclick="loadExample('Blink Arduino')">Blink Arduino (Próximamente)</button>
            </div>
        </div>
    </div>

    <div class="screen-container" id="classesSection">
        <button class="back-button" onclick="showSection('start')"><i class="fas fa-arrow-left"></i> Volver al inicio</button>
        <div class="section-content">
            <div class="classes-message">
                <h3>🚀 Clases Online - ¡Próximamente!</h3>
                <p>Estamos trabajando para traerte los mejores cursos de electrónica.</p>
                <p>Síguenos en <a href="https://www.tiktok.com/@fluxionics" target="_blank" class="tiktok-link">TikTok: @fluxionics</a> para no perderte las novedades.</p>
            </div>
        </div>
    </div>

    <div id="fluxy-assistant">
        <button id="fluxy-main-btn" onclick="toggleFluxyChat()">
            <div id="fluxy-face" style="background-image: url('https://imgur.com/qmphvuK.png');"></div>
            <i id="fluxy-chat-icon" class="fas fa-comment-dots"></i>
        </button>
        <div id="fluxy-chat">
            <div class="chat-header">
                <h4>Fluxy Assistant</h4>
                <button class="close-chat-btn" onclick="toggleFluxyChat()">&times;</button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="message-bubble fluxy-bubble">Hola, estoy aquí para ayudarte o responder tus dudas.</div>
            </div>
            <div class="chat-input">
                <input type="text" id="userInput" placeholder="Escribe tu mensaje..." onkeypress="handleKeyPress(event)">
                <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script>
        // Lógica de SPA y navegación
        const sections = {
            'start': document.getElementById('startScreen'),
            'simulator': document.getElementById('appContainer'),
            'calflux': document.getElementById('calfluxSection'),
            'tutorial': document.getElementById('tutorialSection'),
            'examples': document.getElementById('examplesSection'),
            'classes': document.getElementById('classesSection')
        };
        const fluxyAssistant = document.getElementById('fluxy-assistant');
        let currentSection = 'start';

        function showSection(sectionId) {
            Object.values(sections).forEach(section => {
                section.classList.remove('active');
            });
            
            const sectionToShow = sections[sectionId];
            if (sectionToShow) {
                sectionToShow.classList.add('active');
                if (sectionId === 'start') {
                    fluxyAssistant.style.display = 'none';
                } else {
                    fluxyAssistant.style.display = 'block';
                }
            }
            currentSection = sectionId;
        }

        // Lógica de Fluxy Assistant
        const fluxyChat = document.getElementById('fluxy-chat');
        const fluxyFace = document.getElementById('fluxy-face');
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const emotionUrls = {
            normal: 'https://imgur.com/qmphvuK.png',
            feliz: 'https://imgur.com/oIeoXI4.png',
            pensando: 'https://imgur.com/X9r23Fe.png',
            celebrando: 'https://imgur.com/f78GBdc.png',
            confundido: 'https://imgur.com/5XrVsc9.png',
            alerta: 'https://imgur.com/VaMxNvl.png',
            tecnico: 'https://imgur.com/u19wakl.png',
        };

        function setFluxyEmotion(emotion) {
            fluxyFace.style.backgroundImage = `url('${emotionUrls[emotion] || emotionUrls.normal}')`;
        }

        function toggleFluxyChat() {
            fluxyChat.classList.toggle('open');
            if (fluxyChat.classList.contains('open')) {
                setFluxyEmotion('normal');
                chatMessages.scrollTop = chatMessages.scrollHeight;
                userInput.focus();
            } else {
                setFluxyEmotion('normal');
            }
        }

        function appendMessage(sender, text) {
            const bubble = document.createElement('div');
            bubble.classList.add('message-bubble');
            bubble.classList.add(sender === 'fluxy' ? 'fluxy-bubble' : 'user-bubble');
            bubble.textContent = text;
            chatMessages.appendChild(bubble);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function sendMessage() {
            const text = userInput.value.trim();
            if (text === '') return;

            appendMessage('user', text);
            userInput.value = '';

            setFluxyEmotion('pensando');

            setTimeout(() => {
                const lowerText = text.toLowerCase();
                let response = 'Lo siento, no entiendo. ¿Puedes ser más específico?';
                
                if (lowerText.includes('hola') || lowerText.includes('saludos')) {
                    response = '¡Hola! ¿En qué puedo ayudarte hoy con el simulador?';
                    setFluxyEmotion('feliz');
                } else if (lowerText.includes('ayuda') || lowerText.includes('problema')) {
                    response = 'Claro, dime cuál es tu problema. Intentaré guiarte.';
                    setFluxyEmotion('normal');
                } else if (lowerText.includes('circuito') || lowerText.includes('simulador')) {
                    response = 'El simulador te permite arrastrar componentes y crear conexiones para probar tus diseños.';
                    setFluxyEmotion('tecnico');
                } else if (lowerText.includes('gracias')) {
                    response = '¡De nada! Estoy aquí para servirte.';
                    setFluxyEmotion('feliz');
                } else if (lowerText.includes('formula') || lowerText.includes('calcular')) {
                    response = 'La sección Cal Flux te permite introducir fórmulas como V=I*R y obtener el resultado.';
                    setFluxyEmotion('tecnico');
                } else {
                    setFluxyEmotion('confundido');
                }

                appendMessage('fluxy', response);
                
            }, 1500);
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Lógica de la Calculadora de la Ley de Ohm
        function calculateOhm() {
            const vInput = document.getElementById('ohm-v');
            const iInput = document.getElementById('ohm-i');
            const rInput = document.getElementById('ohm-r');
        
            const vUnit = parseFloat(document.getElementById('ohm-v-unit').value);
            const iUnit = parseFloat(document.getElementById('ohm-i-unit').value);
            const rUnit = parseFloat(document.getElementById('ohm-r-unit').value);
        
            const v = vInput.value.trim() === '' ? NaN : parseFloat(vInput.value) * vUnit;
            const i = iInput.value.trim() === '' ? NaN : parseFloat(iInput.value) * iUnit;
            const r = rInput.value.trim() === '' ? NaN : parseFloat(rInput.value) * rUnit;
        
            const resultContainer = document.getElementById('ohm-result');
            let valuesEntered = 0;
            if (!isNaN(v)) valuesEntered++;
            if (!isNaN(i)) valuesEntered++;
            if (!isNaN(r)) valuesEntered++;
        
            if (valuesEntered !== 2) {
                resultContainer.innerHTML = `<p style="color: #ff6b6b;">Error: Por favor, introduce exactamente dos valores.</p>`;
                setFluxyEmotion('alerta');
                return;
            }
        
            let result = '';
            if (isNaN(v)) {
                const calculatedV = i * r;
                result = `V = ${formatResult(calculatedV)}V`;
                vInput.value = formatResultForInput(calculatedV, vUnit);
            } else if (isNaN(i)) {
                const calculatedI = v / r;
                result = `I = ${formatResult(calculatedI)}A`;
                iInput.value = formatResultForInput(calculatedI, iUnit);
            } else if (isNaN(r)) {
                const calculatedR = v / i;
                result = `R = ${formatResult(calculatedR)}Ω`;
                rInput.value = formatResultForInput(calculatedR, rUnit);
            }
        
            resultContainer.innerHTML = `<p>${result}</p>`;
            setFluxyEmotion('celebrando');
        }

        // Lógica de la Calculadora de Potencia
        function calculatePower() {
            const vInput = document.getElementById('power-v');
            const iInput = document.getElementById('power-i');
            const pInput = document.getElementById('power-p');

            const vUnit = parseFloat(document.getElementById('power-v-unit').value);
            const iUnit = parseFloat(document.getElementById('power-i-unit').value);
            const pUnit = parseFloat(document.getElementById('power-p-unit').value);

            const v = vInput.value.trim() === '' ? NaN : parseFloat(vInput.value) * vUnit;
            const i = iInput.value.trim() === '' ? NaN : parseFloat(iInput.value) * iUnit;

            const resultContainer = document.getElementById('power-result');

            if (isNaN(v) || isNaN(i)) {
                resultContainer.innerHTML = `<p style="color: #ff6b6b;">Error: Por favor, introduce el voltaje y la corriente.</p>`;
                setFluxyEmotion('alerta');
                return;
            }

            const calculatedP = v * i;
            resultContainer.innerHTML = `<p>P = ${formatResult(calculatedP)}W</p>`;
            pInput.value = formatResultForInput(calculatedP, pUnit);
            setFluxyEmotion('celebrando');
        }

        // Lógica del Divisor de Voltaje
        function calculateVoltageDivider() {
            const vinInput = document.getElementById('vd-vin');
            const r1Input = document.getElementById('vd-r1');
            const r2Input = document.getElementById('vd-r2');

            const vinUnit = parseFloat(document.getElementById('vd-vin-unit').value);
            const r1Unit = parseFloat(document.getElementById('vd-r1-unit').value);
            const r2Unit = parseFloat(document.getElementById('vd-r2-unit').value);

            const vin = vinInput.value.trim() === '' ? NaN : parseFloat(vinInput.value) * vinUnit;
            const r1 = r1Input.value.trim() === '' ? NaN : parseFloat(r1Input.value) * r1Unit;
            const r2 = r2Input.value.trim() === '' ? NaN : parseFloat(r2Input.value) * r2Unit;
            
            const resultContainer = document.getElementById('vd-result');

            if (isNaN(vin) || isNaN(r1) || isNaN(r2)) {
                resultContainer.innerHTML = `<p style="color: #ff6b6b;">Error: Por favor, introduce los tres valores.</p>`;
                setFluxyEmotion('alerta');
                return;
            }

            if (r1 + r2 === 0) {
                resultContainer.innerHTML = `<p style="color: #ff6b6b;">Error: La suma de las resistencias no puede ser cero.</p>`;
                setFluxyEmotion('alerta');
                return;
            }

            const calculatedVout = vin * (r2 / (r1 + r2));
            resultContainer.innerHTML = `<p>Vout = ${formatResult(calculatedVout)}V</p>`;
            setFluxyEmotion('celebrando');
        }

        function formatResult(value) {
            // Maneja notación científica para números muy grandes o muy pequeños
            if (Math.abs(value) >= 1000000 || Math.abs(value) < 0.001 && value !== 0) {
                return value.toExponential(3);
            }
            return parseFloat(value.toPrecision(4));
        }

        function formatResultForInput(value, unitMultiplier) {
            return formatResult(value / unitMultiplier);
        }

        // Lógica de la Calculadora de Código de Colores
        const colors = {
            'black': { value: 0, multiplier: 1, color: '#000000', tolerance: NaN },
            'brown': { value: 1, multiplier: 10, color: '#964B00', tolerance: 1 },
            'red': { value: 2, multiplier: 100, color: '#FF0000', tolerance: 2 },
            'orange': { value: 3, multiplier: 1000, color: '#FFA500', tolerance: NaN },
            'yellow': { value: 4, multiplier: 10000, color: '#FFFF00', tolerance: NaN },
            'green': { value: 5, multiplier: 100000, color: '#008000', tolerance: 0.5 },
            'blue': { value: 6, multiplier: 1000000, color: '#0000FF', tolerance: 0.25 },
            'violet': { value: 7, multiplier: 10000000, color: '#EE82EE', tolerance: 0.1 },
            'grey': { value: 8, multiplier: 100000000, color: '#808080', tolerance: 0.05 },
            'white': { value: 9, multiplier: 1000000000, color: '#FFFFFF', tolerance: NaN },
            'gold': { value: NaN, multiplier: 0.1, color: '#FFD700', tolerance: 5 },
            'silver': { value: NaN, multiplier: 0.01, color: '#C0C0C0', tolerance: 10 },
            'none': { value: NaN, multiplier: NaN, color: 'transparent', tolerance: 20 },
        };
        const bands = {
            'band1': Object.keys(colors).slice(0, 10),
            'band2': Object.keys(colors).slice(0, 10),
            'band3': Object.keys(colors).slice(0, 12),
            'band4': ['none', 'brown', 'red', 'green', 'blue', 'violet', 'grey', 'gold', 'silver']
        };
        const band1Select = document.getElementById('band1');
        const band2Select = document.getElementById('band2');
        const band3Select = document.getElementById('band3');
        const band4Select = document.getElementById('band4');

        function populateColorSelects() {
            function populate(selectId, colorList) {
                const select = document.getElementById(selectId);
                select.innerHTML = '';
                colorList.forEach(colorName => {
                    const option = document.createElement('option');
                    option.value = colorName;
                    option.textContent = colorName.charAt(0).toUpperCase() + colorName.slice(1);
                    option.style.backgroundColor = colors[colorName].color;
                    select.appendChild(option);
                });
            }
            populate('band1', bands.band1);
            populate('band2', bands.band2);
            populate('band3', bands.band3);
            populate('band4', bands.band4);
            // Default selection
            band1Select.value = 'brown';
            band2Select.value = 'black';
            band3Select.value = 'red';
            band4Select.value = 'gold';
        }

        function updateResistorColor() {
            const val1 = colors[band1Select.value].value;
            const val2 = colors[band2Select.value].value;
            const multiplier = colors[band3Select.value].multiplier;
            const tolerance = colors[band4Select.value].tolerance;

            if (isNaN(val1) || isNaN(val2) || isNaN(multiplier) || isNaN(tolerance)) {
                document.getElementById('resistor-result').innerHTML = `<p style="color: #ff6b6b;">Selección de colores inválida.</p>`;
                return;
            }

            const value = (val1 * 10 + val2) * multiplier;
            document.getElementById('resistor-result').innerHTML = `<p>Valor de la resistencia: **${formatResistanceValue(value)}** ± **${tolerance}**%</p>`;
            setFluxyEmotion('celebrando');
        }

        function formatResistanceValue(value) {
            if (value >= 1000000) {
                return `${(value / 1000000).toPrecision(4)} MΩ`;
            } else if (value >= 1000) {
                return `${(value / 1000).toPrecision(4)} kΩ`;
            } else {
                return `${value.toPrecision(4)} Ω`;
            }
        }

        // Lógica del Simulador
        const simulatorGrid = document.getElementById('simulatorSection');
        const wireLayer = document.getElementById('wire-layer');
        const componentListContainer = document.getElementById('componentList');
        const propertiesPanel = document.getElementById('propertiesPanel');
        const componentProperties = document.getElementById('componentProperties');
        let componentsOnGrid = [];
        let componentCounter = 0;
        let isDraggingComponent = false;
        let draggingComponent = null;
        let initialX, initialY;
        let isSimulating = false;
        let connections = []; // Array para almacenar las conexiones de los cables

        // Zoom y Paneo
        let scale = 1;
        let translateX = 0;
        let translateY = 0;
        let isPanning = false;

        simulatorGrid.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1; // 0.9 para zoom out, 1.1 para zoom in
            const oldScale = scale;
            scale *= delta;
            scale = Math.max(0.1, Math.min(2, scale)); // Limitar el zoom entre 0.1 y 2
            
            // Ajustar el desplazamiento para mantener el punto de zoom en su lugar
            const rect = simulatorGrid.getBoundingClientRect();
            const mouseX = (e.clientX - rect.left) / oldScale;
            const mouseY = (e.clientY - rect.top) / oldScale;
            
            translateX -= mouseX * (scale - oldScale);
            translateY -= mouseY * (scale - oldScale);

            updateGridTransform();
        });

        simulatorGrid.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('component-pin') || e.target.closest('.component-box')) return;
            if (e.ctrlKey) {
                isPanning = true;
                simulatorGrid.classList.add('panning');
                initialX = e.clientX;
                initialY = e.clientY;
            }
        });

        simulatorGrid.addEventListener('mousemove', (e) => {
            if (isPanning) {
                const deltaX = e.clientX - initialX;
                const deltaY = e.clientY - initialY;
                translateX += deltaX / scale;
                translateY += deltaY / scale;
                initialX = e.clientX;
                initialY = e.clientY;
                updateGridTransform();
            }
        });

        simulatorGrid.addEventListener('mouseup', () => {
            isPanning = false;
            simulatorGrid.classList.remove('panning');
        });

        function updateGridTransform() {
            simulatorGrid.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
            connections.forEach(conn => updateWirePosition(conn.lineElement));
        }

        let isWiring = false;
        let startPin = null;

        // Base de datos de componentes
        let componentDatabase = [];

        // Lógica completa desde la base de datos hasta los pines
        async function fetchComponentsFromDatabase() {
            const fileUrl = 'components.csv';
            try {
                const response = await fetch(fileUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                const rows = csvText.trim().split(/\r?\n/);
                if (rows.length < 2) {
                    throw new Error('El archivo CSV está vacío o solo contiene encabezados.');
                }
                const headers = rows[0].split(',').map(header => header.trim().replace(/^"|"$/g, ''));
                componentDatabase = rows.slice(1).map(row => {
                    const values = row.split(',').map(value => value.trim().replace(/^"|"$/g, ''));
                    const obj = {};
                    if (headers.length === values.length) {
                        headers.forEach((header, index) => {
                            obj[header] = values[index];
                        });
                    } else {
                        return null; // Omitir filas mal formadas
                    }
                    // Parsear el campo de pines_descripción como JSON
                    let pinDescriptions = {};
                    try {
                        if (obj.pines_descripcion) {
                            pinDescriptions = JSON.parse(obj.pines_descripcion.replace(/\\"/g, '"'));
                        }
                    } catch (e) {
                        console.error('Error al parsear pines_descripcion para:', obj.id_base, e);
                    }

                    return {
                        id: obj.id_base,
                        name: obj.nombre,
                        type: obj.tipo,
                        section: obj.seccion,
                        defaultValue: obj.valor_default,
                        minValue: obj.valor_min,
                        maxValue: obj.valor_max,
                        imageUrl: obj.imagen_url,
                        pins: parseInt(obj.pines, 10) || 0,
                        description: obj.descripcion,
                        pinDescriptions: pinDescriptions
                    };
                }).filter(item => item !== null);
                console.log('✅ Componentes cargados desde el archivo local:', componentDatabase);
                populateComponentMenu();
            } catch (error) {
                console.error('❌ Error al cargar el archivo de componentes:', error);
                componentListContainer.innerHTML = `<p style="color: #ff6b6b; text-align: center;">Error: Falló la carga del archivo de datos. Por favor, verifica el formato del CSV.</p>`;
            }
        }

        // Lógica de la populación del menú con secciones
        function populateComponentMenu() {
            componentListContainer.innerHTML = '';
            
            // Agrupar componentes por sección
            const componentsBySection = componentDatabase.reduce((acc, comp) => {
                if (!acc[comp.section]) {
                    acc[comp.section] = [];
                }
                acc[comp.section].push(comp);
                return acc;
            }, {});

            for (const section in componentsBySection) {
                const sectionHeader = document.createElement('h3');
                sectionHeader.textContent = section;
                componentListContainer.appendChild(sectionHeader);

                componentsBySection[section].forEach(comp => {
                    const componentItem = document.createElement('div');
                    componentItem.classList.add('component-item');
                    componentItem.draggable = true;
                    componentItem.dataset.component = comp.id;
                    
                    componentItem.innerHTML = `<img src="${comp.imageUrl}" alt="${comp.name}" style="width: 50px; height: 50px;" class="component-icon">
                                              <span class="component-item-name">${comp.name}</span>`;
                    
                    componentItem.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', comp.id);
                    });
                    componentListContainer.appendChild(componentItem);
                });
            }
        }
        
        simulatorGrid.addEventListener('dragover', (e) => {
            e.preventDefault();
        });

        simulatorGrid.addEventListener('drop', (e) => {
            e.preventDefault();
            const componentId = e.dataTransfer.getData('text/plain');
            if (componentId) {
                const componentData = componentDatabase.find(c => c.id === componentId);
                if (componentData) {
                    const rect = simulatorGrid.getBoundingClientRect();
                    const x = (e.clientX - rect.left) / scale - translateX / scale;
                    const y = (e.clientY - rect.top) / scale - translateY / scale;
                    const newComponent = createComponent(componentData, x, y);
                    simulatorGrid.appendChild(newComponent);
                    componentsOnGrid.push(newComponent);
                } else {
                    alert(`Componente de tipo "${componentId}" no encontrado en la base de datos.`);
                }
            }
        });

        function createComponent(data, x, y) {
            const component = document.createElement('div');
            component.classList.add('component-box');
            component.id = `comp-${componentCounter++}`;
            component.style.left = `${x}px`;
            component.style.top = `${y}px`;
            component.dataset.id = data.id;
            component.dataset.name = data.name;
            component.dataset.data = JSON.stringify(data);
            component.dataset.value = data.defaultValue;
            component.dataset.minValue = data.minValue;
            component.dataset.maxValue = data.maxValue;

            component.innerHTML = `<img src="${data.imageUrl}" alt="${data.name}">`;

            // Lógica de creación de pines (MEJORADA PARA PINES DINÁMICOS)
            let boxWidth = 50;
            let boxHeight = 50;

            if (data.pins > 4) {
                const pinsPerSide = Math.ceil(data.pins / 2);
                boxWidth = 150; 
                boxHeight = 20 * (pinsPerSide + 1); 
                component.style.width = `${boxWidth}px`;
                component.style.height = `${boxHeight}px`;

                for (let i = 0; i < data.pins; i++) {
                    const pin = document.createElement('div');
                    pin.classList.add('component-pin');
                    pin.dataset.pinId = `${component.id}-pin-${i + 1}`;
                    
                    let side;
                    let pinIndex;
                    if (i < pinsPerSide) {
                        side = 'left';
                        pinIndex = i;
                    } else {
                        side = 'right';
                        pinIndex = i - pinsPerSide;
                    }

                    pin.classList.add(side);
                    
                    const topPosition = 100 / (pinsPerSide + 1) * (pinIndex + 1);
                    pin.style.top = `${topPosition}%`;
                    
                    component.appendChild(pin);
                }
            } else if (data.pins === 2) {
                const pin1 = document.createElement('div');
                pin1.classList.add('component-pin', 'left');
                pin1.dataset.pinId = `${component.id}-pin-1`;
                component.appendChild(pin1);

                const pin2 = document.createElement('div');
                pin2.classList.add('component-pin', 'right');
                pin2.dataset.pinId = `${component.id}-pin-2`;
                component.appendChild(pin2);
            } else if (data.pins === 3) {
                const pin1 = document.createElement('div');
                pin1.classList.add('component-pin', 'left');
                pin1.style.top = '25%';
                pin1.dataset.pinId = `${component.id}-pin-1`;
                component.appendChild(pin1);

                const pin2 = document.createElement('div');
                pin2.classList.add('component-pin', 'left');
                pin2.style.top = '75%';
                pin2.dataset.pinId = `${component.id}-pin-2`;
                component.appendChild(pin2);

                const pin3 = document.createElement('div');
                pin3.classList.add('component-pin', 'right');
                pin3.style.top = '50%';
                pin3.dataset.pinId = `${component.id}-pin-3`;
                component.appendChild(pin3);
            } else if (data.pins === 4) {
                const pin1 = document.createElement('div');
                pin1.classList.add('component-pin', 'left');
                pin1.style.top = '25%';
                pin1.dataset.pinId = `${component.id}-pin-1`;
                component.appendChild(pin1);

                const pin2 = document.createElement('div');
                pin2.classList.add('component-pin', 'left');
                pin2.style.top = '75%';
                pin2.dataset.pinId = `${component.id}-pin-2`;
                component.appendChild(pin2);

                const pin3 = document.createElement('div');
                pin3.classList.add('component-pin', 'right');
                pin3.style.top = '25%';
                pin3.dataset.pinId = `${component.id}-pin-3`;
                component.appendChild(pin3);

                const pin4 = document.createElement('div');
                pin4.classList.add('component-pin', 'right');
                pin4.style.top = '75%';
                pin4.dataset.pinId = `${component.id}-pin-4`;
                component.appendChild(pin4);
            }

            component.addEventListener('mousedown', dragComponentStart);
            component.addEventListener('dblclick', handleComponentDoubleClick);
            component.querySelectorAll('.component-pin').forEach(pin => {
                pin.addEventListener('mousedown', startWire);
            });

            return component;
        }

        function dragComponentStart(e) {
            if (e.target.classList.contains('component-pin')) return;
            isDraggingComponent = true;
            draggingComponent = this;
            draggingComponent.classList.add('dragging');
            initialX = e.clientX;
            initialY = e.clientY;
            e.preventDefault();
        }

        simulatorGrid.addEventListener('mousemove', (e) => {
            if (isDraggingComponent && draggingComponent) {
                e.preventDefault();
                const deltaX = (e.clientX - initialX) / scale;
                const deltaY = (e.clientY - initialY) / scale;
                const newX = parseFloat(draggingComponent.style.left) + deltaX;
                const newY = parseFloat(draggingComponent.style.top) + deltaY;
                draggingComponent.style.left = `${newX}px`;
                draggingComponent.style.top = `${newY}px`;
                initialX = e.clientX;
                initialY = e.clientY;
                updateWiresForComponent(draggingComponent);
            }
        });

        simulatorGrid.addEventListener('mouseup', () => {
            if (isDraggingComponent) {
                draggingComponent.classList.remove('dragging');
                isDraggingComponent = false;
                draggingComponent = null;
            }
        });

        // Lógica del panel de propiedades
        let selectedComponent = null;

        function handleComponentDoubleClick(e) {
            e.stopPropagation();
            if (e.target.classList.contains('component-pin')) return;
            selectedComponent = this;
            const componentData = JSON.parse(selectedComponent.dataset.data);
            
            let pinsHtml = '';
            const pinDescriptions = componentData.pinDescriptions || {};
            if (componentData.pins > 0) {
                pinsHtml = `
                    <h4>Pines (${componentData.pins})</h4>
                    <ul class="pin-list">
                `;
                for (let i = 1; i <= componentData.pins; i++) {
                    const pinKey = `pin_${i}`;
                    const description = pinDescriptions[pinKey] || `Pin ${i}`;
                    pinsHtml += `<li><strong>${pinKey}:</strong> ${description}</li>`;
                }
                pinsHtml += `</ul>`;
            }

            componentProperties.innerHTML = `
                <p><strong>ID:</strong> ${componentData.id}</p>
                <p><strong>Nombre:</strong> ${componentData.name}</p>
                <p><strong>Tipo:</strong> ${componentData.type}</p>
                <p><strong>Descripción:</strong> ${componentData.description}</p>
                
                <hr style="border-color: #30363d; margin: 15px 0;">

                <label for="component-value">Valor Actual:</label>
                <input type="text" id="component-value" value="${selectedComponent.dataset.value}">
                
                <label for="component-min-value">Valor Mínimo:</label>
                <input type="text" id="component-min-value" value="${selectedComponent.dataset.minValue}">
                
                <label for="component-max-value">Valor Máximo:</label>
                <input type="text" id="component-max-value" value="${selectedComponent.dataset.maxValue}">
                
                ${pinsHtml}
            `;

            propertiesPanel.classList.add('visible');
        }

        function saveComponentChanges() {
            if (!selectedComponent) return;

            const value = document.getElementById('component-value').value;
            const minValue = document.getElementById('component-min-value').value;
            const maxValue = document.getElementById('component-max-value').value;

            selectedComponent.dataset.value = value;
            selectedComponent.dataset.minValue = minValue;
            selectedComponent.dataset.maxValue = maxValue;
            
            console.log(`Componente ${selectedComponent.id} actualizado:`, { value, minValue, maxValue });
            propertiesPanel.classList.remove('visible');
            selectedComponent = null;
        }

        // Lógica de cables
        function startWire(e) {
            e.stopPropagation();
            if (isWiring && startPin) {
                // Connecting to an existing pin
                if (e.target !== startPin && e.target.classList.contains('component-pin')) {
                    connectPins(startPin, e.target);
                    endWire();
                    return;
                }
            } else {
                // Starting a new wire
                isWiring = true;
                startPin = e.target;
                startPin.classList.add('selected');
            }
        }

        function endWire() {
            isWiring = false;
            if (startPin) {
                startPin.classList.remove('selected');
                startPin = null;
            }
        }

        function connectPins(pin1, pin2) {
            const pin1Id = pin1.dataset.pinId;
            const pin2Id = pin2.dataset.pinId;

            // Evitar conectar un pin consigo mismo
            if (pin1Id === pin2Id) {
                alert('No puedes conectar un pin consigo mismo.');
                return;
            }

            // Evitar duplicados
            if (connections.some(c => (c.pin1 === pin1Id && c.pin2 === pin2Id) || (c.pin1 === pin2Id && c.pin2 === pin1Id))) {
                alert('Esa conexión ya existe.');
                return;
            }

            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('stroke', '#e6edf3');
            line.setAttribute('stroke-width', '2');
            line.dataset.pin1 = pin1Id;
            line.dataset.pin2 = pin2Id;

            wireLayer.appendChild(line);

            connections.push({
                pin1: pin1Id,
                pin2: pin2Id,
                lineElement: line
            });
            updateWirePosition(line);
        }

        function updateWirePosition(line) {
            const pin1 = document.querySelector(`[data-pin-id="${line.dataset.pin1}"]`);
            const pin2 = document.querySelector(`[data-pin-id="${line.dataset.pin2}"]`);

            if (pin1 && pin2) {
                const pin1Rect = pin1.getBoundingClientRect();
                const pin2Rect = pin2.getBoundingClientRect();
                const gridRect = simulatorGrid.getBoundingClientRect();

                const x1 = (pin1Rect.left + pin1Rect.width / 2 - gridRect.left) / scale - translateX / scale;
                const y1 = (pin1Rect.top + pin1Rect.height / 2 - gridRect.top) / scale - translateY / scale;
                const x2 = (pin2Rect.left + pin2Rect.width / 2 - gridRect.left) / scale - translateX / scale;
                const y2 = (pin2Rect.top + pin2Rect.height / 2 - gridRect.top) / scale - translateY / scale;

                line.setAttribute('x1', x1);
                line.setAttribute('y1', y1);
                line.setAttribute('x2', x2);
                line.setAttribute('y2', y2);
            }
        }

        function updateWiresForComponent(component) {
            const componentId = component.id;
            connections.forEach(conn => {
                if (conn.pin1.startsWith(componentId) || conn.pin2.startsWith(componentId)) {
                    updateWirePosition(conn.lineElement);
                }
            });
        }
        
        simulatorGrid.addEventListener('click', (e) => {
            if (isWiring && !e.target.classList.contains('component-pin')) {
                endWire();
            }
        });

        function toggleSimulation() {
            isSimulating = !isSimulating;
            const simIcon = document.getElementById('sim-icon');
            const simText = document.getElementById('sim-text');
            const simStatus = document.getElementById('sim-status');
            if (isSimulating) {
                simIcon.classList.remove('fa-play');
                simIcon.classList.add('fa-stop');
                simText.textContent = 'Detener';
                simStatus.classList.add('running');
                alert('Simulación iniciada. ¡Observa los resultados!');
                setFluxyEmotion('alerta');
            } else {
                simIcon.classList.remove('fa-stop');
                simIcon.classList.add('fa-play');
                simText.textContent = 'Simular';
                simStatus.classList.remove('running');
                alert('Simulación detenida.');
                setFluxyEmotion('tecnico');
            }
        }

        function saveCircuit() {
            alert('Funcionalidad de Guardar: Próximamente. Se guardaría el circuito actual.');
            setFluxyEmotion('tecnico');
        }

        function loadCircuit() {
            alert('Funcionalidad de Cargar: Próximamente. Se cargaría un circuito guardado.');
            setFluxyEmotion('tecnico');
        }

        // Lógica de Ejemplos
        function loadExample(exampleId) {
            const simulatorSection = document.getElementById('simulatorSection');
            simulatorSection.innerHTML = `
                <div class="section-content" style="text-align: center; max-width: none; background: transparent; border: none;">
                    <button class="back-button" onclick="showSection('start')"><i class="fas fa-arrow-left"></i> Volver al inicio</button>
                    <h2>Simulador - Ejemplo: ${exampleId}</h2>
                    <p style="color: #8b949e; margin-top: 20px;">Este es el espacio donde se cargaría el circuito de "${exampleId}".</p>
                    <div style="height: 50vh; background: #161b22; border: 1px dashed #00d4ff; margin-top: 30px; display: flex; align-items: center; justify-content: center; font-size: 1.5em; color: #00d4ff;">
                        [Área de Visualización del Circuito]
                    </div>
                </div>
            `;
            showSection('simulator');
        }

        // Al cargar la página, mostrar solo la pantalla de inicio
        document.addEventListener('DOMContentLoaded', () => {
            showSection('start');
            populateColorSelects();
            updateResistorColor();
            fetchComponentsFromDatabase();
        });
    </script>
</body>
</html>
