<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluxionics - Simulador Profesional de Circuitos</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- html2canvas for image export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%; /* Ensure html and body take full height */
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0e14;
            color: #e6edf3;
            overflow: hidden; /* Keep body hidden to prevent main scrollbar, individual screens will scroll */
            line-height: 1.6;
        }

        /* Screen Management Base Styles */
        .screen {
            display: none; /* All screens hidden by default */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto; /* Allow individual screens to scroll if content overflows */
            -webkit-overflow-scrolling: touch; /* For smoother iOS scrolling */
            flex-direction: column; /* Default to column for content layout */
        }

        .screen.active {
            display: flex; /* Active screen is flex container */
        }

        /* Start Screen Styles */
        #startScreen {
            align-items: center;
            justify-content: center;
            background: radial-gradient(ellipse at center, #1a1f2e 0%, #0a0e14 100%);
            padding: 40px;
            text-align: center;
            position: relative;
            overflow-y: auto; /* Ensure scrolling is enabled for start screen on mobile if content overflows */
        }

        #startScreen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="circuit" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M10,0 L10,5 M10,15 L10,20 M0,10 L5,10 M15,10 L20,10" stroke="%2300d4ff" stroke-width="0.5" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23circuit)"/></svg>') repeat;
            opacity: 0.05;
            z-index: 0;
        }

        .logo-container {
            position: relative;
            z-index: 1;
            margin-bottom: 50px;
        }

        .main-logo {
            width: 150px;
            height: 150px;
            margin: 0 auto 20px;
            background-image: url('https://imgur.com/pxjxVqC.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            animation: logoFloat 6s ease-in-out infinite;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.3);
            user-select: none; /* Prevent selection */
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE 10+ */
            cursor: default; /* No text cursor */
        }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(3deg); }
        }

        .app-title-container { /* New container for title and beta badge on start screen */
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
        }

        .app-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 4.5em;
            font-weight: 900;
            color: #00d4ff;
            text-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
            letter-spacing: 4px;
            background: linear-gradient(45deg, #00d4ff, #ffffff, #00d4ff);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: textShimmer 3s ease-in-out infinite;
            user-select: none; /* Prevent selection */
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE 10+ */
            cursor: default; /* No text cursor */
        }

        @keyframes textShimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .app-subtitle {
            font-size: 1.4em;
            color: #8b949e;
            font-weight: 500;
            margin-bottom: 40px;
            user-select: none; /* Prevent selection */
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE 10+ */
            cursor: default; /* No text cursor */
        }

        .feature-highlights {
            display: flex;
            gap: 40px;
            margin-bottom: 50px;
            z-index: 1;
            position: relative;
            flex-wrap: wrap;
            justify-content: center;
        }

        .feature-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 20px;
            background: rgba(0, 212, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(0, 212, 255, 0.2);
            transition: all 0.3s ease;
            min-width: 180px;
        }

        .feature-item:hover {
            background: rgba(0, 212, 255, 0.1);
            border-color: rgba(0, 212, 255, 0.4);
            transform: translateY(-5px);
        }

        .feature-item i {
            font-size: 2em;
            color: #00d4ff;
        }

        .feature-item span {
            font-size: 0.9em;
            font-weight: 600;
            color: #c9d1d9;
            text-align: center;
        }

        .start-options {
            display: flex;
            gap: 30px;
            z-index: 1;
            position: relative;
            flex-wrap: wrap;
            justify-content: center;
        }

        .start-button {
            padding: 18px 35px;
            border: none;
            border-radius: 12px;
            font-size: 1.2em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 200px;
            justify-content: center;
        }

        .start-button.primary {
            background: linear-gradient(45deg, #00d4ff, #0088cc);
            color: #0a0e14;
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3);
        }

        .start-button.primary:hover {
            background: linear-gradient(45deg, #00e6ff, #00a3e6);
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0, 212, 255, 0.4);
        }

        .start-button.secondary {
            background: rgba(22, 27, 34, 0.8);
            border: 2px solid #30363d;
            color: #e6edf3;
            backdrop-filter: blur(10px);
        }

        .start-button.secondary:hover {
            background: rgba(33, 38, 45, 0.9);
            border-color: #00d4ff;
            color: #00d4ff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        /* App Container */
        #appContainer {
            flex-direction: column;
            height: 100vh;
            background: #0a0e14;
        }

        /* Header Styles */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: rgba(22, 27, 34, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            z-index: 1000;
            border-bottom: 1px solid #30363d;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .header-left, .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-center {
            display: flex;
            align-items: center;
        }

        .menu-btn {
            width: 50px;
            height: 50px;
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            transition: background 0.2s;
            color: #e6edf3;
            font-size: 18px;
        }

        .menu-btn:hover {
            background: rgba(0, 212, 255, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            user-select: none; /* Prevent selection */
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE 10+ */
            cursor: default; /* No text cursor */
        }

        .logo-img {
            width: 40px;
            height: 40px;
            background-image: url('https://imgur.com/pxjxVqC.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            border-radius: 8px;
        }

        .logo-text-container { /* New container for text and beta badge */
            position: relative;
            display: flex;
            flex-direction: column; /* Stack beta on top of text */
            align-items: center; /* Center beta and text horizontally */
            line-height: 1; /* Adjust line height to bring them closer */
        }

        .logo-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            font-weight: 700;
            color: #00d4ff;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .beta-badge {
            background-color: #ffffff;
            color: #0a0e14;
            font-size: 0.7em;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            cursor: default;
            margin-bottom: 2px; /* Small margin between badge and text */
        }

        .simulation-controls {
            display: flex;
            gap: 10px;
            background: rgba(48, 54, 61, 0.8);
            padding: 8px;
            border-radius: 12px;
            border: 1px solid #30363d;
        }

        .control-btn {
            width: 45px;
            height: 45px;
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s;
            color: #e6edf3;
            font-size: 16px;
        }

        .control-btn:hover {
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
        }

        .control-btn.active {
            background: linear-gradient(45deg, #00d4ff, #0088cc);
            color: #0a0e14;
        }

        /* Main Content */
        .main-content {
            display: flex;
            height: calc(100vh - 70px);
            margin-top: 70px;
        }

        /* Components Sidebar */
        .components-sidebar {
            width: 320px;
            background: rgba(22, 27, 34, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-right: 1px solid #30363d;
            overflow-y: auto;
            flex-shrink: 0;
            transition: transform 0.3s ease-in-out; /* For mobile slide effect */
        }

        .search-container {
            margin-bottom: 25px;
        }

        .search-box {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            color: #8b949e;
            z-index: 1;
        }

        .search-box input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            background: rgba(48, 54, 61, 0.6);
            border: 2px solid transparent;
            border-radius: 10px;
            color: #e6edf3;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #00d4ff;
            background: rgba(48, 54, 61, 0.8);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        .component-category {
            margin-bottom: 30px;
        }

        .category-title {
            font-size: 14px;
            font-weight: 700;
            color: #00d4ff;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid rgba(0, 212, 255, 0.3);
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .component-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .component-item {
            width: 85px;
            height: 85px;
            background: rgba(33, 38, 45, 0.8);
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .component-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .component-item:hover::before {
            left: 100%;
        }

        .component-item:hover {
            background: rgba(48, 54, 61, 0.9);
            border-color: #00d4ff;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .component-item.selected {
            background: rgba(0, 212, 255, 0.2);
            border-color: #00d4ff;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.4);
        }

        .component-icon {
            width: 40px;
            height: 40px;
            background: rgba(0, 212, 255, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            color: #00d4ff;
            margin-bottom: 6px;
            transition: all 0.2s;
        }

        .component-item:hover .component-icon {
            background: rgba(0, 212, 255, 0.2);
            transform: scale(1.1);
        }

        .component-name {
            font-size: 11px;
            color: #c9d1d9;
            text-align: center;
            font-weight: 600;
            line-height: 1.2;
        }

        /* Canvas Container */
        .canvas-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0a0e14;
            position: relative;
        }

        .canvas-toolbar {
            height: 60px;
            background: rgba(22, 27, 34, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #30363d;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .tool-group {
            display: flex;
            gap: 5px;
            background: rgba(48, 54, 61, 0.6);
            padding: 5px;
            border-radius: 10px;
        }

        .tool-btn {
            width: 40px;
            height: 40px;
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
            color: #e6edf3;
            font-size: 16px;
        }

        .tool-btn:hover {
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
        }

        .tool-btn.active {
            background: #00d4ff;
            color: #0a0e14;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(48, 54, 61, 0.6);
            padding: 5px 10px;
            border-radius: 10px;
        }

        .zoom-btn {
            width: 35px;
            height: 35px;
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
            color: #e6edf3;
        }

        .zoom-btn:hover {
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
        }

        .zoom-level {
            font-size: 12px;
            color: #8b949e;
            min-width: 50px;
            text-align: center;
        }

        .canvas-area {
            flex: 1;
            position: relative;
            overflow: auto; /* Allow scrolling for canvas area */
            -webkit-overflow-scrolling: touch; /* For smoother iOS scrolling */
        }
        
        .placed-component {
            position: absolute;
            width: 50px; /* Tama√±o del componente en el canvas */
            height: 50px;
            background: #30363d;
            border: 2px solid #00d4ff;
            border-radius: 8px;
            display: flex;
            flex-direction: column; /* To stack icon and pins */
            align-items: center;
            justify-content: center;
            cursor: grab; /* Changed to grab cursor */
            user-select: none; /* Prevent selection */
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE 10+ */
            z-index: 5; /* Ensure components are above wires */
        }
        
        .placed-component:hover {
            border-color: #00e6ff;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
        }
        
        .placed-component.selected {
            border-color: #ffffff;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.6);
            z-index: 10;
        }
        
        .placed-component .icon {
            font-size: 24px;
            color: #ffffff;
        }

        .component-pins {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none; /* Allow clicks to pass through to component */
        }

        .component-pin {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #ff00ff; /* Magenta for visibility */
            border: 1px solid #ffffff;
            border-radius: 50%;
            cursor: crosshair;
            pointer-events: auto; /* Make pins clickable */
            z-index: 15; /* Ensure pins are above components */
            opacity: 0; /* Hidden by default */
            transition: opacity 0.2s;
        }

        .placed-component:hover .component-pin,
        .tool-btn[data-tool="wire"].active ~ .canvas-area .placed-component .component-pin,
        .component-pin.selected-for-wire { /* Always show selected wire pin */
            opacity: 1; /* Show pins on hover or when wire tool is active */
        }
        
        .component-pin.selected-for-wire {
            background-color: #00d4ff; /* Highlight color for selected start pin */
            box-shadow: 0 0 10px #00d4ff;
        }

        .pin-label {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.7em;
            white-space: nowrap;
            pointer-events: none;
            z-index: 20; /* Above pins */
            transform: translate(-50%, -120%); /* Position above pin */
            opacity: 0;
            transition: opacity 0.2s;
        }
        .component-pin:hover .pin-label {
            opacity: 1;
        }
        
        #circuitCanvas {
            background: 
                radial-gradient(circle at 20px 20px, rgba(0, 212, 255, 0.05) 1px, transparent 1px),
                radial-gradient(circle at 0px 0px, rgba(0, 212, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            position: absolute; /* Position it within canvas-area */
            top: 0;
            left: 0;
            z-index: 1; /* Ensure canvas is behind components */
            /* Do not apply transform here, it will be applied by JS */
        }

        /* Scroll Arrows for Mobile (Global positioning) */
        .scroll-arrows {
            position: fixed;
            right: 10px;
            bottom: 10px; /* Adjust based on status bar height */
            display: none; /* Hidden by default, shown on mobile via JS */
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .scroll-arrow-row {
            display: flex;
            justify-content: flex-end; /* Align right */
            gap: 10px;
        }

        .scroll-arrow-btn {
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid #00d4ff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: #00d4ff;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .scroll-arrow-btn:hover {
            background: rgba(0, 212, 255, 0.4);
            transform: scale(1.1);
        }

        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            opacity: 0.1;
        }

        .status-bar {
            height: 40px;
            background: rgba(13, 17, 23, 0.95);
            border-top: 1px solid #30363d;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            font-size: 12px;
        }

        .status-info {
            color: #8b949e;
        }
        
        .status-info.short-circuit {
            color: #ff6b6b;
            font-weight: bold;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        .simulation-stats {
            display: flex;
            gap: 20px;
            color: #8b949e;
        }

        .simulation-stats span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Properties Panel */
        .properties-panel {
            width: 300px;
            background: rgba(22, 27, 34, 0.95);
            backdrop-filter: blur(10px);
            border-left: 1px solid #30363d;
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
            display: none; /* Initially hidden */
            transition: transform 0.3s ease-in-out; /* For mobile slide effect */
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .panel-header h3 {
            font-size: 16px;
            font-weight: 700;
            color: #00d4ff;
        }

        .close-btn {
            width: 30px;
            height: 30px;
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
            color: #8b949e;
        }

        .close-btn:hover {
            background: rgba(255, 0, 0, 0.2);
            color: #ff6b6b;
        }

        .panel-content {
            color: #8b949e;
        }
        
        .property-group {
            margin-bottom: 15px;
        }
        
        .property-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            font-weight: 600;
            color: #c9d1d9;
        }
        
        .property-group input, .property-group select {
            width: 100%;
            padding: 8px;
            background: #30363d;
            border: 1px solid #444c56;
            border-radius: 6px;
            color: #e6edf3;
        }

        /* Sidebar Menu */
        .sidebar-menu {
            position: fixed;
            top: 0;
            left: -400px;
            width: 400px;
            height: 100vh;
            background: rgba(22, 27, 34, 0.98);
            backdrop-filter: blur(15px);
            border-right: 1px solid #30363d;
            z-index: 2000;
            transition: left 0.3s ease;
            overflow-y: auto;
        }

        .sidebar-menu.open {
            left: 0;
        }

        .menu-header {
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            border-bottom: 1px solid #30363d;
        }

        .menu-header h3 {
            font-size: 20px;
            color: #00d4ff;
            font-weight: 700;
        }

        .close-menu-btn {
            width: 40px;
            height: 40px;
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s;
            color: #8b949e;
            font-size: 18px;
        }

        .close-menu-btn:hover {
            background: rgba(255, 0, 0, 0.2);
            color: #ff6b6b;
        }

        .menu-items {
            padding: 20px 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 30px;
            cursor: pointer;
            transition: all 0.2s;
            color: #e6edf3;
            border-left: 3px solid transparent;
        }

        .menu-item:hover {
            background: rgba(0, 212, 255, 0.1);
            border-left-color: #00d4ff;
            color: #00d4ff;
        }

        .menu-item i {
            width: 20px;
            text-align: center;
        }

        /* Cal Flux Section Styles */
        #calfluxSection {
            flex-direction: column;
            padding: 20px;
            background: rgba(22, 27, 34, 0.95);
            border-radius: 12px;
            margin: 20px;
            overflow-y: auto; /* Ensure scrolling is enabled for calflux section on mobile if content overflows */
            position: absolute; /* Changed to absolute for overlay */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 1200px;
            z-index: 2500;
            box-shadow: 0 0 50px rgba(0, 212, 255, 0.2);
        }

        .calflux-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(0, 212, 255, 0.3);
        }

        .calflux-header h2 {
            font-size: 24px;
            color: #00d4ff;
            font-weight: 700;
        }

        /* Nuevos estilos para las tarjetas de Cal Flux */
        .calflux-navigation {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            border-bottom: 1px solid #30363d;
            padding-bottom: 15px;
        }

        .calflux-nav-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(48, 54, 61, 0.8);
            color: #e6edf3;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap; /* Prevent wrapping */
        }

        .calflux-nav-btn:hover {
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
        }

        .calflux-nav-btn.active {
            background: #00d4ff;
            color: #0a0e14;
            box-shadow: 0 4px 10px rgba(0, 212, 255, 0.3);
        }

        .calflux-calculator-area {
            background: rgba(33, 38, 45, 0.8);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #30363d;
        }

        .calculator-section h3 {
            font-size: 1.8em;
            color: #00d4ff;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(0, 212, 255, 0.3);
            padding-bottom: 10px;
        }

        .calculator-section p {
            font-size: 1em;
            color: #c9d1d9;
            margin-bottom: 15px;
        }

        .calculator-section .formula {
            background: #1a1f2e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-family: 'Courier New', Courier, monospace;
            color: #00d4ff;
            font-size: 1.1em;
            overflow-x: auto; /* For long formulas */
        }

        .calculator-section .example {
            background: rgba(0, 212, 255, 0.05);
            border-left: 3px solid #00d4ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #c9d1d9;
        }

        .calculator-input-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }

        .calculator-input-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #c9d1d9;
        }

        .calculator-input-group input,
        .calculator-input-group select {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #444c56;
            background-color: #30363d;
            color: #e6edf3;
            font-size: 1em;
        }

        .calculator-input-group input:focus,
        .calculator-input-group select:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        .calculator-results {
            margin-top: 25px;
            padding: 20px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid #00d4ff;
            border-radius: 8px;
        }

        .calculator-results p {
            font-size: 1.1em;
            font-weight: 600;
            color: #e6edf3;
            margin-bottom: 10px;
        }

        .calculator-results p:last-child {
            margin-bottom: 0;
        }

        .calculator-results span {
            color: #00d4ff;
            font-size: 1.2em;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .action-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #00d4ff;
            color: #0a0e14;
        }

        .action-buttons button:hover {
            background: #00e6ff;
            box-shadow: 0 4px 10px rgba(0, 212, 255, 0.3);
        }
        
        .resistor-bands-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            margin-top: 15px;
            height: 50px; /* Ensure space for bands */
        }

        .resistor-band-color {
            width: 20px;
            height: 50px;
            border-radius: 5px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .resistor-calculator {
            background: rgba(33, 38, 45, 0.8);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #30363d;
            margin-top: 20px;
        }
        
        .resistor-calculator h4 {
            color: #00d4ff;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .resistor-input-group {
            margin-bottom: 15px;
        }
        
        .resistor-input-group label {
            display: block;
            margin-bottom: 5px;
            color: #c9d1d9;
            font-size: 0.9em;
        }
        
        .resistor-input-group select {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #444c56;
            background-color: #30363d;
            color: #e6edf3;
            font-size: 0.9em;
        }
        
        .resistor-result {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid #00d4ff;
            border-radius: 8px;
            text-align: center;\n        }
        
        .resistor-result p {
            font-size: 1.1em;
            font-weight: 600;
            color: #e6edf3;
            margin: 0;
        }
        
        .resistor-result span {
            color: #00d4ff;
            font-size: 1.2em;
        }

        /* Component Guide Styles */
        .component-guide-section {
            background: rgba(33, 38, 45, 0.8);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #30363d;
        }

        .component-guide-section h3 {
            font-size: 1.8em;
            color: #00d4ff;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(0, 212, 255, 0.3);
            padding-bottom: 10px;
        }

        .component-guide-section h4 {
            font-size: 1.4em;
            color: #c9d1d9;
            margin-top: 25px;
            margin-bottom: 15px;
            border-bottom: 1px dashed rgba(0, 212, 255, 0.1);
            padding-bottom: 5px;
        }

        .component-guide-section h5 {
            font-size: 1.1em;
            color: #00d4ff;
            margin-top: 15px;
            margin-bottom: 10px;
        }

        .component-guide-section ul {
            list-style-type: disc;
            margin-left: 20px;
            margin-bottom: 15px;
            color: #8b949e;
        }

        .component-guide-section li {
            margin-bottom: 5px;
        }

        .component-guide-section p {
            color: #c9d1d9;
            margin-bottom: 10px;
        }


        /* Tutorial Section */
        #tutorialSection {
            flex-direction: column;
            padding: 20px;
            background: rgba(13, 17, 23, 0.95);
            backdrop-filter: blur(15px);
            z-index: 3000;
            color: #e6edf3;
            overflow-y: auto; /* Ensure scrolling is enabled for tutorial section on mobile if content overflows */
        }
        
        .tutorial-content {
            max-width: 900px;
            margin: 50px auto;
            padding: 40px;
            background: rgba(22, 27, 34, 0.95);
            border-radius: 12px;
            border: 1px solid #30363d;
            position: relative;
        }
        
        .tutorial-content h2 {
            font-size: 2.5em;
            color: #00d4ff;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(0, 212, 255, 0.3);
            padding-bottom: 10px;
        }
        
.tutorial-content h3 {
            font-size: 1.5em;
            color: #c9d1d9;
            margin-top: 30px;
            margin-bottom: 15px;
        }
        
        .tutorial-content p, .tutorial-content ul {
            font-size: 1.1em;
            line-height: 1.8;
            color: #8b949e;
            margin-bottom: 20px;
        }
        
        .tutorial-content li {
            margin-bottom: 10px;
        }
        
        .tutorial-content code {
            background: #30363d;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            color: #00d4ff;
        }

        /* Examples Flux Section */
        #examplesFluxSection {
            flex-direction: column;
            padding: 20px;
            background: rgba(13, 17, 23, 0.95);
            backdrop-filter: blur(15px);
            z-index: 2500;
            color: #e6edf3;
            overflow-y: auto;
        }

        .examples-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(0, 212, 255, 0.3);
            position: sticky;
            top: 0;
            background: rgba(13, 17, 23, 0.95);
            z-index: 10;
        }

        .examples-header h2 {
            font-size: 24px;
            color: #00d4ff;
            font-weight: 700;
        }

        .examples-category {
            margin-bottom: 40px;
        }

        .examples-category-title {
            font-size: 2em;
            color: #c9d1d9;
            margin-bottom: 25px;
            border-bottom: 1px dashed rgba(0, 212, 255, 0.2);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .examples-category-title i {
            color: #00d4ff;
        }

        .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 30px;
        }

        .example-card {
            background: rgba(22, 27, 34, 0.8);
            border-radius: 12px;
            border: 1px solid #30363d;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .example-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 212, 255, 0.2);
            border-color: #00d4ff;
        }

        .example-card-image {
            width: 100%;
            height: 180px;
            background-color: #1a1f2e;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #8b949e;
            font-size: 0.9em;
            overflow: hidden;
            position: relative;
        }

        .example-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .example-card-content {
            padding: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .example-card-content h4 {
            font-size: 1.4em;
            color: #00d4ff;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .example-meta {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #8b949e;
        }

        .example-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .example-meta .difficulty i {
            color: #FFD700; /* Gold for stars */
        }

        .example-meta .time i {
            color: #00d4ff;
        }

        .example-card-content p {
            font-size: 0.95em;
            color: #c9d1d9;
            margin-bottom: 20px;
            line-height: 1.5;
            flex-grow: 1; /* Allow description to take available space */
        }

        .example-card-button {
            padding: 12px 20px;
            background: linear-gradient(45deg, #00d4ff, #0088cc);
            color: #0a0e14;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.95em;
        }

        .example-card-button:hover {
            background: linear-gradient(45deg, #00e6ff, #00a3e6);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        /* Specific Example Page Styles (within examplesFluxSection for now) */
        .specific-example-page {
            background: rgba(33, 38, 45, 0.8);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #30363d;
            margin-top: 20px;
        }

        .specific-example-page h3 {
            font-size: 2em;
            color: #00d4ff;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(0, 212, 255, 0.3);
            padding-bottom: 10px;
        }

        .specific-example-page .meta-info {
            display: flex;
            gap: 25px;
            margin-bottom: 25px;
            font-size: 1em;
            color: #c9d1d9;
        }

        .specific-example-page .meta-info span {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .specific-example-page .meta-info .difficulty i {
            color: #FFD700;
        }

        .specific-example-page .meta-info .time i {
            color: #00d4ff;
        }

        .specific-example-page .section-title {
            font-size: 1.5em;
            color: #c9d1d9;
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 1px dashed rgba(0, 212, 255, 0.1);
            padding-bottom: 5px;
        }

        .specific-example-page p, .specific-example-page ul {
            font-size: 1em;
            line-height: 1.7;
            color: #8b949e;
            margin-bottom: 15px;
        }

        .specific-example-page ul {
            list-style-type: disc;
            margin-left: 25px;
        }

        .specific-example-page .formula, .specific-example-page .calculation-example {
            background: #1a1f2e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-family: 'Courier New', Courier, monospace;
            color: #00d4ff;
            font-size: 1.1em;
            overflow-x: auto;
        }

        .specific-example-page .calculation-example {
            background: rgba(0, 212, 255, 0.05);
            border-left: 3px solid #00d4ff;
            color: #c9d1d9;
        }

        .specific-example-page .action-button {
            margin-top: 25px;
            padding: 15px 30px;
            background: linear-gradient(45deg, #00d4ff, #0088cc);
            color: #0a0e14;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 1.1em;
        }

        .specific-example-page .action-button:hover {
            background: linear-gradient(45deg, #00e6ff, #00a3e6);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.4);
        }


        /* Protected Content Alert */
        .protected-alert {
            position: fixed; /* Changed to fixed for better overlay */
            background-color: rgba(255, 255, 255, 0.9);
            color: #0a0e14;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none; /* Allow clicks to pass through */
            z-index: 9999;
            transform: translate(-50%, -50%); /* Center based on left/top */
            left: 50%;
            top: 50%;
        }
        .protected-alert.show {
            opacity: 1;
        }

        /* Custom Modal Styles */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .custom-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .custom-modal-content {
            background: #1a1f2e;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
            position: relative;
            max-height: 80vh; /* Limit height for scrollable content */
            overflow-y: auto; /* Enable scrolling for modal content */
        }

        .custom-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #30363d;
            padding-bottom: 10px;
        }

        .custom-modal-header h3 {
            color: #00d4ff;
            font-size: 1.5em;
        }

        .custom-modal-close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            color: #8b949e;
            cursor: pointer;
            transition: color 0.2s;
        }

        .custom-modal-close-btn:hover {
            color: #ff6b6b;
        }

        .custom-modal-body {
            color: #c9d1d9;
            line-height: 1.6;
        }

        .custom-modal-body p {
            margin-bottom: 10px;
        }

        .custom-modal-body .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
            color: #00d4ff;
            font-size: 2em;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        /* Responsive Design */
        @media (max-width: 1200px) {
            .feature-highlights {
                gap: 20px;
            }
            
            .feature-item {
                min-width: 150px;
            }
        }

        @media (max-width: 768px) {
            .app-title {
                font-size: 3em;
            }
            
            .app-subtitle {
                font-size: 1.1em;
            }

            .feature-highlights {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            
            .start-options {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            
            .components-sidebar {
                width: 100%; /* Full width on small screens */
                position: fixed; /* Overlay when open */
                height: calc(100vh - 70px);
                top: 70px;
                left: -100%; /* Hidden by default */
                transform: translateX(0); /* Reset transform */
                transition: left 0.3s ease;
                z-index: 900; /* Above canvas, below header */
            }
            .components-sidebar.open {
                left: 0;
            }
            
            .main-content {
                flex-direction: column; /* Stack sidebar and canvas */
            }

            .properties-panel {
                width: 100%; /* Full width on small screens */
                position: fixed; /* Overlay */
                height: calc(100vh - 70px);
                top: 70px;
                right: -100%; /* Hidden by default */
                transform: translateX(0); /* Reset transform */
                transition: right 0.3s ease;
                z-index: 900;
            }
            .properties-panel.open {
                right: 0;
            }

            #calfluxSection, #tutorialSection, #examplesFluxSection {
                width: 95%; /* More space for content */
                margin: 0 auto; /* Center with auto margin */
                top: 50%; /* Re-center after width change */
                left: 50%; /* Re-center after width change */
                transform: translate(-50%, -50%); /* Re-center with transform */
            }

            .component-grid {
                grid-template-columns: repeat(2, 1fr); /* 2 columns for components */
            }

            .component-card, .resistor-calculator {
                padding: 15px;
            }

            .card-header h3 {
                font-size: 16px;
            }

            .card-icon {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }

            .detail-item {
                font-size: 12px;
            }

            .custom-modal-content {
                width: 95%;
                padding: 20px;
            }

            /* Mobile specific overflow and min-height for scrollable areas */
            /* Removed min-height from screens, relying on content overflow */
            /* Canvas area will have fixed large size to force its own scroll */

            .examples-grid {
                grid-template-columns: 1fr; /* Single column on mobile */
            }
        }
    </style>
</head>
<body>
    <!-- Start Screen -->
    <div class="screen active" id="startScreen">
        <div class="logo-container">
            <div class="main-logo" id="mainLogo"></div>
            <div class="app-title-container">
                <span class="beta-badge">Beta</span> <!-- Beta badge for start screen -->
                <h1 class="app-title">FLUXIONICS</h1>
            </div>
            <p class="app-subtitle">Simulador Profesional de Circuitos</p>
        </div>
        
        <div class="feature-highlights">
            <div class="feature-item">
                <i class="fas fa-microchip"></i>
                <span>Componentes Avanzados</span>
            </div>
            <div class="feature-item">
                <i class="fas fa-bolt"></i>
                <span>Simulaci√≥n en Tiempo Real</span>
            </div>
            <div class="feature-item">
                <i class="fas fa-project-diagram"></i>
                <span>An√°lisis de Circuitos</span>
            </div>
            <div class="feature-item">
                <i class="fas fa-shield-alt"></i>
                <span>Protecci√≥n contra Cortocircuitos</span>
            </div>
            <div class="feature-item">
                <i class="fas fa-table"></i>
                <span>Cal Flux - Documentaci√≥n</span>
            </div>
        </div>
        
        <div class="start-options">
            <button class="start-button primary" onclick="showScreen('appContainer')">
                <i class="fas fa-play"></i>
                Comenzar a Dise√±ar
            </button>
            <button class="start-button secondary" onclick="showScreen('calfluxSection')">
                <i class="fas fa-table"></i>
                Cal Flux
            </button>
            <button class="start-button secondary" onclick="showScreen('examplesFluxSection')">
                <i class="fas fa-lightbulb"></i>
                Ejemplos Flux
            </button>
            <button class="start-button secondary" onclick="showScreen('tutorialSection')">
                <i class="fas fa-graduation-cap"></i>
                Tutorial
            </button>
        </div>
    </div>

    <!-- Cal Flux Section -->
    <div class="screen" id="calfluxSection">
        <div class="calflux-header">
            <i class="fas fa-table"></i>
            <h2>Cal Flux - Herramientas de C√°lculo y Gu√≠a</h2>
            <button class="start-button secondary" onclick="showScreen('startScreen')" style="margin-left: auto;">
                <i class="fas fa-arrow-left"></i>
                Volver
            </button>
        </div>

        <div class="calflux-navigation">
            <button class="calflux-nav-btn active" data-calculator-type="ohm" onclick="renderCalculator('ohm')">Ley de Ohm</button>
            <button class="calflux-nav-btn" data-calculator-type="dividers" onclick="renderCalculator('dividers')">Divisores</button>
            <button class="calflux-nav-btn" data-calculator-type="rcrlFilter" onclick="renderCalculator('rcrlFilter')">Filtros RC/RL</button>
            <button class="calflux-nav-btn" data-calculator-type="lcResonance" onclick="renderCalculator('lcResonance')">Resonancia LC</button>
            <button class="calflux-nav-btn" data-calculator-type="transformers" onclick="renderCalculator('transformers')">Transformadores</button>
            <button class="calflux-nav-btn" data-calculator-type="resistorCode" onclick="renderCalculator('resistorCode')">C√≥digo de Colores Resistencia</button>
            <button class="calflux-nav-btn" data-calculator-type="componentGuide" onclick="renderCalculator('componentGuide')">Gu√≠a de Componentes</button>
        </div>

        <div class="calflux-calculator-area" id="calfluxCalculatorArea">
            <!-- Calculator content will be loaded here by JavaScript -->
        </div>
    </div>
    
    <!-- Examples Flux Section -->
    <div class="screen" id="examplesFluxSection">
        <div class="examples-header">
            <i class="fas fa-lightbulb"></i>
            <h2>Ejemplos Flux</h2>
            <button class="start-button secondary" onclick="showScreen('startScreen')" style="margin-left: auto;">
                <i class="fas fa-arrow-left"></i>
                Volver
            </button>
        </div>

        <div class="examples-content">
            <!-- Basic Examples -->
            <div class="examples-category">
                <h3 class="examples-category-title"><i class="fas fa-circle" style="color: #28a745;"></i> B√ÅSICOS (Principiantes)</h3>
                <div class="examples-grid">
                    <div class="example-card">
                        <div class="example-card-image">
                            <!-- Placeholder Image -->
                            <img src="https://placehold.co/300x180/0d1117/e6edf3?text=LED+B√°sico" alt="Mi Primera Luz LED">
                        </div>
                        <div class="example-card-content">
                            <h4>Mi Primera Luz LED</h4>
                            <div class="example-meta">
                                <span class="difficulty">
                                    <i class="fas fa-star"></i>
                                    <i class="far fa-star"></i>
                                    <i class="far fa-star"></i>
                                    B√°sico
                                </span>
                                <span class="time">
                                    <i class="fas fa-clock"></i> 5 min
                                </span>
                            </div>
                            <p>Aprende a calcular la resistencia limitadora para encender tu primer LED de forma segura.</p>
                            <button class="example-card-button" onclick="openExampleInSimulator('basic_led')">
                                <i class="fas fa-play"></i> Abrir en Simulador
                            </button>
                        </div>
                    </div>

                    <div class="example-card">
                        <div class="example-card-image">
                            <!-- Placeholder Image -->
                            <img src="https://placehold.co/300x180/0d1117/e6edf3?text=Divisor+de+Voltaje" alt="Divisor de Voltaje">
                        </div>
                        <div class="example-card-content">
                            <h4>Divisor de Voltaje</h4>
                            <div class="example-meta">
                                <span class="difficulty">
                                    <i class="fas fa-star"></i>
                                    <i class="far fa-star"></i>
                                    <i class="far fa-star"></i>
                                    B√°sico
                                </span>
                                <span class="time">
                                    <i class="fas fa-clock"></i> 7 min
                                </span>
                            </div>
                            <p>Entiende c√≥mo dos resistencias pueden dividir un voltaje de entrada para obtener una salida espec√≠fica.</p>
                            <button class="example-card-button" onclick="openExampleInSimulator('voltage_divider')">
                                <i class="fas fa-play"></i> Abrir en Simulador
                            </button>
                        </div>
                    </div>

                    <div class="example-card">
                        <div class="example-card-image">
                            <!-- Placeholder Image -->
                            <img src="https://placehold.co/300x180/0d1117/e6edf3?text=Carga+Capacitor" alt="Carga de Capacitor">
                        </div>
                        <div class="example-card-content">
                            <h4>Carga de Capacitor</h4>
                            <div class="example-meta">
                                <span class="difficulty">
                                    <i class="fas fa-star"></i>
                                    <i class="far fa-star"></i>
                                    <i class="far fa-star"></i>
                                    B√°sico
                                </span>
                                <span class="time">
                                    <i class="fas fa-clock"></i> 10 min
                                </span>
                            </div>
                            <p>Observa la curva exponencial de carga y descarga de un capacitor en un circuito RC.</p>
                            <button class="example-card-button" onclick="showModal('Carga de Capacitor', '<p>Este ejemplo estar√° disponible pronto.</p>')">
                                <i class="fas fa-play"></i> Abrir en Simulador
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Intermediate Examples -->
            <div class="examples-category">
                <h3 class="examples-category-title"><i class="fas fa-circle" style="color: #ffc107;"></i> INTERMEDIOS</h3>
                <div class="examples-grid">
                    <div class="example-card">
                        <div class="example-card-image">
                            <!-- Placeholder Image -->
                            <img src="https://placehold.co/300x180/0d1117/e6edf3?text=LED+555" alt="LED Parpadeante 555">
                        </div>
                        <div class="example-card-content">
                            <h4>LED Parpadeante 555</h4>
                            <div class="example-meta">
                                <span class="difficulty">
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="far fa-star"></i>
                                    Intermedio
                                </span>
                                <span class="time">
                                    <i class="fas fa-clock"></i> 15 min
                                </span>
                            </div>
                            <p>Construye tu primer oscilador con el IC 555 en modo astable para hacer parpadear un LED.</p>
                            <button class="example-card-button" onclick="openExampleInSimulator('led_555')">
                                <i class="fas fa-play"></i> Abrir en Simulador
                            </button>
                        </div>
                    </div>

                    <div class="example-card">
                        <div class="example-card-image">
                            <!-- Placeholder Image -->
                            <img src="https://placehold.co/300x180/0d1117/e6edf3?text=Amplificador+Simple" alt="Amplificador Simple">
                        </div>
                        <div class="example-card-content">
                            <h4>Amplificador Simple</h4>
                            <div class="example-meta">
                                <span class="difficulty">
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="far fa-star"></i>
                                    Intermedio
                                </span>
                                <span class="time">
                                    <i class="fas fa-clock"></i> 20 min
                                </span>
                            </div>
                            <p>Aprende a amplificar se√±ales peque√±as usando un transistor BJT y resistencias.</p>
                            <button class="example-card-button" onclick="showModal('Amplificador Simple', '<p>Este ejemplo estar√° disponible pronto.</p>')">
                                <i class="fas fa-play"></i> Abrir en Simulador
                            </button>
                        </div>
                    </div>

                    <div class="example-card">
                        <div class="example-card-image">
                            <!-- Placeholder Image -->
                            <img src="https://placehold.co/300x180/0d1117/e6edf3?text=Control+de+Motor" alt="Control de Motor">
                        </div>
                        <div class="example-card-content">
                            <h4>Control de Motor</h4>
                            <div class="example-meta">
                                <span class="difficulty">
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="far fa-star"></i>
                                    Intermedio
                                </span>
                                <span class="time">
                                    <i class="fas fa-clock"></i> 25 min
                                </span>
                            </div>
                            <p>Controla la velocidad de un motor DC utilizando un MOSFET y modulaci√≥n por ancho de pulso (PWM).</p>
                            <button class="example-card-button" onclick="showModal('Control de Motor', '<p>Este ejemplo estar√° disponible pronto.</p>')">
                                <i class="fas fa-play"></i> Abrir en Simulador
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advanced Examples -->
            <div class="examples-category">
                <h3 class="examples-category-title"><i class="fas fa-circle" style="color: #dc3545;"></i> AVANZADOS</h3>
                <div class="examples-grid">
                    <div class="example-card">
                        <div class="example-card-image">
                            <!-- Placeholder Image -->
                            <img src="https://placehold.co/300x180/0d1117/e6edf3?text=Fuente+Regulada" alt="Fuente Regulada">
                        </div>
                        <div class="example-card-content">
                            <h4>Fuente Regulada</h4>
                            <div class="example-meta">
                                <span class="difficulty">
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    Avanzado
                                </span>
                                <span class="time">
                                    <i class="fas fa-clock"></i> 45 min
                                </span>
                            </div>
                            <p>Dise√±a y simula tu propia fuente de alimentaci√≥n regulada con transformador y regulador de voltaje.</p>
                            <button class="example-card-button" onclick="showModal('Fuente Regulada', '<p>Este ejemplo estar√° disponible pronto.</p>')">
                                <i class="fas fa-play"></i> Abrir en Simulador
                            </button>
                        </div>
                    </div>

                    <div class="example-card">
                        <div class="example-card-image">
                            <!-- Placeholder Image -->
                            <img src="https://placehold.co/300x180/0d1117/e6edf3?text=Filtro+Activo" alt="Filtro Activo">
                        </div>
                        <div class="example-card-content">
                            <h4>Filtro Activo</h4>
                            <div class="example-meta">
                                <span class="difficulty">
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    Avanzado
                                </span>
                                <span class="time">
                                    <i class="fas fa-clock"></i> 30 min
                                </span>
                            </div>
                            <p>Crea un filtro que use un amplificador operacional para seleccionar o rechazar frecuencias espec√≠ficas.</p>
                            <button class="example-card-button" onclick="showModal('Filtro Activo', '<p>Este ejemplo estar√° disponible pronto.</p>')">
                                <i class="fas fa-play"></i> Abrir en Simulador
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tutorial Section -->
    <div class="screen" id="tutorialSection">
        <div class="tutorial-content">
            <button class="close-menu-btn" onclick="showScreen('startScreen')" style="position: absolute; top: 20px; right: 20px;">
                <i class="fas fa-times"></i>
            </button>
            <h2>Tutorial de Fluxionics</h2>
            <p>Bienvenido al tutorial de Fluxionics. Aqu√≠ te explicamos c√≥mo utilizar las principales funciones de nuestra plataforma de simulaci√≥n.</p>
            
            <h3>1. Dise√±o del Circuito</h3>
            <ul>
                <li><strong>A√±adir Componentes:</strong> En la barra lateral izquierda, encontrar√°s las categor√≠as de componentes. Haz clic en un componente para seleccionarlo y luego haz clic en el √°rea de trabajo para colocarlo.</li>
                <li><strong>Conectar Componentes:</strong> Selecciona la herramienta de 'Cable' (<i class="fas fa-route"></i>) en la barra de herramientas superior. Haz clic en el pin de un componente y luego en el pin de otro para crear una conexi√≥n.</li>
                <li><strong>Editar Propiedades:</strong> Con la herramienta de 'Selecci√≥n' (<i class="fas fa-mouse-pointer"></i>) activada, haz doble clic en un componente para abrir el panel de propiedades a la derecha. All√≠ podr√°s ajustar valores como la resistencia, el voltaje, etc.</li>
            </ul>
            
            <h3>2. Simulaci√≥n</h3>
            <ul>
                <li><strong>Iniciar/Pausar:</strong> Usa el bot√≥n de 'Reproducir' (<i class="fas fa-play"></i>) para iniciar la simulaci√≥n. El bot√≥n cambiar√° a 'Pausa' (<i class="fas fa-pause"></i>) para que puedas detenerla temporalmente.</li>
                <li><strong>Detener/Reiniciar:</strong> El bot√≥n de 'Detener' (<i class="fas fa-stop"></i>) detiene la simulaci√≥n y reinicia todos los valores.</li>
                <li><strong>Estado de la Simulaci√≥n:</strong> En la barra de estado inferior, ver√°s los valores de voltaje, corriente y potencia en tiempo real. Si hay un cortocircuito, la barra de estado te lo notificar√° con una alerta.</li>
            </ul>
            
            <h3>3. Guardar y Exportar</h3>
            <ul>
                <li><strong>Guardar:</strong> Usa el bot√≥n 'Guardar' (<i class="fas fa-save"></i>) en el men√∫ o la cabecera para guardar tu circuito como un archivo <code>.json</code>.</li>
                <li><strong>Abrir:</strong> Para cargar un circuito previamente guardado, haz clic en 'Abrir' (<i class="fas fa-folder-open"></i>).</li>
                <li><strong>Exportar:</strong> El bot√≥n 'Exportar Imagen' (<i class="fas fa-image"></i>) en el men√∫ te permitir√° guardar una imagen de tu circuito. Para exportar tu circuito a un formato de texto (como XML), usa el bot√≥n 'Exportar Circuito' en la cabecera.</li>
            </ul>
        </div>
    </div>


    <!-- Main Application -->
    <div class="screen" id="appContainer">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="menu-btn" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                
                <div class="logo">
                    <div class="logo-img" id="smallLogo"></div>
                    <div class="logo-text-container">
                        <span class="beta-badge">Beta</span>
                        <span class="logo-text">FLUXIONICS</span>
                    </div>
                </div>
            </div>
            
            <div class="header-center">
                <div class="simulation-controls">
                    <button class="control-btn" id="playBtn" onclick="toggleSimulation()">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="control-btn" onclick="pauseSimulation()">
                        <i class="fas fa-pause"></i>
                    </button>
                    <button class="control-btn" onclick="resetSimulation()">
                        <i class="fas fa-stop"></i>
                    </button>
                </div>
            </div>
            
            <div class="header-right">
                <button class="control-btn" onclick="saveCircuit()">
                    <i class="fas fa-save"></i>
                </button>
                <button class="control-btn" onclick="loadCircuit()">
                    <i class="fas fa-folder-open"></i>
                </button>
                <button class="control-btn" onclick="exportCircuit()">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Components Sidebar -->
            <div class="components-sidebar" id="componentsSidebar">
                <div class="search-container">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Buscar componentes..." id="componentSearch">
                    </div>
                </div>
                
                <div class="component-categories" id="componentCategories">
                    <!-- Basic Components -->
                    <div class="component-category">
                        <div class="category-title">
                            <i class="fas fa-circle"></i>
                            Componentes B√°sicos
                        </div>
                        <div class="component-grid">
                            <div class="component-item" data-component="resistor">
                                <div class="component-icon">R</div>
                                <div class="component-name">Resistor</div>
                            </div>
                            <div class="component-item" data-component="capacitor">
                                <div class="component-icon">C</div>
                                <div class="component-name">Capacitor</div>
                            </div>
                            <div class="component-item" data-component="inductor">
                                <div class="component-icon">L</div>
                                <div class="component-name">Inductor</div>
                            </div>
                            <div class="component-item" data-component="battery">
                                <div class="component-icon">BAT</div>
                                <div class="component-name">Bater√≠a</div>
                            </div>
                            <div class="component-item" data-component="switch">
                                <div class="component-icon">SW</div>
                                <div class="component-name">Switch</div>
                            </div>
                            <div class="component-item" data-component="ground">
                                <div class="component-icon">GND</div>
                                <div class="component-name">Tierra</div>
                            </div>
                        </div>
                    </div>

                    <!-- Componentes Anal√≥gicos -->
                    <div class="component-category">
                        <div class="category-title">
                            <i class="fas fa-wave-square"></i>
                            Componentes Anal√≥gicos
                        </div>
                        <div class="component-grid">
                            <div class="component-item" data-component="opamp">
                                <div class="component-icon">U</div>
                                <div class="component-name">Op-Amp</div>
                            </div>
                            <div class="component-item" data-component="voltage-reference">
                                <div class="component-icon">VR</div>
                                <div class="component-name">Ref. Voltaje</div>
                            </div>
                            <div class="component-item" data-component="adc">
                                <div class="component-icon">ADC</div>
                                <div class="component-name">Convertidor A/D</div>
                            </div>
                            <div class="component-item" data-component="dac">
                                <div class="component-icon">DAC</div>
                                <div class="component-name">Convertidor D/A</div>
                            </div>
                        </div>
                    </div>

                    <!-- Componentes de Potencia -->
                    <div class="component-category">
                        <div class="category-title">
                            <i class="fas fa-plug"></i>
                            Componentes de Potencia
                        </div>
                        <div class="component-grid">
                            <div class="component-item" data-component="voltage-source">
                                <div class="component-icon">V</div>
                                <div class="component-name">Fuente de Voltaje</div>
                            </div>
                            <div class="component-item" data-component="current-source">
                                <div class="component-icon">I</div>
                                <div class="component-name">Fuente de Corriente</div>
                            </div>
                            <div class="component-item" data-component="motor">
                                <div class="component-icon">M</div>
                                <div class="component-name">Motor</div>
                            </div>
                            <div class="component-item" data-component="bjt">
                                <div class="component-icon">BJT</div>
                                <div class="component-name">Transistor BJT</div>
                            </div>
                            <div class="component-item" data-component="mosfet">
                                <div class="component-icon">MOS</div>
                                <div class="component-name">MOSFET</div>
                            </div>
                             <div class="component-item" data-component="igbt">
                                <div class="component-icon">IGBT</div>
                                <div class="component-name">IGBT</div>
                            </div>
                            <div class="component-item" data-component="driver">
                                <div class="component-icon">DRV</div>
                                <div class="component-name">Driver</div>
                            </div>
                        </div>
                    </div>

                    <!-- Semiconductors -->
                    <div class="component-category">
                        <div class="category-title">
                            <i class="fas fa-microchip"></i>
                            Semiconductores
                        </div>
                        <div class="component-grid">
                            <div class="component-item" data-component="diode">
                                <div class="component-icon">D</div>
                                <div class="component-name">Diodo</div>
                            </div>
                            <div class="component-item" data-component="led">
                                <div class="component-icon">LED</div>
                                <div class="component-name">LED</div>
                            </div>
                            <div class="component-item" data-component="transistor">
                                <div class="component-icon">Q</div>
                                <div class="component-name">Transistor</div>
                            </div>
                        </div>
                    </div>

                    <!-- Circuitos Integrados Digitales -->
                    <div class="component-category">
                        <div class="category-title">
                            <i class="fas fa-memory"></i>
                            Circuitos Integrados Digitales
                        </div>
                        <div class="component-grid">
                            <div class="component-item" data-component="microcontroller">
                                <div class="component-icon">MCU</div>
                                <div class="component-name">Microcontrolador</div>
                            </div>
                            <div class="component-item" data-component="cpld">
                                <div class="component-icon">CPLD</div>
                                <div class="component-name">CPLD</div>
                            </div>
                            <div class="component-item" data-component="fpga">
                                <div class="component-icon">FPGA</div>
                                <div class="component-name">FPGA</div>
                            </div>
                            <div class="component-item" data-component="dsp">
                                <div class="component-icon">DSP</div>
                                <div class="component-name">DSP</div>
                            </div>
                            <div class="component-item" data-component="timer555">
                                <div class="component-icon">555</div>
                                <div class="component-name">Timer 555</div>
                            </div>
                            <div class="component-item" data-component="arduino">
                                <div class="component-icon">ARD</div>
                                <div class="component-name">Arduino</div>
                            </div>
                        </div>
                    </div>

                    <!-- Sensores -->
                    <div class="component-category">
                        <div class="category-title">
                            <i class="fas fa-satellite-dish"></i>
                            Sensores
                        </div>
                        <div class="component-grid">
                            <div class="component-item" data-component="thermistor">
                                <div class="component-icon">TH</div>
                                <div class="component-name">Termistor</div>
                            </div>
                            <div class="component-item" data-component="photoresistor">
                                <div class="component-icon">LDR</div>
                                <div class="component-name">LDR</div>
                            </div>
                            <div class="component-item" data-component="ultrasonic">
                                <div class="component-icon">US</div>
                                <div class="component-name">Ultras√≥nico</div>
                            </div>
                            <div class="component-item" data-component="temp-sensor">
                                <div class="component-icon">TS</div>
                                <div class="component-name">Sensor Temp.</div>
                            </div>
                            <div class="component-item" data-component="pressure-sensor">
                                <div class="component-icon">PS</div>
                                <div class="component-name">Sensor Presi√≥n</div>
                            </div>
                            <div class="component-item" data-component="imu">
                                <div class="component-icon">IMU</div>
                                <div class="component-name">IMU</div>
                            </div>
                            <div class="component-item" data-component="light-sensor">
                                <div class="component-icon">LS</div>
                                <div class="component-name">Sensor Luz</div>
                            </div>
                        </div>
                    </div>

                    <!-- RF y Comunicaciones -->
                    <div class="component-category">
                        <div class="category-title">
                            <i class="fas fa-wifi"></i>
                            RF y Comunicaciones
                        </div>
                        <div class="component-grid">
                            <div class="component-item" data-component="rf-transceiver">
                                <div class="component-icon">RF</div>
                                <div class="component-name">Transceptor RF</div>
                            </div>
                            <div class="component-item" data-component="bluetooth-module">
                                <div class="component-icon">BT</div>
                                <div class="component-name">M√≥dulo Bluetooth</div>
                            </div>
                            <div class="component-item" data-component="ethernet-phy">
                                <div class="component-icon">ETH</div>
                                <div class="component-name">Ethernet PHY</div>
                            </div>
                            <div class="component-item" data-component="rf-amplifier">
                                <div class="component-icon">AMP</div>
                                <div class="component-name">Amplificador RF</div>
                            </div>
                            <div class="component-item" data-component="mixer">
                                <div class="component-icon">MIX</div>
                                <div class="component-name">Mezclador RF</div>
                            </div>
                        </div>
                    </div>

                    <!-- Protecci√≥n y Gesti√≥n T√©rmica -->
                    <div class="component-category">
                        <div class="category-title">
                            <i class="fas fa-shield-alt"></i>
                            Protecci√≥n y Gesti√≥n T√©rmica
                        </div>
                        <div class="component-grid">
                            <div class="component-item" data-component="fuse">
                                <div class="component-icon">F</div>
                                <div class="component-name">Fusible</div>
                            </div>
                            <div class="component-item" data-component="tvs-diode">
                                <div class="component-icon">TVS</div>
                                <div class="component-name">Diodo TVS</div>
                            </div>
                            <div class="component-item" data-component="peltier-cooler">
                                <div class="component-icon">PEL</div>
                                <div class="component-name">Enfriador Peltier</div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Canvas Area -->
            <div class="canvas-container">
                <div class="canvas-toolbar">
                    <div class="tool-group">
                        <button class="tool-btn active" data-tool="select" onclick="selectTool('select')">
                            <i class="fas fa-mouse-pointer"></i>
                        </button>
                        <button class="tool-btn" data-tool="wire" onclick="selectTool('wire')">
                            <i class="fas fa-route"></i>
                        </button>
                        <button class="tool-btn" data-tool="delete" onclick="selectTool('delete')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    
                    <div class="zoom-controls">
                        <button class="zoom-btn" onclick="zoomIn()">
                            <i class="fas fa-plus"></i>
                        </button>
                        <span class="zoom-level">100%</span>
                        <button class="zoom-btn" onclick="zoomOut()">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                
                <div class="canvas-area" id="canvasArea">
                    <canvas id="circuitCanvas"></canvas>
                </div>
                
                <div class="status-bar">
                    <div class="status-info">
                        <span id="statusText">Listo para dise√±ar circuitos</span>
                    </div>
                    <div class="simulation-stats">
                        <span>Voltaje: <span id="voltageDisplay">0V</span></span>
                        <span>Corriente: <span id="currentDisplay">0A</span></span>
                        <span>Potencia: <span id="powerDisplay">0W</span></span>
                        <span>Temperatura: <span id="temperatureDisplay">25¬∞C</span></span>
                    </div>
                </div>
            </div>

            <!-- Properties Panel -->
            <div class="properties-panel" id="propertiesPanel">
                <div class="panel-header">
                    <h3>Propiedades</h3>
                    <button class="close-btn" onclick="closePropertiesPanel()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="panel-content" id="propertiesContent">
                    <p>Selecciona un componente para editar sus propiedades</p>
                </div>
            </div>
        </div>

        <!-- Sidebar Menu -->
        <div class="sidebar-menu" id="sidebarMenu">
            <div class="menu-header">
                <h3>Men√∫</h3>
                <button class="close-menu-btn" onclick="closeSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="menu-items">
                <div class="menu-item" onclick="newCircuit()">
                    <i class="fas fa-file"></i>
                    <span>Nuevo Circuito</span>
                </div>
                <div class="menu-item" onclick="openCircuit()">
                    <i class="fas fa-folder-open"></i>
                    <span>Abrir Circuito</span>
                </div>
                <div class="menu-item" onclick="saveCircuit()">
                    <i class="fas fa-save"></i>
                    <span>Guardar Circuito</span>
                </div>
                <div class="menu-item" onclick="showScreen('calfluxSection')">
                    <i class="fas fa-table"></i>
                    <span>Cal Flux</span>
                </div>
                <div class="menu-item" onclick="showScreen('examplesFluxSection')">
                    <i class="fas fa-lightbulb"></i>
                    <span>Ejemplos Flux</span>
                </div>
                <div class="menu-item" onclick="exportImage()">
                    <i class="fas fa-image"></i>
                    <span>Exportar Imagen</span>
                </div>
                <div class="menu-item" onclick="exportXMLCircuit()">
                    <i class="fas fa-file-export"></i>
                    <span>Exportar a XML</span>
                </div>
                <div class="menu-item" onclick="exportSPICECircuit()">
                    <i class="fas fa-file-code"></i>
                    <span>Exportar a SPICE</span>
                </div>
                <div class="menu-item" onclick="showAnalysis()">
                    <i class="fas fa-chart-line"></i>
                    <span>An√°lisis</span>
                </div>
                <div class="menu-item" onclick="showTemplates()">
                    <i class="fas fa-layer-group"></i>
                    <span>Plantillas</span>
                </div>
                <div class="menu-item" onclick="showSettings()">
                    <i class="fas fa-cog"></i>
                    <span>Configuraci√≥n</span>
                </div>
                <div class="menu-item" onclick="showHelp()">
                    <i class="fas fa-question-circle"></i>
                    <span>Ayuda</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Scroll Arrows (for mobile) - Moved outside appContainer -->
    <div class="scroll-arrows" id="scrollArrows">
        <div class="scroll-arrow-row">
            <button class="scroll-arrow-btn" onclick="scrollCanvas('up')">
                <i class="fas fa-chevron-up"></i>
            </button>
        </div>
        <div class="scroll-arrow-row">
            <button class="scroll-arrow-btn" onclick="scrollCanvas('left')">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="scroll-arrow-btn" onclick="scrollCanvas('right')">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        <div class="scroll-arrow-row">
            <button class="scroll-arrow-btn" onclick="scrollCanvas('down')">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
    </div>

    <!-- Protected Content Alert -->
    <div class="protected-alert" id="protectedAlert">Contenido protegido</div>

    <!-- Custom Modal Structure -->
    <div class="custom-modal-overlay" id="customModalOverlay">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h3 id="customModalTitle"></h3>
                <button class="custom-modal-close-btn" onclick="hideModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="custom-modal-body" id="customModalBody">
                <!-- Content will be injected here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentTool = 'select';
        let selectedComponentTypeForPlacement = null; // Used for mobile click-to-place
        let selectedComponentElement = null; // Used for editing properties
        let componentsCount = 0;
        let isSimulationRunning = false;
        let simulationInterval;
        let isMobileDevice = false; // Flag to detect mobile devices
        
        // Canvas and context references
        let circuitCanvas = null;
        let circuitCtx = null;
        const CANVAS_WIDTH = 3000; // Large fixed width for scrollable canvas
        const CANVAS_HEIGHT = 3000; // Large fixed height for scrollable canvas
        let currentZoom = 1.0; // Initial zoom level

        // Wire drawing variables
        let startPin = null; // { componentId, pinId, x, y, label }
        let connections = []; // Array of { startPin: {comp, pin}, endPin: {comp, pin} }

        // Component data for properties and pins
        // 'pins' array defines the logical pins for each component, including their relative positions (x,y)
        // within the 50x50px component box and a 'label' for display.
        const componentData = {
            'resistor': { name: 'Resistor', properties: { value: '1kŒ©', tolerance: '5%', power: '0.25W' }, icon: 'R',
                pins: [
                    { id: 'p1', label: '1', x: 0, y: 25 }, // Left middle
                    { id: 'p2', label: '2', x: 50, y: 25 }  // Right middle
                ]
            },
            'capacitor': { name: 'Capacitor', properties: { value: '100¬µF', voltage: '25V' }, icon: 'C',
                pins: [
                    { id: 'p1', label: '1', x: 0, y: 25 },
                    { id: 'p2', label: '2', x: 50, y: 25 }
                ]
            },
            'inductor': { name: 'Inductor', properties: { value: '10mH' }, icon: 'L',
                pins: [
                    { id: 'p1', label: '1', x: 0, y: 25 },
                    { id: 'p2', label: '2', x: 50, y: 25 }
                ]
            },
            'battery': { name: 'Bater√≠a', properties: { voltage: '9V' }, icon: 'BAT',
                pins: [
                    { id: 'positive', label: '+', x: 0, y: 15 }, // Top-left for positive
                    { id: 'negative', label: '-', x: 0, y: 35 } // Bottom-left for negative (simplified for 50x50)
                ]
            },
            'switch': { name: 'Switch', properties: { state: 'Abierto' }, icon: 'SW',
                pins: [
                    { id: 'in', label: 'In', x: 0, y: 25 },
                    { id: 'out', label: 'Out', x: 50, y: 25 }
                ]
            },
            'ground': { name: 'Tierra', properties: {}, icon: 'GND',
                pins: [
                    { id: 'main', label: 'GND', x: 25, y: 50 } // Bottom middle
                ]
            },
            'voltage-source': { name: 'Fuente de Voltaje', properties: { value: '5V' }, icon: 'V',
                pins: [
                    { id: 'positive', label: '+', x: 0, y: 15 },
                    { id: 'negative', label: '-', x: 0, y: 35 }
                ]
            },
            'current-source': { name: 'Fuente de Corriente', properties: { value: '1A' }, icon: 'I',
                pins: [
                    { id: 'in', label: 'In', x: 0, y: 25 },
                    { id: 'out', label: 'Out', x: 50, y: 25 }
                ]
            },
            'motor': { name: 'Motor', properties: { speed: '1000 RPM' }, icon: 'M',
                pins: [
                    { id: 'A', label: 'A', x: 0, y: 25 },
                    { id: 'B', label: 'B', x: 50, y: 25 }
                ]
            },
            'diode': { name: 'Diodo', properties: { type: 'Rectificador' }, icon: 'D',
                pins: [
                    { id: 'anode', label: 'A', x: 0, y: 25 },
                    { id: 'cathode', label: 'K', x: 50, y: 25 }
                ]
            },
            'led': { name: 'LED', properties: { color: 'Rojo' }, icon: 'LED',
                pins: [
                    { id: 'anode', label: 'A', x: 0, y: 25 },
                    { id: 'cathode', label: 'K', x: 50, y: 25 }
                ]
            },
            'transistor': { name: 'Transistor', properties: { type: 'NPN' }, icon: 'Q',
                pins: [
                    { id: 'base', label: 'B', x: 0, y: 25 }, // Left
                    { id: 'collector', label: 'C', x: 25, y: 0 }, // Top
                    { id: 'emitter', label: 'E', x: 50, y: 25 } // Right
                ]
            },
            'mosfet': { name: 'MOSFET', properties: { type: 'N-Channel' }, icon: 'MOS', // Changed icon to MOS for clarity
                pins: [
                    { id: 'gate', label: 'G', x: 0, y: 25 }, // Left
                    { id: 'drain', label: 'D', x: 25, y: 0 }, // Top
                    { id: 'source', label: 'S', x: 50, y: 25 } // Right
                ]
            },
            'opamp': { name: 'Op-Amp', properties: { model: 'LM741' }, icon: 'U',
                // Standard 8-pin DIP package for visual representation
                // Corrected pin positions for visual clarity on a 50x50px square
                pins: [
                    { id: 'offset_null_1', label: '1(Null)', x: 10, y: 0 }, // Pin 1 (top-left)
                    { id: 'inverting', label: '2(-In)', x: 0, y: 15 }, // Pin 2 (left-top)
                    { id: 'non_inverting', label: '3(+In)', x: 0, y: 35 }, // Pin 3 (left-bottom)
                    { id: 'vcc_neg', label: '4(V-)', x: 10, y: 50 }, // Pin 4 (bottom-left)
                    { id: 'offset_null_2', label: '5(Null)', x: 40, y: 50 }, // Pin 5 (bottom-right)
                    { id: 'output', label: '6(Out)', x: 50, y: 35 }, // Pin 6 (right-bottom)
                    { id: 'vcc_pos', label: '7(V+)', x: 50, y: 15 }, // Pin 7 (right-top)
                    { id: 'nc', label: '8(NC)', x: 40, y: 0 } // Pin 8 (top-right)
                ]
            },
            'timer555': { name: 'Timer 555', properties: { mode: 'Astable' }, icon: '555',
                // Timer 555 is an 8-pin IC. Pins arranged to simulate rectangular DIP.
                // Adjusted positions to better represent a standard DIP layout within a 50x50px square
                pins: [
                    { id: 'gnd', label: '1(GND)', x: 0, y: 45 },    // Pin 1 (Bottom-left)
                    { id: 'trigger', label: '2(TRIG)', x: 0, y: 30 }, // Pin 2 (Left side, below center)
                    { id: 'output', label: '3(OUT)', x: 0, y: 15 },   // Pin 3 (Left side, above center)
                    { id: 'reset', label: '4(RST)', x: 0, y: 0 },    // Pin 4 (Top-left)
                    { id: 'control_voltage', label: '5(CV)', x: 50, y: 0 }, // Pin 5 (Top-right)
                    { id: 'threshold', label: '6(THRES)', x: 50, y: 15 }, // Pin 6 (Right side, above center)
                    { id: 'discharge', label: '7(DISC)', x: 50, y: 30 }, // Pin 7 (Right side, below center)
                    { id: 'vcc', label: '8(VCC)', x: 50, y: 45 }     // Pin 8 (Bottom-right)
                ]
            },
            'arduino': { name: 'Arduino', properties: { model: 'UNO' }, icon: 'ARD',
                // Arduino has many pins. This is a very simplified subset for visual demo.
                pins: [
                    { id: 'd0', label: 'D0', x: 0, y: 10 },
                    { id: 'd1', label: 'D1', x: 0, y: 20 },
                    { id: 'a0', label: 'A0', x: 0, y: 30 },
                    { id: 'gnd', label: 'GND', x: 0, y: 40 },
                    { id: '5v', label: '5V', x: 50, y: 10 },
                    { id: '3v3', label: '3.3V', x: 50, y: 20 }
                ]
            },
            'thermistor': { name: 'Termistor', properties: { temp: '25¬∞C' }, icon: 'TH',
                pins: [
                    { id: 'p1', label: '1', x: 0, y: 25 },
                    { id: 'p2', label: '2', x: 50, y: 25 }
                ]
            },
            'photoresistor': { name: 'LDR', properties: { light: '50%' }, icon: 'LDR',
                pins: [
                    { id: 'p1', label: '1', x: 0, y: 25 },
                    { id: 'p2', label: '2', x: 50, y: 25 }
                ]
            },
            'ultrasonic': { name: 'Ultras√≥nico', properties: { range: '10cm' }, icon: 'US',
                pins: [
                    { id: 'vcc', label: 'VCC', x: 25, y: 0 }, // Top
                    { id: 'gnd', label: 'GND', x: 25, y: 50 }, // Bottom
                    { id: 'trig', label: 'Trig', x: 0, y: 25 }, // Left
                    { id: 'echo', label: 'Echo', x: 50, y: 25 } // Right
                ]
            },
            // --- New Components from PDF ---
            'voltage-reference': { name: 'Ref. Voltaje', properties: { value: '2.5V', drift: '5ppm/¬∞C' }, icon: 'VR',
                pins: [
                    { id: 'out', label: 'Out', x: 25, y: 0 },
                    { id: 'gnd', label: 'GND', x: 25, y: 50 }
                ]
            },
            'adc': { name: 'Convertidor A/D', properties: { bits: '16', channels: '4', interface: 'I2C' }, icon: 'ADC',
                pins: [
                    { id: 'vin1', label: 'IN1', x: 0, y: 10 },
                    { id: 'vin2', label: 'IN2', x: 0, y: 20 },
                    { id: 'scl', label: 'SCL', x: 50, y: 10 },
                    { id: 'sda', label: 'SDA', x: 50, y: 20 },
                    { id: 'vcc', label: 'VCC', x: 10, y: 0 },
                    { id: 'gnd', label: 'GND', x: 40, y: 50 }
                ]
            },
            'dac': { name: 'Convertidor D/A', properties: { bits: '12', interface: 'I2C' }, icon: 'DAC',
                pins: [
                    { id: 'dout', label: 'Out', x: 50, y: 25 },
                    { id: 'scl', label: 'SCL', x: 0, y: 10 },
                    { id: 'sda', label: 'SDA', x: 0, y: 20 },
                    { id: 'vcc', label: 'VCC', x: 10, y: 0 },
                    { id: 'gnd', label: 'GND', x: 40, y: 50 }
                ]
            },
            'bjt': { name: 'Transistor BJT', properties: { type: 'NPN', Ic_max: '3A', Vce_max: '100V' }, icon: 'BJT',
                pins: [
                    { id: 'base', label: 'B', x: 0, y: 25 },
                    { id: 'collector', label: 'C', x: 25, y: 0 },
                    { id: 'emitter', label: 'E', x: 50, y: 25 }
                ]
            },
            'igbt': { name: 'IGBT', properties: { Vce_max: '600V', Ic_max: '96A' }, icon: 'IGBT',
                pins: [
                    { id: 'gate', label: 'G', x: 0, y: 25 },
                    { id: 'collector', label: 'C', x: 25, y: 0 },
                    { id: 'emitter', label: 'E', x: 50, y: 25 }
                ]
            },
            'driver': { name: 'Driver', properties: { type: 'MOSFET Driver', peak_current: '6A' }, icon: 'DRV',
                pins: [
                    { id: 'in', label: 'In', x: 0, y: 15 },
                    { id: 'out', label: 'Out', x: 50, y: 15 },
                    { id: 'vcc', label: 'VCC', x: 25, y: 0 },
                    { id: 'gnd', label: 'GND', x: 25, y: 50 }
                ]
            },
            'microcontroller': { name: 'Microcontrolador', properties: { model: 'STM32F103', flash: '128KB', ram: '20KB' }, icon: 'MCU',
                pins: [
                    { id: 'pa0', label: 'PA0', x: 0, y: 10 },
                    { id: 'pa1', label: 'PA1', x: 0, y: 20 },
                    { id: 'vcc', label: 'VCC', x: 10, y: 0 },
                    { id: 'gnd', label: 'GND', x: 40, y: 50 },
                    { id: 'pb0', label: 'PB0', x: 50, y: 10 },
                    { id: 'pb1', label: 'PB1', x: 50, y: 20 }
                ]
            },
            'cpld': { name: 'CPLD', properties: { macrocells: '72', voltage: '5V' }, icon: 'CPLD',
                pins: [
                    { id: 'io1', label: 'IO1', x: 0, y: 10 },
                    { id: 'io2', label: 'IO2', x: 0, y: 20 },
                    { id: 'vcc', label: 'VCC', x: 10, y: 0 },
                    { id: 'gnd', label: 'GND', x: 40, y: 50 },
                    { id: 'clk', label: 'CLK', x: 50, y: 10 }
                ]
            },
            'fpga': { name: 'FPGA', properties: { family: 'Cyclone IV', logic_elements: '10k' }, icon: 'FPGA',
                pins: [
                    { id: 'io_a1', label: 'IO_A1', x: 0, y: 10 },
                    { id: 'io_a2', label: 'IO_A2', x: 0, y: 20 },
                    { id: 'vcc', label: 'VCC', x: 10, y: 0 },
                    { id: 'gnd', label: 'GND', x: 40, y: 50 },
                    { id: 'clk', label: 'CLK', x: 50, y: 10 }
                ]
            },
            'dsp': { name: 'DSP', properties: { model: 'TMS320F28335', freq: '150MHz' }, icon: 'DSP',
                pins: [
                    { id: 'data_in1', label: 'D_IN1', x: 0, y: 10 },
                    { id: 'data_in2', label: 'D_IN2', x: 0, y: 20 },
                    { id: 'data_out1', label: 'D_OUT1', x: 50, y: 10 },
                    { id: 'data_out2', label: 'D_OUT2', x: 50, y: 20 },
                    { id: 'vcc', label: 'VCC', x: 10, y: 0 },
                    { id: 'gnd', label: 'GND', x: 40, y: 50 }
                ]
            },
            'temp-sensor': { name: 'Sensor Temp.', properties: { model: 'DS18B20', accuracy: '¬±0.5¬∞C' }, icon: 'TS',
                pins: [
                    { id: 'data', label: 'Data', x: 0, y: 25 },
                    { id: 'vcc', label: 'VCC', x: 25, y: 0 },
                    { id: 'gnd', label: 'GND', x: 25, y: 50 }
                ]
            },
            'pressure-sensor': { name: 'Sensor Presi√≥n', properties: { model: 'BMP280', range: '300-1100hPa' }, icon: 'PS',
                pins: [
                    { id: 'scl', label: 'SCL', x: 0, y: 15 },
                    { id: 'sda', label: 'SDA', x: 0, y: 35 },
                    { id: 'vcc', label: 'VCC', x: 25, y: 0 },
                    { id: 'gnd', label: 'GND', x: 25, y: 50 }
                ]
            },
            'imu': { name: 'IMU', properties: { model: 'MPU6050', dof: '6' }, icon: 'IMU',
                pins: [
                    { id: 'scl', label: 'SCL', x: 0, y: 15 },
                    { id: 'sda', label: 'SDA', x: 0, y: 35 },
                    { id: 'vcc', label: 'VCC', x: 25, y: 0 },
                    { id: 'gnd', label: 'GND', x: 25, y: 50 }
                ]
            },
            'light-sensor': { name: 'Sensor Luz', properties: { model: 'TSL2561', type: 'Digital' }, icon: 'LS',
                pins: [
                    { id: 'scl', label: 'SCL', x: 0, y: 15 },
                    { id: 'sda', label: 'SDA', x: 0, y: 35 },
                    { id: 'vcc', label: 'VCC', x: 25, y: 0 },
                    { id: 'gnd', label: 'GND', x: 25, y: 50 }
                ]
            },
            'rf-transceiver': { name: 'Transceptor RF', properties: { freq: '2.4GHz', data_rate: '2Mbps' }, icon: 'RF',
                pins: [
                    { id: 'spi_mosi', label: 'MOSI', x: 0, y: 10 },
                    { id: 'spi_miso', label: 'MISO', x: 0, y: 20 },
                    { id: 'spi_sck', label: 'SCK', x: 0, y: 30 },
                    { id: 'vcc', label: 'VCC', x: 10, y: 0 },
                    { id: 'gnd', label: 'GND', x: 40, y: 50 },
                    { id: 'ce', label: 'CE', x: 50, y: 10 },
                    { id: 'csn', label: 'CSN', x: 50, y: 20 }
                ]
            },
            'bluetooth-module': { name: 'M√≥dulo Bluetooth', properties: { model: 'HC-05', interface: 'UART' }, icon: 'BT',
                pins: [
                    { id: 'tx', label: 'TX', x: 0, y: 15 },
                    { id: 'rx', label: 'RX', x: 0, y: 35 },
                    { id: 'vcc', label: 'VCC', x: 25, y: 0 },
                    { id: 'gnd', label: 'GND', x: 25, y: 50 }
                ]
            },
            'ethernet-phy': { name: 'Ethernet PHY', properties: { model: 'ENC28J60', interface: 'SPI' }, icon: 'ETH',
                pins: [
                    { id: 'spi_mosi', label: 'MOSI', x: 0, y: 10 },
                    { id: 'spi_miso', label: 'MISO', x: 0, y: 20 },
                    { id: 'spi_sck', label: 'SCK', x: 0, y: 30 },
                    { id: 'vcc', label: 'VCC', x: 10, y: 0 },
                    { id: 'gnd', label: 'GND', x: 40, y: 50 },
                    { id: 'cs', label: 'CS', x: 50, y: 10 }
                ]
            },
            'rf-amplifier': { name: 'Amplificador RF', properties: { gain: '20dB', freq_range: '1-6GHz' }, icon: 'AMP',
                pins: [
                    { id: 'in', label: 'In', x: 0, y: 25 },
                    { id: 'out', label: 'Out', x: 50, y: 25 },
                    { id: 'vcc', label: 'VCC', x: 25, y: 0 },
                    { id: 'gnd', label: 'GND', x: 25, y: 50 }
                ]
            },
            'mixer': { name: 'Mezclador RF', properties: { model: 'ADE-1', freq: '5-1000MHz' }, icon: 'MIX',
                pins: [
                    { id: 'rf_in', label: 'RF In', x: 0, y: 15 },
                    { id: 'lo_in', label: 'LO In', x: 0, y: 35 },
                    { id: 'if_out', label: 'IF Out', x: 50, y: 25 }
                ]
            },
            'fuse': { name: 'Fusible', properties: { current_rating: '1A', voltage_rating: '250V' }, icon: 'F',
                pins: [
                    { id: 'in', label: 'In', x: 0, y: 25 },
                    { id: 'out', label: 'Out', x: 50, y: 25 }
                ]
            },
            'tvs-diode': { name: 'Diodo TVS', properties: { voltage: '5V', clamping_voltage: '7.5V' }, icon: 'TVS',
                pins: [
                    { id: 'p1', label: '1', x: 0, y: 25 },
                    { id: 'p2', label: '2', x: 50, y: 25 }
                ]
            },
            'peltier-cooler': { name: 'Enfriador Peltier', properties: { power: '50W', delta_temp: '60¬∞C' }, icon: 'PEL',
                pins: [
                    { id: 'positive', label: '+', x: 0, y: 15 },
                    { id: 'negative', label: '-', x: 0, y: 35 }
                ]
            },
        };

        // Resistor color code values
        const colorValues = {
            'black': 0, 'brown': 1, 'red': 2, 'orange': 3, 'yellow': 4,
            'green': 5, 'blue': 6, 'violet': 7, 'gray': 8, 'white': 9
        };
        const multiplierValues = {
            'black': 1, 'brown': 10, 'red': 100, 'orange': 1000, 'yellow': 10000,
            'green': 100000, 'blue': 1000000, 'violet': 10000000, 'gold': 0.1, 'silver': 0.01
        };
        const toleranceValues = {
            'brown': '¬±1%', 'red': '¬±2%', 'green': '¬±0.5%', 'blue': '¬±0.25%',
            'violet': '¬±0.1%', 'gray': '¬±0.05%', 'gold': '¬±5%', 'silver': '¬±10%'
        };
        
        // --- Predefined Example Circuits ---
        const exampleCircuits = {
            'basic_led': {
                name: 'Mi Primera Luz LED',
                components: [
                    { type: 'battery', id: 'batt-1', x: 100, y: 100, properties: { voltage: '9V' } },
                    { type: 'resistor', id: 'r1-1', x: 250, y: 100, properties: { value: '220Œ©' } },
                    { type: 'led', id: 'led-1', x: 400, y: 100, properties: { color: 'Rojo' } },
                    { type: 'ground', id: 'gnd-1', x: 250, y: 250, properties: {} }
                ],
                connections: [
                    { start: { compId: 'batt-1', pinId: 'positive' }, end: { compId: 'r1-1', pinId: 'p1' } },
                    { start: { compId: 'r1-1', pinId: 'p2' }, end: { compId: 'led-1', pinId: 'anode' } },
                    { start: { compId: 'led-1', pinId: 'cathode' }, end: { compId: 'gnd-1', pinId: 'main' } },
                    { start: { compId: 'batt-1', pinId: 'negative' }, end: { compId: 'gnd-1', pinId: 'main' } }
                ]
            },
            'voltage_divider': {
                name: 'Divisor de Voltaje',
                components: [
                    { type: 'voltage-source', id: 'vsource-1', x: 100, y: 100, properties: { value: '9V' } },
                    { type: 'resistor', id: 'r1-1', x: 250, y: 100, properties: { value: '1kŒ©' } },
                    { type: 'resistor', id: 'r2-1', x: 250, y: 250, properties: { value: '2kŒ©' } },
                    { type: 'ground', id: 'gnd-1', x: 250, y: 400, properties: {} }
                ],
                connections: [
                    { start: { compId: 'vsource-1', pinId: 'positive' }, end: { compId: 'r1-1', pinId: 'p1' } },
                    { start: { compId: 'r1-1', pinId: 'p2' }, end: { compId: 'r2-1', pinId: 'p1' } },
                    { start: { compId: 'r2-1', pinId: 'p2' }, end: { compId: 'gnd-1', pinId: 'main' } },
                    { start: { compId: 'vsource-1', pinId: 'negative' }, end: { compId: 'gnd-1', pinId: 'main' } }
                ]
            },
            'led_555': {
                name: 'LED Parpadeante 555',
                components: [
                    { type: 'timer555', id: 'timer555-1', x: 200, y: 200, properties: {} },
                    { type: 'led', id: 'led-1', x: 400, y: 250, properties: { color: 'Rojo' } },
                    { type: 'resistor', id: 'r1-1', x: 250, y: 100, properties: { value: '1kŒ©' } },
                    { type: 'resistor', id: 'r2-1', x: 350, y: 100, properties: { value: '100kŒ©' } },
                    { type: 'capacitor', id: 'c1-1', x: 300, y: 400, properties: { value: '10¬µF' } },
                    { type: 'battery', id: 'batt-1', x: 100, y: 100, properties: { voltage: '9V' } },
                    { type: 'ground', id: 'gnd-1', x: 100, y: 450, properties: {} }
                ],
                connections: [
                    // Battery positive to 555 VCC (pin 8) and R1 (pin 1)
                    { start: { compId: 'batt-1', pinId: 'positive' }, end: { compId: 'timer555-1', pinId: 'vcc' } },
                    { start: { compId: 'batt-1', pinId: 'positive' }, end: { compId: 'r1-1', pinId: 'p1' } },

                    // R1 to R2
                    { start: { compId: 'r1-1', pinId: 'p2' }, end: { compId: 'r2-1', pinId: 'p1' } },

                    // R1 to 555 Discharge (pin 7)
                    { start: { compId: 'r1-1', pinId: 'p2' }, end: { compId: 'timer555-1', pinId: 'discharge' } },

                    // R2 to 555 Threshold (pin 6) and Trigger (pin 2)
                    { start: { compId: 'r2-1', pinId: 'p2' }, end: { compId: 'timer555-1', pinId: 'threshold' } },
                    { start: { compId: 'r2-1', pinId: 'p2' }, end: { compId: 'timer555-1', pinId: 'trigger' } },

                    // 555 Threshold (pin 6) to Capacitor (pin 1)
                    { start: { compId: 'timer555-1', pinId: 'threshold' }, end: { compId: 'c1-1', pinId: 'p1' } },

                    // Capacitor (pin 2) to Ground
                    { start: { compId: 'c1-1', pinId: 'p2' }, end: { compId: 'gnd-1', pinId: 'main' } },

                    // 555 Ground (pin 1) to Ground
                    { start: { compId: 'timer555-1', pinId: 'gnd' }, end: { compId: 'gnd-1', pinId: 'main' } },

                    // 555 Control Voltage (pin 5) to Ground (via small cap, but for simplicity direct to ground or leave floating)
                    { start: { compId: 'timer555-1', pinId: 'control_voltage' }, end: { compId: 'gnd-1', pinId: 'main' } },

                    // 555 Output (pin 3) to LED Anode
                    { start: { compId: 'timer555-1', pinId: 'output' }, end: { compId: 'led-1', pinId: 'anode' } },

                    // LED Cathode to Ground
                    { start: { compId: 'led-1', pinId: 'cathode' }, end: { compId: 'gnd-1', pinId: 'main' } }
                ]
            },
            // Add more examples here following the same structure
        };


        // --- Device Detection ---
        function detectMobile() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            // Basic user agent check
            if (/android/i.test(userAgent) || /iPad|iPhone|iPod/.test(userAgent) || /windows phone/i.test(userAgent) || /BlackBerry/.test(userAgent) || /Opera Mini/.test(userAgent) || /IEMobile/i.test(userAgent)) {
                isMobileDevice = true;
            }
            // Check for touch events support
            if ('ontouchstart' in window || navigator.maxTouchPoints > 0 || navigator.msMaxTouchPoints > 0) {
                isMobileDevice = true;
            }
            console.log("Es dispositivo m√≥vil:", isMobileDevice);
        }

        // --- Screen Management Functions ---
        let currentActiveScreenId = 'startScreen'; // Keep track of the currently active screen

        function showScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });

            // Show the requested screen
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
                currentActiveScreenId = screenId; // Update active screen ID

                // Special handling for appContainer to initialize canvas
                if (screenId === 'appContainer') {
                    initializeCanvas();
                    checkAndLoadExample(); // Check for example to load from URL
                }
                // Special handling for calfluxSection to initialize calculator
                if (screenId === 'calfluxSection') {
                    renderCalculator('ohm'); // Default to Ohm's Law calculator
                }
            }
            // Close sidebars if open when switching screens
            closeSidebar();
            closePropertiesPanel();
        }

        // --- Canvas & Grid Functions ---
        function initializeCanvas() {
            circuitCanvas = document.getElementById('circuitCanvas');
            if (!circuitCanvas) {
                console.error("Canvas element not found!");
                return;
            }
            circuitCtx = circuitCanvas.getContext('2d');
            
            // Set canvas size to a large fixed size to enable scrolling of canvasArea
            circuitCanvas.width = CANVAS_WIDTH;
            circuitCanvas.height = CANVAS_HEIGHT;
            
            // Apply initial zoom
            applyZoom();

            // Draw grid initially
            drawGrid();
            // Redraw wires when canvas is initialized or resized
            drawWires();
        }

        function drawGrid() {
            if (!circuitCtx) return;
            // Clear the canvas before redrawing everything
            circuitCtx.clearRect(0, 0, circuitCanvas.width, circuitCanvas.height); 
            
            circuitCtx.strokeStyle = 'rgba(0, 212, 255, 0.1)';
            circuitCtx.lineWidth = 0.5 / currentZoom; // Adjust line width for zoom
            
            const gridSize = 20;
            
            // Save context state before scaling for grid
            circuitCtx.save();
            // Apply current zoom for drawing
            circuitCtx.scale(currentZoom, currentZoom); 

            for (let x = 0; x <= circuitCanvas.width; x += gridSize) {
                circuitCtx.beginPath();
                circuitCtx.moveTo(x, 0);
                circuitCtx.lineTo(x, circuitCanvas.height);
                circuitCtx.stroke();
            }
            
            for (let y = 0; y <= circuitCanvas.height; y += gridSize) {
                circuitCtx.beginPath();
                circuitCtx.moveTo(0, y);
                circuitCtx.lineTo(circuitCanvas.width, y);
                circuitCtx.stroke();
            }
            // Restore context state
            circuitCtx.restore();
        }

        function drawWires() {
            if (!circuitCtx) return;
            drawGrid(); // Redraw grid first to clear old wires
            
            circuitCtx.strokeStyle = '#FFFFFF'; // White wires
            circuitCtx.lineWidth = 2 / currentZoom; // Adjust line width for zoom
            
            // Save context state before scaling for wires
            circuitCtx.save();
            // Apply current zoom for drawing wires
            circuitCtx.scale(currentZoom, currentZoom); 

            connections.forEach(conn => {
                const startComp = document.querySelector(`.placed-component[data-id="${conn.startPin.componentId}"]`);
                const endComp = document.querySelector(`.placed-component[data-id="${conn.endPin.componentId}"]`);

                if (startComp && endComp) {
                    const startPinCoords = getPinCoordinates(startComp, conn.startPin.pinId);
                    const endPinCoords = getPinCoordinates(endComp, conn.endPin.pinId);

                    if (startPinCoords && endPinCoords) {
                        circuitCtx.beginPath();
                        circuitCtx.moveTo(startPinCoords.x, startPinCoords.y);
                        circuitCtx.lineTo(endPinCoords.x, endPinCoords.y);
                        circuitCtx.stroke();
                    }
                }
            });
            // Restore context state
            circuitCtx.restore();
        }

        function getPinCoordinates(componentElement, pinLogicalId) {
            // Get component's position relative to its parent (canvasArea)
            const compX = parseFloat(componentElement.style.left); 
            const compY = parseFloat(componentElement.style.top);

            const componentType = componentElement.getAttribute('data-component-type');
            const pinInfo = componentData[componentType].pins.find(p => p.id === pinLogicalId);

            if (!pinInfo) {
                console.error(`Pin with logical ID '${pinLogicalId}' not found for component type '${componentType}'.`);
                return null;
            }

            // Calculate pin's absolute position on the canvas
            // These coordinates are already in the "unzoomed" canvas space,
            // as component positions are not scaled by CSS transform.
            const x = compX + pinInfo.x;
            const y = compY + pinInfo.y;
            
            return { x: x, y: y };
        }


        // --- Tool Functions ---
        function selectTool(tool) {
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            const toolButton = document.querySelector(`[data-tool="${tool}"]`);
            if (toolButton) {
                toolButton.classList.add('active');
            }
            currentTool = tool;
            
            const canvasArea = document.getElementById('canvasArea');
            // Remove any selected start pin highlight and label
            if (startPin) {
                const prevSelectedPin = document.querySelector(`.placed-component[data-id="${startPin.componentId}"] .component-pin[data-pin-id="${startPin.pinId}"]`);
                if (prevSelectedPin) {
                    prevSelectedPin.classList.remove('selected-for-wire');
                    const label = prevSelectedPin.querySelector('.pin-label');
                    if (label) label.remove(); // Remove the label element
                }
            }
            startPin = null; // Reset wire tool state

            switch(tool) {
                case 'select':
                    canvasArea.style.cursor = 'default';
                    selectedComponentTypeForPlacement = null; // Deselect component type when tool changes
                    document.querySelectorAll('.component-item').forEach(item => item.classList.remove('selected'));
                    break;
                case 'wire':
                    canvasArea.style.cursor = 'crosshair';
                    selectedComponentTypeForPlacement = null; // Deselect component type when tool changes
                    document.querySelectorAll('.component-item').forEach(item => item.classList.remove('selected'));
                    break;
                case 'delete':
                    canvasArea.style.cursor = 'not-allowed';
                    selectedComponentTypeForPlacement = null; // Deselect component type when tool changes
                    document.querySelectorAll('.component-item').forEach(item => item.classList.remove('selected'));
                    break;
            }
        }

        // Global variables for drag functionality
        let isDragging = false;
        let draggedComponent = null;
        let dragOffsetX, dragOffsetY; // Offset from mouse/touch to component's top-left
        const gridSize = 20; // Define gridSize globally or pass it

        // Function to start dragging
        function startDrag(e) {
            // Only allow dragging with 'select' tool
            if (currentTool !== 'select') return;

            draggedComponent = this; // 'this' refers to the componentElement
            isDragging = true;

            // Prevent default touch behavior (scrolling, zooming)
            e.preventDefault();

            let clientX, clientY;
            if (e.type === 'touchstart') {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else { // mousedown
                clientX = e.clientX;
                clientY = e.clientY;
            }

            const rect = draggedComponent.getBoundingClientRect();
            // Calculate offset relative to the *unscaled* component size
            dragOffsetX = (clientX - rect.left) / currentZoom;
            dragOffsetY = (clientY - rect.top) / currentZoom;

            // Add global listeners for dragging
            document.addEventListener('mousemove', doDrag);
            document.addEventListener('mouseup', stopDrag);
            document.addEventListener('touchmove', doDrag, { passive: false }); // passive: false for preventDefault
            document.addEventListener('touchend', stopDrag);

            // Select the component when dragging starts
            selectPlacedComponent(draggedComponent);
        }

        // Function to handle dragging
        function doDrag(e) {
            if (!isDragging || !draggedComponent) return;

            e.preventDefault(); // Prevent default scrolling/selection during drag

            let clientX, clientY;
            if (e.type === 'touchmove') {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else { // mousemove
                clientX = e.clientX;
                clientY = e.clientY;
            }

            const canvasArea = document.getElementById('canvasArea');
            const canvasRect = canvasArea.getBoundingClientRect();

            // Calculate new position in *unscaled* canvas coordinates
            let newX = ((clientX - canvasRect.left) / currentZoom + canvasArea.scrollLeft) - dragOffsetX;
            let newY = ((clientY - canvasRect.top) / currentZoom + canvasArea.scrollTop) - dragOffsetY;

            // Snap to grid
            newX = Math.round(newX / gridSize) * gridSize;
            newY = Math.round(newY / gridSize) * gridSize;

            // Keep component within canvas boundaries (using fixed CANVAS_WIDTH/HEIGHT)
            newX = Math.max(0, Math.min(newX, CANVAS_WIDTH - draggedComponent.offsetWidth));
            newY = Math.max(0, Math.min(newY, CANVAS_HEIGHT - draggedComponent.offsetHeight));

            draggedComponent.style.left = `${newX}px`;
            draggedComponent.style.top = `${newY}px`;

            drawWires(); // Redraw wires as component moves
        }

        // Function to stop dragging
        function stopDrag() {
            isDragging = false;
            draggedComponent = null;

            // Remove global listeners
            document.removeEventListener('mousemove', doDrag);
            document.removeEventListener('mouseup', stopDrag);
            document.removeEventListener('touchmove', doDrag);
            document.removeEventListener('touchend', stopDrag);

            drawWires(); // Final redraw after drag ends
        }

        // --- Component Functions ---
        function selectComponent(type) {
            document.querySelectorAll('.component-item').forEach(item => item.classList.remove('selected'));
            document.querySelector(`[data-component="${type}"]`).classList.add('selected');
            selectedComponentTypeForPlacement = type; // Set for mobile click-to-place
            selectTool('select'); // Automatically switch to select tool after choosing a component
            // On mobile, close components sidebar after selecting a component
            if (window.innerWidth <= 768) {
                document.getElementById('componentsSidebar').classList.remove('open');
            }
        }
        
        function placeComponent(x, y, componentTypeToPlace, componentIdOverride = null, propertiesOverride = {}) { // Added propertiesOverride
            const type = componentTypeToPlace || selectedComponentTypeForPlacement; // Use provided type or global
            if (!type) {
                console.log("No component type selected to place.");
                return;
            }
            
            // Use override ID if provided, otherwise generate new
            const componentId = componentIdOverride || `comp-${++componentsCount}`;
            if (!componentIdOverride) { // Only increment if not an override
                componentsCount = Math.max(componentsCount, parseInt(componentId.replace('comp-', '')) || 0);
            }

            const componentElement = document.createElement('div');
            componentElement.classList.add('placed-component');
            componentElement.setAttribute('data-component-type', type); // Use 'type' here
            componentElement.setAttribute('data-id', componentId); // Unique ID for each component
            
            // Adjust coordinates for zoom before snapping to grid
            const adjustedX = x / currentZoom;
            const adjustedY = y / currentZoom;

            // Snap to grid (20px grid size)
            // Calculate top-left position to center the 50x50 component on the grid point
            const snappedX = Math.round(adjustedX / gridSize) * gridSize - (50 / 2);
            const snappedY = Math.round(adjustedY / gridSize) * gridSize - (50 / 2);

            componentElement.style.left = `${snappedX}px`;
            componentElement.style.top = `${snappedY}px`;
            
            // Icono del componente
            const icon = document.createElement('div');
            icon.classList.add('icon');
            icon.textContent = componentData[type].icon; // Use 'type' here
            componentElement.appendChild(icon);

            // Add pins to the component dynamically based on componentData
            const pinsContainer = document.createElement('div');
            pinsContainer.classList.add('component-pins');
            const componentPins = componentData[type].pins;

            componentPins.forEach(pinInfo => {
                const pin = document.createElement('div');
                pin.classList.add('component-pin');
                pin.setAttribute('data-pin-id', pinInfo.id); // Store logical pin ID
                pin.setAttribute('data-component-id', componentId); // Link pin to its component
                
                // Position pin relative to component (10x10px pin, 50x50px component)
                // pinInfo.x, pinInfo.y are center points of the pin on the 50x50 component
                // Subtract 5 to get the top-left corner of the 10x10px pin element
                pin.style.left = `${pinInfo.x - 5}px`;
                pin.style.top = `${pinInfo.y - 5}px`;

                // Add label for the pin (hidden by default, shown on hover/selection)
                const pinLabel = document.createElement('span');
                pinLabel.classList.add('pin-label');
                pinLabel.textContent = pinInfo.label;
                pin.appendChild(pinLabel);

                pin.addEventListener('click', handlePinClick); // Add click listener for wiring
                pinsContainer.appendChild(pin);
            });
            componentElement.appendChild(pinsContainer);
            
            // Store properties on the element itself for easy retrieval/modification
            componentElement.componentProperties = { ...componentData[type].properties, ...propertiesOverride }; // Merge default with override

            // Attach drag listeners
            componentElement.addEventListener('mousedown', startDrag);
            componentElement.addEventListener('touchstart', startDrag, { passive: false }); // passive: false for preventDefault
            
            // Existing click and dblclick listeners
            componentElement.addEventListener('click', (event) => {
                event.stopPropagation(); // Prevent canvas click event from firing
                if (currentTool === 'select' && !isDragging) { // Only select if not dragging
                    selectPlacedComponent(componentElement);
                } else if (currentTool === 'delete') {
                    deletePlacedComponent(componentElement);
                }
            });
            
            // Manejador de doble clic para las propiedades
            componentElement.addEventListener('dblclick', (event) => {
                event.stopPropagation();
                showPropertiesPanel(componentElement);
            });
            
            document.getElementById('canvasArea').appendChild(componentElement);
            
            selectPlacedComponent(componentElement);
            console.log(`Component '${type}' placed at (${snappedX}, ${snappedY}) with ID: ${componentId}`); // Debug log
        }
        
        function selectPlacedComponent(element) {
            document.querySelectorAll('.placed-component').forEach(comp => comp.classList.remove('selected'));
            element.classList.add('selected');
            selectedComponentElement = element; // Set the currently selected component for properties/AI
            showPropertiesPanel(element);
        }
        
        function deletePlacedComponent(element) {
            showModalConfirm('Eliminar Componente', '¬øEst√°s seguro de que quieres eliminar este componente?', () => {
                const componentIdToDelete = element.getAttribute('data-id');
                // Remove any connections involving this component
                connections = connections.filter(conn => 
                    conn.startPin.componentId !== componentIdToDelete && 
                    conn.endPin.componentId !== componentIdToDelete
                );
                element.remove();
                closePropertiesPanel();
                if (selectedComponentElement === element) { // Clear if the deleted one was selected
                    selectedComponentElement = null;
                }
                drawWires(); // Redraw wires after deletion
            });
        }
        
        function showPropertiesPanel(componentElement) {
            const panel = document.getElementById('propertiesPanel');
            const content = document.getElementById('propertiesContent');
            panel.style.display = 'block';
            panel.classList.add('open'); // For mobile slide-in

            const componentType = componentElement.getAttribute('data-component-type');
            // Use properties stored directly on the element, which includes overrides from examples
            const currentProperties = componentElement.componentProperties;
            
            if (!currentProperties) {
                content.innerHTML = '<p>No hay propiedades disponibles para este componente.</p>';
                return;
            }
            
            let html = `<h3>${componentData[componentType].name} (ID: ${componentElement.getAttribute('data-id')})</h3>`;
            html += '<div class="panel-properties">';
            
            for (const key in currentProperties) {
                html += `
                    <div class="property-group">
                        <label for="prop-${componentElement.getAttribute('data-id')}-${key}">${key.charAt(0).toUpperCase() + key.slice(1)}:</label>
                        <input type="text" id="prop-${componentElement.getAttribute('data-id')}-${key}" value="${currentProperties[key]}"
                               onchange="updateComponentProperty('${componentElement.getAttribute('data-id')}', '${key}', this.value)">
                    </div>
                `;
            }
            html += '</div>';
            
            content.innerHTML = html;
        }

        function updateComponentProperty(componentId, propertyKey, newValue) {
            const componentElement = document.querySelector(`.placed-component[data-id="${componentId}"]`);
            if (componentElement && componentElement.componentProperties) {
                componentElement.componentProperties[propertyKey] = newValue;
                console.log(`Updated component ${componentId} property ${propertyKey} to ${newValue}`);
                // In a real simulator, this would trigger a re-calculation of simulation values
                // For now, just update the display.
                // You might want to redraw component icons/labels if they reflect properties.
            }
        }

        // --- Wire Handling ---
        function handlePinClick(event) {
            event.stopPropagation(); // Prevent component click/drag
            if (currentTool !== 'wire') return;

            const clickedPin = event.target;
            const componentId = clickedPin.getAttribute('data-component-id');
            const pinLogicalId = clickedPin.getAttribute('data-pin-id'); // Use logical pin ID

            if (!startPin) {
                // First pin clicked, set as start
                const componentType = document.querySelector(`.placed-component[data-id="${componentId}"]`).getAttribute('data-component-type');
                const pinInfo = componentData[componentType].pins.find(p => p.id === pinLogicalId);

                startPin = { 
                    componentId: componentId, 
                    pinId: pinLogicalId, // Store logical pin ID
                    label: pinInfo ? pinInfo.label : pinLogicalId // Store label for display
                };
                clickedPin.classList.add('selected-for-wire'); // Highlight the selected start pin
                
                // Show pin label
                const pinLabelElement = clickedPin.querySelector('.pin-label');
                if (pinLabelElement) pinLabelElement.style.opacity = '1';

                console.log('Start pin selected:', startPin);
            } else {
                // Second pin clicked, complete the connection
                const endPin = { 
                    componentId: componentId, 
                    pinId: pinLogicalId, // Store logical pin ID
                };

                // Remove highlight from previous start pin and its label
                const prevSelectedPinElement = document.querySelector(`.placed-component[data-id="${startPin.componentId}"] .component-pin[data-pin-id="${startPin.pinId}"]`);
                if (prevSelectedPinElement) {
                    prevSelectedPinElement.classList.remove('selected-for-wire');
                    const label = prevSelectedPinElement.querySelector('.pin-label');
                    if (label) label.style.opacity = '0'; // Hide the label element
                }

                // Prevent connecting a pin to itself or to another pin on the same component
                if (startPin.componentId === endPin.componentId) {
                    showModal('Conexi√≥n Inv√°lida', 'No puedes conectar dos pines del mismo componente.');
                    startPin = null; // Reset
                    return;
                }
                if (startPin.componentId === endPin.componentId && startPin.pinId === endPin.pinId) {
                    showModal('Conexi√≥n Inv√°lida', 'No puedes conectar un pin a s√≠ mismo.');
                    startPin = null; // Reset
                    return;
                }


                // Check for duplicate connections (simple check, could be more robust)
                const isDuplicate = connections.some(conn => 
                    (conn.startPin.componentId === startPin.componentId && conn.startPin.pinId === startPin.pinId &&
                     conn.endPin.componentId === endPin.componentId && conn.endPin.pinId === endPin.pinId) ||
                    (conn.startPin.componentId === endPin.componentId && conn.startPin.pinId === endPin.pinId &&
                     conn.endPin.componentId === startPin.componentId && conn.endPin.pinId === startPin.pinId)
                );

                if (isDuplicate) {
                    showModal('Conexi√≥n Existente', 'Esta conexi√≥n ya existe.');
                    startPin = null; // Reset
                    return;
                }

                connections.push({ startPin: startPin, endPin: endPin });
                console.log('Connection established:', connections[connections.length - 1]);
                drawWires(); // Redraw all wires
                startPin = null; // Reset for next connection
            }
        }


        // --- Resistor Color Code Calculator Functions (Moved to CalFlux) ---
        function calculateResistance() {
            const band1Color = document.getElementById('band1').value;
            const band2Color = document.getElementById('band2').value;
            const multiplierColor = document.getElementById('multiplier').value;
            const toleranceColor = document.getElementById('tolerance').value;

            const digit1 = colorValues[band1Color];
            const digit2 = colorValues[band2Color];
            const multiplier = multiplierValues[multiplierColor];
            const tolerance = toleranceValues[toleranceColor];

            if (digit1 === undefined || digit2 === undefined || multiplier === undefined || tolerance === undefined) {
                document.getElementById('resistanceValue').textContent = 'Error';
                return;
            }

            let resistance = (digit1 * 10 + digit2) * multiplier;
            
            document.getElementById('resistanceValue').textContent = `${formatUnitValue(resistance, 'resistance')} ${tolerance}`;

            // Update display bands
            document.getElementById('displayBand1').style.backgroundColor = band1Color;
            document.getElementById('displayBand2').style.backgroundColor = band2Color;
            document.getElementById('displayMultiplier').style.backgroundColor = multiplierColor;
            document.getElementById('displayTolerance').style.backgroundColor = toleranceColor;
        }

        /**
         * Formats a numeric value into a human-readable string with engineering units (e.g., 1000 -> 1k, 0.001 -> 1m).
         * @param {number} value The numeric value.
         * @param {string} unit The base unit (e.g., 'V', 'A', 'Œ©', 'F', 'H').
         * @returns {string} The formatted string.
         */
        function formatUnitValue(value, unit) {
            if (isNaN(value)) return 'NaN';
            if (value === 0) return `0${unit}`;

            const absValue = Math.abs(value);
            const sign = value < 0 ? '-' : '';

            if (absValue >= 1e12) return `${sign}${(value / 1e12).toFixed(2)}T${unit}`;
            if (absValue >= 1e9) return `${sign}${(value / 1e9).toFixed(2)}G${unit}`;
            if (absValue >= 1e6) return `${sign}${(value / 1e6).toFixed(2)}M${unit}`;
            if (absValue >= 1e3) return `${sign}${(value / 1e3).toFixed(2)}k${unit}`;
            if (absValue >= 1) return `${sign}${value.toFixed(2)}${unit}`;
            if (absValue >= 1e-3) return `${sign}${(value / 1e-3).toFixed(2)}m${unit}`;
            if (absValue >= 1e-6) return `${sign}${(value / 1e-6).toFixed(2)}¬µ${unit}`;
            if (absValue >= 1e-9) return `${sign}${(value / 1e-9).toFixed(2)}n${unit}`;
            if (absValue >= 1e-12) return `${sign}${(value / 1e-12).toFixed(2)}p${unit}`;
            return `${value.toExponential(2)}${unit}`;
        }

        // --- Cal Flux Calculator Rendering ---
        function renderCalculator(type) {
            const area = document.getElementById('calfluxCalculatorArea');
            const navButtons = document.querySelectorAll('.calflux-nav-btn');
            navButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.calflux-nav-btn[data-calculator-type="${type}"]`).classList.add('active');

            let html = '';

            switch (type) {
                case 'ohm':
                    html = `
                        <div class="calculator-section">
                            <h3>Ley de Ohm (V = I * R)</h3>
                            <p>Calcula voltaje, corriente o resistencia usando la Ley de Ohm.</p>
                            <div class="formula">V = I * R</div>
                            <div class="calculator-input-group">
                                <label for="ohm_voltage">Voltaje (V):</label>
                                <input type="text" id="ohm_voltage" placeholder="Ej: 9V, 12V">
                            </div>
                            <div class="calculator-input-group">
                                <label for="ohm_current">Corriente (A):</label>
                                <input type="text" id="ohm_current" placeholder="Ej: 100mA, 0.5A">
                            </div>
                            <div class="calculator-input-group">
                                <label for="ohm_resistance">Resistencia (Œ©):</label>
                                <input type="text" id="ohm_resistance" placeholder="Ej: 220Œ©, 1k">
                            </div>
                            <div class="action-buttons">
                                <button onclick="calculateOhm()">Calcular</button>
                            </div>
                            <div class="calculator-results" id="ohmResults">
                                <p>Resultados:</p>
                            </div>
                        </div>
                    `;
                    break;
                case 'dividers':
                    html = `
                        <div class="calculator-section">
                            <h3>Divisor de Voltaje</h3>
                            <p>Calcula el voltaje de salida de un divisor de voltaje resistivo.</p>
                            <div class="formula">Vout = Vin * (R2 / (R1 + R2))</div>
                            <div class="calculator-input-group">
                                <label for="divider_vin">Voltaje de Entrada (Vin):</label>
                                <input type="text" id="divider_vin" placeholder="Ej: 5V">
                            </div>
                            <div class="calculator-input-group">
                                <label for="divider_r1">Resistencia R1 (Œ©):</label>
                                <input type="text" id="divider_r1" placeholder="Ej: 1k, 1000">
                            </div>
                            <div class="calculator-input-group">
                                <label for="divider_r2">Resistencia R2 (Œ©):</label>
                                <input type="text" id="divider_r2" placeholder="Ej: 2.2k, 2200">
                            </div>
                            <div class="action-buttons">
                                <button onclick="calculateVoltageDivider()">Calcular</button>
                            </div>
                            <div class="calculator-results" id="dividerResults">
                                <p>Resultados:</p>
                            </div>
                        </div>
                    `;
                    break;
                case 'rcrlFilter':
                    html = `
                        <div class="calculator-section">
                            <h3>Filtros RC/RL (Frecuencia de Corte)</h3>
                            <p>Calcula la frecuencia de corte (-3dB) para filtros RC o RL.</p>
                            <div class="formula">Fc = 1 / (2 * œÄ * R * C)  (para RC)</div>
                            <div class="formula">Fc = R / (2 * œÄ * L)  (para RL)</div>
                            <div class="calculator-input-group">
                                <label for="filter_type">Tipo de Filtro:</label>
                                <select id="filter_type" onchange="toggleFilterInputs()">
                                    <option value="rc">RC</option>
                                    <option value="rl">RL</option>
                                </select>
                            </div>
                            <div class="calculator-input-group" id="rcInputs">
                                <label for="filter_r">Resistencia (R):</label>
                                <input type="text" id="filter_r" placeholder="Ej: 1k, 100">
                                <label for="filter_c">Capacitancia (C):</label>
                                <input type="text" id="filter_c" placeholder="Ej: 100n, 0.1u">
                            </div>
                            <div class="calculator-input-group" id="rlInputs" style="display:none;">
                                <label for="filter_r_rl">Resistencia (R):</label>
                                <input type="text" id="filter_r_rl" placeholder="Ej: 100, 500">
                                <label for="filter_l">Inductancia (L):</label>
                                <input type="text" id="filter_l" placeholder="Ej: 10m, 0.001">
                            </div>
                            <div class="action-buttons">
                                <button onclick="calculateFilterFrequency()">Calcular</button>
                            </div>
                            <div class="calculator-results" id="filterResults">
                                <p>Resultados:</p>
                            </div>
                        </div>
                    `;
                    break;
                case 'lcResonance':
                    html = `
                        <div class="calculator-section">
                            <h3>Resonancia LC</h3>
                            <p>Calcula la frecuencia de resonancia de un circuito LC.</p>
                            <div class="formula">Fr = 1 / (2 * œÄ * ‚àö(L * C))</div>
                            <div class="calculator-input-group">
                                <label for="lc_l">Inductancia (L):</label>
                                <input type="text" id="lc_l" placeholder="Ej: 10m, 0.001">
                            </div>
                            <div class="calculator-input-group">
                                <label for="lc_c">Capacitancia (C):</label>
                                <input type="text" id="lc_c" placeholder="Ej: 100n, 0.1u">
                            </div>
                            <div class="action-buttons">
                                <button onclick="calculateLCResonance()">Calcular</button>
                            </div>
                            <div class="calculator-results" id="lcResults">
                                <p>Resultados:</p>
                            </div>
                        </div>
                    `;
                    break;
                case 'transformers':
                    html = `
                        <div class="calculator-section">
                            <h3>Transformadores (Relaci√≥n de Espiras)</h3>
                            <p>Calcula voltajes o corrientes en transformadores ideales.</p>
                            <div class="formula">Vp/Vs = Np/Ns = Is/Ip</div>
                            <div class="calculator-input-group">
                                <label for="transformer_vp">Voltaje Primario (Vp):</label>
                                <input type="text" id="transformer_vp" placeholder="Ej: 120V">
                            </div>
                            <div class="calculator-input-group">
                                <label for="transformer_np">Espira Primaria (Np):</label>
                                <input type="text" id="transformer_np" placeholder="Ej: 1000">
                            </div>
                            <div class="calculator-input-group">
                                <label for="transformer_vs">Voltaje Secundario (Vs):</label>
                                <input type="text" id="transformer_vs" placeholder="Ej: 12V">
                            </div>
                            <div class="calculator-input-group">
                                <label for="transformer_ns">Espira Secundaria (Ns):</label>
                                <input type="text" id="transformer_ns" placeholder="Ej: 100">
                            </div>
                            <div class="calculator-input-group">
                                <label for="transformer_ip">Corriente Primaria (Ip):</label>
                                <input type="text" id="transformer_ip" placeholder="Ej: 1A">
                            </div>
                            <div class="calculator-input-group">
                                <label for="transformer_is">Corriente Secundaria (Is):</label>
                                <input type="text" id="transformer_is" placeholder="Ej: 10A">
                            </div>
                            <div class="action-buttons">
                                <button onclick="calculateTransformer()">Calcular</button>
                            </div>
                            <div class="calculator-results" id="transformerResults">
                                <p>Resultados:</p>
                            </div>
                        </div>
                    `;
                    break;
                case 'resistorCode':
                    html = `
                        <div class="calculator-section">
                            <h3>C√≥digo de Colores de Resistencia</h3>
                            <p>Determina el valor de una resistencia a partir de sus bandas de color.</p>
                            <div class="resistor-bands-display">
                                <div class="resistor-band-color" id="displayBand1" style="background-color: black;"></div>
                                <div class="resistor-band-color" id="displayBand2" style="background-color: brown;"></div>
                                <div class="resistor-band-color" id="displayMultiplier" style="background-color: red;"></div>
                                <div class="resistor-band-color" id="displayTolerance" style="background-color: gold;"></div>
                            </div>
                            <div class="resistor-calculator">
                                <h4>Bandas de Resistencia</h4>
                                <div class="resistor-input-group">
                                    <label for="band1">Banda 1 (Primer D√≠gito):</label>
                                    <select id="band1" onchange="calculateResistance()">
                                        <option value="black" style="background-color: black; color: white;">Negro</option>
                                        <option value="brown" style="background-color: brown; color: white;">Marr√≥n</option>
                                        <option value="red" style="background-color: red; color: white;">Rojo</option>
                                        <option value="orange" style="background-color: orange; color: black;">Naranja</option>
                                        <option value="yellow" style="background-color: yellow; color: black;">Amarillo</option>
                                        <option value="green" style="background-color: green; color: white;">Verde</option>
                                        <option value="blue" style="background-color: blue; color: white;">Azul</option>
                                        <option value="violet" style="background-color: violet; color: white;">Violeta</option>
                                        <option value="gray" style="background-color: gray; color: white;">Gris</option>
                                        <option value="white" style="background-color: white; color: black;">Blanco</option>
                                    </select>
                                </div>
                                <div class="resistor-input-group">
                                    <label for="band2">Banda 2 (Segundo D√≠gito):</label>
                                    <select id="band2" onchange="calculateResistance()">
                                        <option value="black" style="background-color: black; color: white;">Negro</option>
                                        <option value="brown" selected style="background-color: brown; color: white;">Marr√≥n</option>
                                        <option value="red" style="background-color: red; color: white;">Rojo</option>
                                        <option value="orange" style="background-color: orange; color: black;">Naranja</option>
                                        <option value="yellow" style="background-color: yellow; color: black;">Amarillo</option>
                                        <option value="green" style="background-color: green; color: white;">Verde</option>
                                        <option value="blue" style="background-color: blue; color: white;">Azul</option>
                                        <option value="violet" style="background-color: violet; color: white;">Violeta</option>
                                        <option value="gray" style="background-color: gray; color: white;">Gris</option>
                                        <option value="white" style="background-color: white; color: black;">Blanco</option>
                                    </select>
                                </div>
                                <div class="resistor-input-group">
                                    <label for="multiplier">Banda Multiplicadora:</label>
                                    <select id="multiplier" onchange="calculateResistance()">
                                        <option value="black" style="background-color: black; color: white;">Negro (x1)</option>
                                        <option value="brown" style="background-color: brown; color: white;">Marr√≥n (x10)</option>
                                        <option value="red" selected style="background-color: red; color: white;">Rojo (x100)</option>
                                        <option value="orange" style="background-color: orange; color: black;">Naranja (x1k)</option>
                                        <option value="yellow" style="background-color: yellow; color: black;">Amarillo (x10k)</option>
                                        <option value="green" style="background-color: green; color: white;">Verde (x100k)</option>
                                        <option value="blue" style="background-color: blue; color: white;">Azul (x1M)</option>
                                        <option value="violet" style="background-color: violet; color: white;">Violeta (x10M)</option>
                                        <option value="gold" style="background-color: gold; color: black;">Oro (x0.1)</option>
                                        <option value="silver" style="background-color: silver; color: black;">Plata (x0.01)</option>
                                    </select>
                                </div>
                                <div class="resistor-input-group">
                                    <label for="tolerance">Banda de Tolerancia:</label>
                                    <select id="tolerance" onchange="calculateResistance()">
                                        <option value="brown" style="background-color: brown; color: white;">Marr√≥n (¬±1%)</option>
                                        <option value="red" style="background-color: red; color: white;">Rojo (¬±2%)</option>
                                        <option value="green" style="background-color: green; color: white;">Verde (¬±0.5%)</option>
                                        <option value="blue" style="background-color: blue; color: white;">Azul (¬±0.25%)</option>
                                        <option value="violet" style="background-color: violet; color: white;">Violeta (¬±0.1%)</option>
                                        <option value="gray" style="background-color: gray; color: white;">Gris (¬±0.05%)</option>
                                        <option value="gold" selected style="background-color: gold; color: black;">Oro (¬±5%)</option>
                                        <option value="silver" style="background-color: silver; color: black;">Plata (¬±10%)</option>
                                    </select>
                                </div>
                                <div class="resistor-result">
                                    <p>Resistencia: <span id="resistanceValue">0Œ© ¬±5%</span></p>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'componentGuide':
                    html = `
                        <div class="component-guide-section">
                            <h3>Gu√≠a Completa de Componentes Electr√≥nicos por Nivel Profesional</h3>
                            <p>Esta gu√≠a te proporciona una base s√≥lida para seleccionar componentes seg√∫n el nivel de complejidad de tus proyectos.</p>

                            <h4>1. Componentes Anal√≥gicos</h4>
                            <h5>Op-Amps (Amplificadores Operacionales)</h5>
                            <ul>
                                <li><strong>Nivel B√°sico:</strong> LM358 (Dual, rail-to-rail output, bajo costo), TL072 (JFET input, bajo ruido), uA741 (Cl√°sico para aprendizaje, obsoleto en dise√±os nuevos).</li>
                                <li><strong>Nivel Medio:</strong> LM324 (Quad, versi√≥n del LM358), TL084 (Quad JFET, para aplicaciones multi-canal), LF356 (JFET, mejor slew rate que TL072), LM833 (Dual, optimizado para audio).</li>
                                <li><strong>Nivel Profesional:</strong> OPA2134 (Audio profesional, FET input, 8MHz GBW, 20V/¬µs slew rate), AD8628 (Auto-zero, ultra-bajo offset, para instrumentaci√≥n, DC precision), OPA627 (Ultra-bajo ruido, alta velocidad, para preamplificadores, instrumentaci√≥n cr√≠tica), OPA827 (Ultra-bajo ruido (1nV/‚àöHz), alta precisi√≥n).</li>
                            </ul>

                            <h5>Reguladores de Voltaje Lineales (LDOs)</h5>
                            <ul>
                                <li><strong>Nivel B√°sico:</strong> LM78xx/LM79xx (Fijos, f√°ciles de usar, bajo costo), LM317/LM337 (Ajustables, vers√°tiles).</li>
                                <li><strong>Nivel Medio:</strong> AMS1117 (LDOs de bajo dropout, com√∫n en 3.3V/5V), LT1763 (Bajo ruido, ideal para RF/Audio).</li>
                                <li><strong>Nivel Profesional:</strong> TPS7A4700 (Ultra-bajo ruido, alta PSRR, para aplicaciones sensibles), ADP7118 (Alta corriente, bajo ruido, para FPGAs/DSPs).</li>
                            </ul>

                            <h5>Diodos y Rectificadores</h5>
                            <ul>
                                <li><strong>Nivel B√°sico:</strong> 1N400x (Rectificaci√≥n de prop√≥sito general), 1N4148 (Conmutaci√≥n de se√±al peque√±a).</li>
                                <li><strong>Nivel Medio:</strong> Diodos Schottky (Baja ca√≠da de tensi√≥n, alta velocidad, para fuentes conmutadas), Diodos Zener (Regulaci√≥n de voltaje de referencia).</li>
                                <li><strong>Nivel Profesional:</strong> Diodos de Recuperaci√≥n R√°pida/Ultra-R√°pida (Para aplicaciones de alta frecuencia), Diodos de Carburo de Silicio (SiC) (Alta temperatura, alta tensi√≥n, baja p√©rdida).</li>
                            </ul>

                            <h5>Transistores BJT y MOSFET</h5>
                            <ul>
                                <li><strong>Nivel B√°sico:</strong> 2N3904/2N3906 (BJT de se√±al peque√±a, prop√≥sito general), IRF540N (MOSFET de potencia, bajo costo).</li>
                                <li><strong>Nivel Medio:</strong> Transistores de Potencia (2N3055, TIP120), MOSFETs de Canal N/P (IRLZ44N, FQP17P06).</li>
                                <li><strong>Nivel Profesional:</strong> MOSFETs de Super-Uni√≥n (Baja Ron, para fuentes conmutadas de alta eficiencia), GaN FETs (Muy alta frecuencia, alta eficiencia, para convertidores resonantes).</li>
                            </ul>

                            <h4>2. Componentes Digitales</h4>
                            <h5>Microcontroladores (MCUs)</h5>
                            <ul>
                                <li><strong>Nivel B√°sico:</strong> ATmega328P (Arduino UNO, f√°cil de usar, gran comunidad), PIC16F84A (Cl√°sico para aprendizaje, simple).</li>
                                <li><strong>Nivel Medio:</strong> STM32F103 (ARM Cortex-M3, m√°s potente, perif√©ricos avanzados), ESP32/ESP8266 (Con Wi-Fi/Bluetooth, para IoT).</li>
                                <li><strong>Nivel Profesional:</strong> ARM Cortex-M4/M7 (DSP, FPU, alta velocidad, para control avanzado), Microcontroladores de 32 bits espec√≠ficos para aplicaciones (Automotriz, Industrial).</li>
                            </ul>

                            <h5>FPGAs y CPLDs</h5>
                            <ul>
                                <li><strong>Nivel B√°sico:</strong> CPLDs peque√±os (EPM240, XC9572XL, para l√≥gica glue, bajo pin-count).</li>
                                <li><strong>Nivel Medio:</strong> FPGAs de baja densidad (Xilinx Spartan-6, Altera Cyclone IV, para procesamiento de se√±ales, interfaces).</li>
                                <li><strong>Nivel Profesional:</strong> FPGAs de alta densidad (Xilinx Zynq, Altera Arria, con ARM cores, para sistemas complejos, procesamiento de video/RF).</li>
                            </ul>

                            <h5>Memorias (Flash, RAM, EEPROM)</h5>
                            <ul>
                                <li><strong>Nivel B√°sico:</strong> EEPROM I2C/SPI (24LC256, 25LC1024, para configuraci√≥n, datos peque√±os).</li>
                                <li><strong>Nivel Medio:</strong> Flash SPI (W25Q64FV, para firmware, datos grandes), SRAM paralela (Para buffers de datos r√°pidos).</li>
                                <li><strong>Nivel Profesional:</strong> DDR3/DDR4 SDRAM (Alta velocidad, gran capacidad, para sistemas embebidos de alto rendimiento), NVRAM (FRAM, MRAM, para datos cr√≠ticos no vol√°tiles).</li>
                            </ul>

                            <h4>3. Sensores y Actuadores</h4>
                            <h5>Sensores de Temperatura</h5>
                            <ul>
                                <li><strong>Nivel B√°sico:</strong> Termistor NTC (Cambio de resistencia con temperatura), LM35 (Salida de voltaje lineal).</li>
                                <li><strong>Nivel Medio:</strong> DS18B20 (Digital, 1-Wire, buena precisi√≥n), Termopares (Amplio rango de temperatura).</li>
                                <li><strong>Nivel Profesional:</strong> RTDs (PT100, PT1000, alta precisi√≥n, estabilidad), Sensores de temperatura de infrarrojos (Sin contacto).</li>
                            </ul>

                            <h5>Sensores de Luz</h5>
                            <ul>
                                <li><strong>Nivel B√°sico:</strong> Fotorresistor (LDR, resistencia var√≠a con la luz).</li>
                                <li><strong>Nivel Medio:</strong> Fotodiodo/Fototransistor (Respuesta m√°s r√°pida, lineal), Sensor de luz ambiental (BH1750, digital I2C).</li>
                                <li><strong>Nivel Profesional:</strong> Sensores de color (TCS34725, RGB), Sensores de imagen (CMOS/CCD).</li>
                            </ul>

                            <h5>Actuadores (Motores, Rel√©s)</h5>
                            <ul>
                                <li><strong>Nivel B√°sico:</strong> Motor DC con driver simple (L293D), Rel√© electromec√°nico.</li>
                                <li><strong>Nivel Medio:</strong> Motores paso a paso con drivers (A4988), Servomotores (SG90, MG996R).</li>
                                <li><strong>Nivel Profesional:</strong> Motores BLDC con control FOC (Field-Oriented Control), Rel√©s de estado s√≥lido (SSR) de alta potencia.</li>
                            </ul>

                            <h4>4. Consideraciones de Dise√±o</h4>
                            <h5>Fiabilidad (Reliability)</h5>
                            <ul>
                                <li>MTBF (Mean Time Between Failures)</li>
                                <li>Rango de temperatura de operaci√≥n</li>
                                <li>Tolerancia a la humedad</li>
                                <li>Resistencia a vibraciones/golpes</li>
                                <li>Protecci√≥n ESD</li>
                            </ul>

                            <h5>Optimizaci√≥n de Costos</h5>
                            <ul>
                                <li>Precios por volumen (descuentos por cantidad)</li>
                                <li>Ciclo de vida del producto (longevidad)</li>
                                <li>Segundas fuentes (m√∫ltiples proveedores)</li>
                                <li>Estandarizaci√≥n de encapsulados</li>
                            </ul>

                            <h5>EMC/EMI (Compatibilidad Electromagn√©tica / Interferencia Electromagn√©tica)</h5>
                            <ul>
                                <li>Frecuencias de conmutaci√≥n (evitar interferencias)</li>
                                <li>Requisitos de blindaje</li>
                                <li>Consideraciones de dise√±o de PCB</li>
                                <li>Requisitos de filtro</li>
                            </ul>

                            <h4>5. Tendencias Futuras</h4>
                            <h5>Tecnolog√≠as Emergentes</h5>
                            <ul>
                                <li><strong>Semiconductores de Banda Ancha (Wide Bandgap):</strong> Carburo de Silicio (SiC) - Alta temperatura, eficiencia; Nitruro de Galio (GaN) - Alta frecuencia, potencia.</li>
                                <li><strong>Encapsulados Avanzados:</strong> Integraci√≥n 3D (Through Silicon Vias - TSV), System in Package (SiP) - M√∫ltiples chips, Fan-out Wafer Level Packaging.</li>
                                <li><strong>Integraci√≥n IoT:</strong> Ultra-bajo consumo (compatibilidad con recolecci√≥n de energ√≠a), Seguridad (cifrado de hardware), Edge AI (procesadores de redes neuronales).</li>
                            </ul>
                        </div>
                    `;
                    break;
                default:
                    html = '<p>Selecciona una calculadora o gu√≠a del men√∫ de navegaci√≥n.</p>';
            }
            area.innerHTML = html;

            // Re-attach event listeners for dynamically loaded content
            if (type === 'ohm') {
                // No specific listeners needed for Ohm, as it's handled by onclick on the button
            } else if (type === 'dividers') {
                // No specific listeners needed for Dividers
            } else if (type === 'rcrlFilter') {
                toggleFilterInputs(); // Set initial state for filter inputs
            } else if (type === 'resistorCode') {
                calculateResistance(); // Calculate initial resistance when loaded
            }
        }

        function calculateOhm() {
            const V_input = document.getElementById('ohm_voltage').value;
            const I_input = document.getElementById('ohm_current').value;
            const R_input = document.getElementById('ohm_resistance').value;
            const resultsDiv = document.getElementById('ohmResults');

            let V = parseUnitValue(V_input);
            let I = parseUnitValue(I_input);
            let R = parseUnitValue(R_input);

            let resultHtml = '<p>Resultados:</p>';
            let calculated = false;

            if (!isNaN(V) && !isNaN(I) && isNaN(R)) { // Calculate R
                if (I === 0) {
                    resultHtml += '<p>Error: La corriente no puede ser cero para calcular la resistencia.</p>';
                } else {
                    R = V / I;
                    resultHtml += `<p>Resistencia (R): <span>${formatUnitValue(R, 'Œ©')}</span></p>`;
                    calculated = true;
                }
            } else if (!isNaN(V) && isNaN(I) && !isNaN(R)) { // Calculate I
                if (R === 0) {
                    resultHtml += '<p>Error: La resistencia no puede ser cero para calcular la corriente.</p>';
                } else {
                    I = V / R;
                    resultHtml += `<p>Corriente (I): <span>${formatUnitValue(I, 'A')}</span></p>`;
                    calculated = true;
                }
            } else if (isNaN(V) && !isNaN(I) && !isNaN(R)) { // Calculate V
                V = I * R;
                resultHtml += `<p>Voltaje (V): <span>${formatUnitValue(V, 'V')}</span></p>`;
                calculated = true;
            } else {
                resultHtml += '<p>Por favor, introduce exactamente dos valores para calcular el tercero.</p>';
            }

            if (calculated) {
                const P = V * I;
                if (!isNaN(P)) {
                    resultHtml += `<p>Potencia (P): <span>${formatUnitValue(P, 'W')}</span></p>`;
                }
            }
            resultsDiv.innerHTML = resultHtml;
        }

        function calculateVoltageDivider() {
            const Vin_input = document.getElementById('divider_vin').value;
            const R1_input = document.getElementById('divider_r1').value;
            const R2_input = document.getElementById('divider_r2').value;
            const resultsDiv = document.getElementById('dividerResults');

            const Vin = parseUnitValue(Vin_input);
            const R1 = parseUnitValue(R1_input);
            const R2 = parseUnitValue(R2_input);

            let resultHtml = '<p>Resultados:</p>';

            if (isNaN(Vin) || isNaN(R1) || isNaN(R2)) {
                resultHtml += '<p>Por favor, introduce valores num√©ricos v√°lidos para todos los campos.</p>';
            } else if ((R1 + R2) === 0) {
                resultHtml += '<p>Error: La suma de R1 y R2 no puede ser cero.</p>';
            } else {
                const Vout = Vin * (R2 / (R1 + R2));
                resultHtml += `<p>Voltaje de Salida (Vout): <span>${formatUnitValue(Vout, 'V')}</span></p>`;
            }
            resultsDiv.innerHTML = resultHtml;
        }

        function toggleFilterInputs() {
            const filterType = document.getElementById('filter_type').value;
            document.getElementById('rcInputs').style.display = (filterType === 'rc') ? 'block' : 'none';
            document.getElementById('rlInputs').style.display = (filterType === 'rl') ? 'block' : 'none';
        }

        function calculateFilterFrequency() {
            const filterType = document.getElementById('filter_type').value;
            const resultsDiv = document.getElementById('filterResults');
            let resultHtml = '<p>Resultados:</p>';
            let Fc;

            if (filterType === 'rc') {
                const R_input = document.getElementById('filter_r').value;
                const C_input = document.getElementById('filter_c').value;
                const R = parseUnitValue(R_input);
                const C = parseUnitValue(C_input);

                if (isNaN(R) || isNaN(C) || R <= 0 || C <= 0) {
                    resultHtml += '<p>Por favor, introduce valores positivos v√°lidos para R y C.</p>';
                } else {
                    Fc = 1 / (2 * Math.PI * R * C);
                    resultHtml += `<p>Frecuencia de Corte (Fc): <span>${formatUnitValue(Fc, 'Hz')}</span></p>`;
                }
            } else if (filterType === 'rl') {
                const R_input = document.getElementById('filter_r_rl').value;
                const L_input = document.getElementById('filter_l').value;
                const R = parseUnitValue(R_input);
                const L = parseUnitValue(L_input);

                if (isNaN(R) || isNaN(L) || R <= 0 || L <= 0) {
                    resultHtml += '<p>Por favor, introduce valores positivos v√°lidos para R y L.</p>';
                } else {
                    Fc = R / (2 * Math.PI * L);
                    resultHtml += `<p>Frecuencia de Corte (Fc): <span>${formatUnitValue(Fc, 'Hz')}</span></p>`;
                }
            }
            resultsDiv.innerHTML = resultHtml;
        }

        function calculateLCResonance() {
            const L_input = document.getElementById('lc_l').value;
            const C_input = document.getElementById('lc_c').value;
            const resultsDiv = document.getElementById('lcResults');

            const L = parseUnitValue(L_input);
            const C = parseUnitValue(C_input);

            let resultHtml = '<p>Resultados:</p>';

            if (isNaN(L) || isNaN(C) || L <= 0 || C <= 0) {
                resultHtml += '<p>Por favor, introduce valores positivos v√°lidos para L y C.</p>';
            } else {
                const Fr = 1 / (2 * Math.PI * Math.sqrt(L * C));
                resultHtml += `<p>Frecuencia de Resonancia (Fr): <span>${formatUnitValue(Fr, 'Hz')}</span></p>`;
            }
            resultsDiv.innerHTML = resultHtml;
        }

        function calculateTransformer() {
            const Vp_input = document.getElementById('transformer_vp').value;
            const Np_input = document.getElementById('transformer_np').value;
            const Vs_input = document.getElementById('transformer_vs').value;
            const Ns_input = document.getElementById('transformer_ns').value;
            const Ip_input = document.getElementById('transformer_ip').value;
            const Is_input = document.getElementById('transformer_is').value;
            const resultsDiv = document.getElementById('transformerResults');

            let Vp = parseUnitValue(Vp_input);
            let Np = parseUnitValue(Np_input);
            let Vs = parseUnitValue(Vs_input);
            let Ns = parseUnitValue(Ns_input);
            let Ip = parseUnitValue(Ip_input);
            let Is = parseUnitValue(Is_input);

            let resultHtml = '<p>Resultados:</p>';
            let calculated = false;

            // Vp/Vs = Np/Ns
            if (!isNaN(Vp) && !isNaN(Np) && !isNaN(Ns) && isNaN(Vs)) { // Calculate Vs
                Vs = Vp * (Ns / Np);
                resultHtml += `<p>Voltaje Secundario (Vs): <span>${formatUnitValue(Vs, 'V')}</span></p>`;
                calculated = true;
            } else if (!isNaN(Vp) && !isNaN(Vs) && !isNaN(Ns) && isNaN(Np)) { // Calculate Np
                Np = Ns * (Vp / Vs);
                resultHtml += `<p>Espira Primaria (Np): <span>${Np.toFixed(2)}</span></p>`;
                calculated = true;
            } else if (!isNaN(Vp) && !isNaN(Vs) && !isNaN(Np) && isNaN(Ns)) { // Calculate Ns
                Ns = Np * (Vs / Vp);
                resultHtml += `<p>Espira Secundaria (Ns): <span>${Ns.toFixed(2)}</span></p>`;
                calculated = true;
            } else if (!isNaN(Np) && !isNaN(Ns) && !isNaN(Vs) && isNaN(Vp)) { // Calculate Vp
                Vp = Vs * (Np / Ns);
                resultHtml += `<p>Voltaje Primario (Vp): <span>${formatUnitValue(Vp, 'V')}</span></p>`;
                calculated = true;
            }

            // Np/Ns = Is/Ip
            if (!isNaN(Np) && !isNaN(Ns) && !isNaN(Is) && isNaN(Ip)) { // Calculate Ip
                Ip = Is * (Ns / Np);
                resultHtml += `<p>Corriente Primaria (Ip): <span>${formatUnitValue(Ip, 'A')}</span></p>`;
                calculated = true;
            } else if (!isNaN(Np) && !isNaN(Ns) && !isNaN(Ip) && isNaN(Is)) { // Calculate Is
                Is = Ip * (Np / Ns);
                resultHtml += `<p>Corriente Secundario (Is): <span>${formatUnitValue(Is, 'A')}</span></p>`;
                calculated = true;
            } else if (!isNaN(Ip) && !isNaN(Is) && !isNaN(Ns) && isNaN(Np)) { // Calculate Np
                Np = Ns * (Is / Ip);
                resultHtml += `<p>Espira Primaria (Np): <span>${Np.toFixed(2)}</span></p>`;
                calculated = true;
            } else if (!isNaN(Ip) && !isNaN(Is) && !isNaN(Np) && isNaN(Ns)) { // Calculate Ns
                Ns = Np * (Ip / Is);
                resultHtml += `<p>Espira Secundaria (Ns): <span>${Ns.toFixed(2)}</span></p>`;
                calculated = true;
            }

            if (!calculated) {
                resultHtml += '<p>Por favor, introduce al menos tres valores relacionados para realizar el c√°lculo.</p>';
            }
            resultsDiv.innerHTML = resultHtml;
        }

        // --- Example Loading Functions ---

        /**
         * Opens a specific example in the simulator.
         * Constructs a URL with parameters and redirects.
         * @param {string} exampleId The ID of the example to load.
         */
        function openExampleInSimulator(exampleId) {
            // Construct the URL with the example parameter
            const baseUrl = window.location.origin + window.location.pathname;
            const url = `${baseUrl}?example=${exampleId}`;
            window.location.href = url; // Redirect to the simulator with the example parameter
        }

        /**
         * Checks the URL for an 'example' parameter and loads the corresponding circuit.
         * Called when appContainer is activated.
         */
        function checkAndLoadExample() {
            const urlParams = new URLSearchParams(window.location.search);
            const exampleId = urlParams.get('example');

            if (exampleId && exampleCircuits[exampleId]) {
                // Clear existing circuit before loading example
                _createNewCircuit(); // This will also initialize the canvas

                const exampleData = exampleCircuits[exampleId];
                console.log(`Loading example: ${exampleData.name}`);

                // Load components
                exampleData.components.forEach(comp => {
                    // Convert string positions to numbers for placeComponent
                    const x = parseFloat(comp.x.replace('px', ''));
                    const y = parseFloat(comp.y.replace('px', ''));
                    placeComponent(x, y, comp.type, comp.id, comp.properties); // Pass properties to placeComponent
                });

                // Load connections
                // Need to ensure components are rendered before drawing connections
                setTimeout(() => {
                    connections = []; // Clear any residual connections
                    exampleData.connections.forEach(conn => {
                        connections.push({
                            startPin: { componentId: conn.start.compId, pinId: conn.start.pinId },
                            endPin: { componentId: conn.end.compId, pinId: conn.end.pinId }
                        });
                    });
                    drawWires(); // Redraw all wires after connections are set
                    showModal('Ejemplo Cargado', `El ejemplo "${exampleData.name}" ha sido cargado en el simulador.`);
                }, 100); // Small delay to ensure components are in DOM
            }
            // Clear the URL parameter after loading to prevent re-loading on refresh
            const newUrl = window.location.origin + window.location.pathname;
            window.history.replaceState({}, document.title, newUrl);
        }


        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', function() {
            detectMobile(); // Detect mobile device on load

            // Initial screen display
            showScreen('startScreen');

            // Canvas click listener for placing components (mobile)
            document.getElementById('canvasArea').addEventListener('click', (event) => {
                if (selectedComponentTypeForPlacement && currentTool === 'select') {
                    const canvasRect = circuitCanvas.getBoundingClientRect();
                    // Calculate click position relative to canvas content, considering scroll and zoom
                    const clickX = (event.clientX - canvasRect.left) + document.getElementById('canvasArea').scrollLeft;
                    const clickY = (event.clientY - canvasRect.top) + document.getElementById('canvasArea').scrollTop;
                    placeComponent(clickX, clickY, selectedComponentTypeForPlacement);
                    // After placing, deselect the component type to prevent accidental multiple placements
                    document.querySelectorAll('.component-item').forEach(item => item.classList.remove('selected'));
                    selectedComponentTypeForPlacement = null;
                }
            });

            // Component Selection in Sidebar
            document.querySelectorAll('.component-item').forEach(item => {
                item.addEventListener('click', function() {
                    selectComponent(this.dataset.component);
                });
            });

            // Tool Selection in Toolbar
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    selectTool(this.dataset.tool);
                });
            });

            // Search functionality
            document.getElementById('componentSearch').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('.component-item').forEach(item => {
                    const name = item.querySelector('.component-name').textContent.toLowerCase();
                    if (name.includes(searchTerm)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });

            // Cal Flux Navigation
            document.querySelectorAll('.calflux-nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    renderCalculator(this.dataset.calculatorType);
                });
            });

            // Show scroll arrows on mobile
            if (isMobileDevice) {
                document.getElementById('scrollArrows').style.display = 'flex';
            }
        });
    </script>
</body>
</html>

