<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Visual de Código (Canva-like)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #282c34;
            color: #f0f0f0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow: hidden; /* Prevent body scroll */
        }

        #root {
            display: flex;
            flex-grow: 1;
            width: 100%;
        }

        .sidebar {
            width: 250px;
            background-color: #3a3f4a;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .sidebar h2 {
            color: #61dafb;
            margin-top: 0;
            margin-bottom: 20px;
            text-align: center;
        }

        .element-palette {
            margin-bottom: 30px;
        }

        .element-palette h3 {
            color: #f0f0f0;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.1em;
            border-bottom: 1px solid #555;
            padding-bottom: 5px;
        }

        .draggable-item {
            background-color: #555;
            color: #f0f0f0;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            cursor: grab;
            transition: background-color 0.2s ease;
            text-align: center;
        }

        .draggable-item:hover {
            background-color: #777;
        }

        .draggable-item:active {
            cursor: grabbing;
        }

        .editor-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            background-color: #3a3f4a;
            padding: 10px 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toolbar h1 {
            color: #f0f0f0;
            margin: 0;
            font-size: 1.5em;
        }

        .toolbar button {
            background-color: #61dafb;
            color: #282c34;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }

        .toolbar button:hover {
            background-color: #4ac1e3;
        }

        .canvas-container {
            flex-grow: 1;
            background-color: #31353c; /* Canvas background */
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto; /* Allow scrolling if content overflows */
            position: relative;
        }

        .canvas {
            min-width: 800px; /* Base size for design */
            min-height: 600px;
            background-color: #fff; /* White canvas background */
            border: 1px dashed #555;
            position: relative; /* Essential for positioning draggable elements */
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            overflow: hidden; /* Keep content within canvas bounds */
        }

        .resizable-draggable {
            position: absolute;
            border: 1px solid #61dafb;
            resize: both; /* Allow resizing */
            overflow: hidden;
            background-color: rgba(255, 255, 255, 0.9); /* Default for elements */
            padding: 5px;
            box-sizing: border-box; /* Padding doesn't affect total size */
            cursor: grab;
        }

        .resizable-draggable.selected {
            border: 2px solid #ff0077; /* Highlight selected element */
            outline: 2px dashed rgba(255, 0, 119, 0.5);
        }

        .resizable-draggable h1, .resizable-draggable p, .resizable-draggable img {
            margin: 0;
            padding: 0;
            pointer-events: none; /* Allow drag to pass through content */
            color: #333; /* Default text color */
        }

        .resizable-draggable img {
            max-width: 100%;
            max-height: 100%;
            display: block;
            object-fit: contain;
        }

        .properties-panel {
            width: 250px;
            background-color: #3a3f4a;
            padding: 20px;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.3);
        }

        .properties-panel h3 {
            color: #f0f0f0;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.1em;
            border-bottom: 1px solid #555;
            padding-bottom: 5px;
            text-align: center;
        }

        .properties-panel label {
            display: block;
            margin-bottom: 8px;
            color: #f0f0f0;
            font-size: 0.9em;
        }

        .properties-panel input[type="text"],
        .properties-panel input[type="color"],
        .properties-panel textarea {
            width: calc(100% - 20px);
            padding: 8px;
            margin-bottom: 15px;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #444;
            color: #f0f0f0;
            font-size: 0.9em;
        }

        .properties-panel input[type="color"] {
            width: 100%;
            height: 35px;
            padding: 0;
        }

        .properties-panel button {
            width: 100%;
            margin-top: 10px;
        }

        .export-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .export-modal-content {
            background-color: #3a3f4a;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 600px;
            width: 90%;
            color: #f0f0f0;
        }

        .export-modal-content h3 {
            margin-top: 0;
            color: #61dafb;
        }

        .export-modal-content textarea {
            width: calc(100% - 20px);
            height: 250px;
            background-color: #222;
            color: #eee;
            border: 1px solid #555;
            border-radius: 5px;
            padding: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            margin-bottom: 20px;
        }

        .export-modal-content .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // Utility to download files
        const downloadFile = (filename, content, type) => {
            const blob = new Blob([content], { type: type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        // Unique ID generator
        const generateId = () => `el-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;

        // --- Draggable Element Component ---
        function DraggableElement({ element, onSelect, onUpdate, children }) {
            const elementRef = useRef(null);
            const [isDragging, setIsDragging] = useState(false);
            const [initialPos, setInitialPos] = useState({ x: 0, y: 0 });
            const [initialMousePos, setInitialMousePos] = useState({ x: 0, y: 0 });

            useEffect(() => {
                const handleMouseMove = (e) => {
                    if (isDragging) {
                        const dx = e.clientX - initialMousePos.x;
                        const dy = e.clientY - initialMousePos.y;
                        onUpdate(element.id, {
                            style: {
                                left: initialPos.x + dx,
                                top: initialPos.y + dy,
                            },
                        });
                    }
                };

                const handleMouseUp = () => {
                    setIsDragging(false);
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                };

                if (isDragging) {
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                }

                return () => {
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                };
            }, [isDragging, initialPos, initialMousePos, onUpdate, element.id]);

            const handleMouseDown = (e) => {
                if (elementRef.current && e.target === elementRef.current) { // Only drag if clicking the element itself, not its children
                    setIsDragging(true);
                    onSelect(element.id);
                    setInitialPos({ x: element.style.left || 0, y: element.style.top || 0 });
                    setInitialMousePos({ x: e.clientX, y: e.clientY });
                }
            };

            const handleResize = (e) => {
                // Resize handling is done by CSS `resize: both` and native browser behavior
                // We just need to capture the final dimensions on mouseup/blur or periodically
                // For simplicity, we'll let CSS handle it visually. Real implementation would update element.style.width/height
            };

            const handleClick = (e) => {
                e.stopPropagation(); // Prevent canvas click from deselecting
                onSelect(element.id);
            };

            return (
                <div
                    ref={elementRef}
                    className={`resizable-draggable ${element.isSelected ? 'selected' : ''}`}
                    style={{
                        left: element.style.left,
                        top: element.style.top,
                        width: element.style.width,
                        height: element.style.height,
                        backgroundColor: element.style.backgroundColor,
                        zIndex: element.style.zIndex || 1,
                        cursor: isDragging ? 'grabbing' : 'grab',
                    }}
                    onMouseDown={handleMouseDown}
                    onClick={handleClick}
                    onMouseUp={handleResize} // Simulate capture of resize
                >
                    {children}
                </div>
            );
        }


        // --- Main App Component ---
        function App() {
            const [elements, setElements] = useState([]); // Stores all elements on canvas
            const [selectedElementId, setSelectedElementId] = useState(null);
            const [showExportModal, setShowExportModal] = useState(false);
            const canvasRef = useRef(null); // Reference to the canvas div

            const selectedElement = elements.find(el => el.id === selectedElementId);

            // --- Drag & Drop for new elements from palette ---
            const handleDragStart = (e, type) => {
                e.dataTransfer.setData('elementType', type);
            };

            const handleDrop = (e) => {
                e.preventDefault();
                const elementType = e.dataTransfer.getData('elementType');
                const canvasRect = canvasRef.current.getBoundingClientRect();

                const newElement = {
                    id: generateId(),
                    type: elementType,
                    style: {
                        left: e.clientX - canvasRect.left - 50, // Center new element roughly
                        top: e.clientY - canvasRect.top - 25,
                        width: elementType === 'image' ? 150 : 100,
                        height: elementType === 'image' ? 100 : 50,
                        backgroundColor: elementType === 'div' ? '#e0e0e0' : 'transparent',
                        color: '#333', // Default text color
                    },
                    content: elementType === 'text' ? 'Nuevo Texto' : '',
                    src: elementType === 'image' ? 'https://picsum.photos/150/100' : '', // Default image
                    isSelected: true,
                };

                setElements(prev => {
                    const newElements = prev.map(el => ({ ...el, isSelected: false })); // Deselect others
                    return [...newElements, newElement];
                });
                setSelectedElementId(newElement.id);
            };

            const handleDragOver = (e) => {
                e.preventDefault(); // Allows drop
            };

            // --- Element selection on canvas ---
            const handleSelectElement = (id) => {
                setElements(prev =>
                    prev.map(el => ({
                        ...el,
                        isSelected: el.id === id,
                    }))
                );
                setSelectedElementId(id);
            };

            const handleCanvasClick = () => {
                setSelectedElementId(null);
                setElements(prev => prev.map(el => ({ ...el, isSelected: false })));
            };

            // --- Update selected element's properties ---
            const handleUpdateElement = (id, updates) => {
                setElements(prev =>
                    prev.map(el =>
                        el.id === id
                            ? {
                                ...el,
                                ...updates,
                                style: { ...el.style, ...updates.style }, // Merge styles
                            }
                            : el
                    )
                );
            };

            // --- Properties Panel Change Handlers ---
            const handleStyleChange = (prop, value) => {
                if (selectedElement) {
                    handleUpdateElement(selectedElement.id, {
                        style: { [prop]: value },
                    });
                }
            };

            const handleContentChange = (value) => {
                if (selectedElement && selectedElement.type === 'text') {
                    handleUpdateElement(selectedElement.id, { content: value });
                }
            };

            const handleImageSrcChange = (value) => {
                if (selectedElement && selectedElement.type === 'image') {
                    handleUpdateElement(selectedElement.id, { src: value });
                }
            };

            // --- Export HTML/CSS ---
            const generateHtmlCss = () => {
                let html = '<!DOCTYPE html>\n<html lang="es">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>Mi Diseño Exportado</title>\n';
                html += '    <style>\n        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }\n        .canvas-exported { position: relative; width: 800px; min-height: 600px; background-color: #fff; overflow: hidden; }\n';

                let cssRules = '';
                const bodyContent = [];

                elements.forEach(el => {
                    const uniqueClass = `el-${el.id}`; // Generate unique class for each element
                    cssRules += `\n        .${uniqueClass} {\n`;
                    for (const prop in el.style) {
                        // Convert camelCase to kebab-case for CSS properties
                        const cssProp = prop.replace(/([A-Z])/g, '-$1').toLowerCase();
                        cssRules += `            ${cssProp}: ${typeof el.style[prop] === 'number' ? `${el.style[prop]}px` : el.style[prop]};\n`;
                    }
                    cssRules += '            position: absolute;\n'; // All elements are absolutely positioned
                    cssRules += '            box-sizing: border-box;\n'; // Ensure padding calculation is consistent
                    cssRules += `            z-index: ${el.style.zIndex || 1};\n`; // Ensure zIndex is applied
                    cssRules += '        }\n';

                    let innerContent = '';
                    if (el.type === 'text') {
                        innerContent = el.content;
                    } else if (el.type === 'image') {
                        innerContent = `<img src="${el.src}" alt="Diseño de Imagen" style="max-width: 100%; max-height: 100%; display: block; object-fit: contain;">`;
                    }

                    // Append inner content as direct children or wrapped in a paragraph/div for text
                    const tag = el.type === 'text' ? 'p' : 'div';
                    bodyContent.push(`<${tag} class="${uniqueClass}">${innerContent}</${tag}>`);
                });

                html += cssRules;
                html += '    </style>\n</head>\n<body>\n    <div class="canvas-exported">\n';
                html += bodyContent.join('\n');
                html += '\n    </div>\n</body>\n</html>';

                return html;
            };

            const handleExportCode = () => {
                setShowExportModal(true);
            };

            const handleDownloadHtml = () => {
                const htmlCode = generateHtmlCss();
                downloadFile('index.html', htmlCode, 'text/html');
                setShowExportModal(false);
            };

            return (
                <>
                    <div className="sidebar">
                        <h2>Elementos</h2>
                        <div className="element-palette">
                            <h3>Arrastra y Suelta</h3>
                            <div className="draggable-item" draggable="true" onDragStart={(e) => handleDragStart(e, 'div')}>
                                Div (Contenedor)
                            </div>
                            <div className="draggable-item" draggable="true" onDragStart={(e) => handleDragStart(e, 'text')}>
                                Texto
                            </div>
                            <div className="draggable-item" draggable="true" onDragStart={(e) => handleDragStart(e, 'image')}>
                                Imagen
                            </div>
                        </div>
                    </div>

                    <div className="editor-area">
                        <div className="toolbar">
                            <h1>Editor de Diseño Visual</h1>
                            <button onClick={handleExportCode}>Exportar Código HTML</button>
                        </div>
                        <div
                            className="canvas-container"
                            onDrop={handleDrop}
                            onDragOver={handleDragOver}
                            onClick={handleCanvasClick}
                        >
                            <div ref={canvasRef} className="canvas">
                                {elements.map(el => (
                                    <DraggableElement
                                        key={el.id}
                                        element={el}
                                        onSelect={handleSelectElement}
                                        onUpdate={handleUpdateElement}
                                    >
                                        {el.type === 'text' && <p style={{ color: el.style.color }}>{el.content}</p>}
                                        {el.type === 'image' && <img src={el.src} alt="Diseño de Imagen" />}
                                    </DraggableElement>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="properties-panel">
                        <h2>Propiedades</h2>
                        {selectedElement ? (
                            <div>
                                <h3>Elemento: {selectedElement.type.charAt(0).toUpperCase() + selectedElement.type.slice(1)}</h3>
                                {selectedElement.type === 'div' && (
                                    <>
                                        <label>Fondo:</label>
                                        <input
                                            type="color"
                                            value={selectedElement.style.backgroundColor || '#ffffff'}
                                            onChange={(e) => handleStyleChange('backgroundColor', e.target.value)}
                                        />
                                    </>
                                )}
                                {selectedElement.type === 'text' && (
                                    <>
                                        <label>Texto:</label>
                                        <textarea
                                            value={selectedElement.content}
                                            onChange={(e) => handleContentChange(e.target.value)}
                                        ></textarea>
                                        <label>Color de Texto:</label>
                                        <input
                                            type="color"
                                            value={selectedElement.style.color || '#333333'}
                                            onChange={(e) => handleStyleChange('color', e.target.value)}
                                        />
                                    </>
                                )}
                                {selectedElement.type === 'image' && (
                                    <>
                                        <label>URL de Imagen:</label>
                                        <input
                                            type="text"
                                            value={selectedElement.src}
                                            onChange={(e) => handleImageSrcChange(e.target.value)}
                                        />
                                    </>
                                )}
                                <label>Ancho (px):</label>
                                <input
                                    type="text"
                                    value={selectedElement.style.width || ''}
                                    onChange={(e) => handleStyleChange('width', parseInt(e.target.value) || e.target.value)}
                                />
                                <label>Alto (px):</label>
                                <input
                                    type="text"
                                    value={selectedElement.style.height || ''}
                                    onChange={(e) => handleStyleChange('height', parseInt(e.target.value) || e.target.value)}
                                />
                                {/* Add more properties here (padding, margin, border, font-size, etc.) */}
                            </div>
                        ) : (
                            <p>Selecciona un elemento para editar sus propiedades.</p>
                        )}
                    </div>

                    {showExportModal && (
                        <div className="export-modal-overlay">
                            <div className="export-modal-content">
                                <h3>Código HTML y CSS Generado</h3>
                                <textarea
                                    readOnly
                                    value={generateHtmlCss()}
                                ></textarea>
                                <div className="button-group">
                                    <button onClick={handleDownloadHtml}>Descargar HTML</button>
                                    <button className="secondary" onClick={() => setShowExportModal(false)}>Cerrar</button>
                                </div>
                            </div>
                        </div>
                    )}
                </>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
